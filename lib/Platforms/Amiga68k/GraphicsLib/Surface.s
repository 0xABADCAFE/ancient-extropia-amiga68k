
; Storm C Compiler
; extropialib:lib/Platforms/Amiga68k/GraphicsLib/Surface.cpp
	mc68030
	mc68881
	XREF	_0dt__DRAWLIST__T
	XREF	Delete__xTEXFONT__T
	XREF	_0ct__xTEXSURF__T
	XREF	Delete__xTEXSURF__T
	XREF	ReadBody__xTEXSURF__TR05XSFIO
	XREF	WriteBody__xTEXSURF__TR05XSFIO
	XREF	ReadyForRead__xTEXSURF__T
	XREF	ReadyForWrite__xTEXSURF__T
	XREF	_0ct__XSFOBJ__T
	XREF	Set__XSFHEAD__TPCcUcUcUcUc
	XREF	op__equal__XSFHEAD__TR05XSFIO
	XREF	op__equal__XSFHEAD__TR07XSFHEAD
	XREF	op__notEqual__XSFHEAD__TR07XSFHEAD
	XREF	Value__XDATAID__TPCc
	XREF	Refresh__xDBSCREEN__T
	XREF	Close__xDBSCREEN__T
	XREF	Open__xDBSCREEN__T
	XREF	Close__xSCREEN__T
	XREF	Open__xSCREEN__T
	XREF	Set__xSCREEN__TP06xDMODEPCc
	XREF	Close__xDBWIN__T
	XREF	Open__xDBWIN__T
	XREF	Set__xDBWIN__TsssssPCc
	XREF	MoveEvent__xDISPLAYIO__T
	XREF	ResizeEvent__xDISPLAYIO__T
	XREF	Idle__xDISPLAYIO__T
	XREF	HandleEvent__xDISPLAYIO__T
	XREF	ApplyInputModification__xDISPLAYIO__T
	XREF	ViewSurface__xDISPLAY__T
	XREF	DrawSurface__xDISPLAY__T
	XREF	Refresh__xDISPLAY__T
	XREF	Close__xDISPLAY__T
	XREF	Open__xDISPLAY__T
	XREF	_0dt__LOCK__T
	XREF	_0dt__THREAD__T
	XREF	Run__THREAD__T
	XREF	_0dt__DELAY__T
	XREF	_0ct__DELAY__T
	XREF	Pause__DELAY__TUj
	XREF	Pause__DELAY__TUjUj
	XREF	Abort__DELAY__T
	XREF	UnLink__xCHAINABLE__T
	XREF	Close__xFILEIO__T
	XREF	Flush__xFILEIO__T
	XREF	Write64Swap__xFILEIO__TPvUi
	XREF	Write32Swap__xFILEIO__TPvUi
	XREF	Write16Swap__xFILEIO__TPvUi
	XREF	Write__xFILEIO__TPvUiUi
	XREF	Read64Swap__xFILEIO__TPvUi
	XREF	Read32Swap__xFILEIO__TPvUi
	XREF	Read16Swap__xFILEIO__TPvUi
	XREF	Read__xFILEIO__TPvUiUi
	XREF	Tell__xFILEIO__T
	XREF	Seek__xFILEIO__Tjj
	XREF	Open__xFILEIO__TPCcjj
	XREF	SendPacket__xFILEIO__TPv
	XREF	WaitPacket__xFILEIO__T
	XREF	InputQueued__xINPUT__T
	XREF	Idle__xINPUT__T
	XREF	ExitEvent__xINPUT__T
	XREF	MouseEvent__xINPUT__Tjjj
	XREF	ApplyInputModification__xINPUT__T
	XREF	_0dt__xKEY__T
	XREF	_0ct__xKEY__T
	XREF	KeyEvent__xKEY__Tjsj
	XREF	_0dt__POOL_ST__T
	XREF	_0ct__POOL_ST__TUsUj
	XREF	FreeT__POOL_ST__TPv
	XREF	NewT__POOL_ST__TPvUs
	XREF	NewT__POOL_ST__TPv
	XREF	Create__POOL_ST__TUsUj
	XREF	Delete__POOL_ST__Tss
	XREF	_0dt__POOL_LT__T
	XREF	DrawSurface__x3D__P08xSURFACE
	XREF	v3DrawLineStrip__x3D__jj
	XREF	v3DrawLines__x3D__jj
	XREF	_W3D_DrawArray
	XREF	_W3D_BindTexture
	XREF	_system
	XREF	_std__in
	XREF	_std__out
	XREF	_std__err
	XREF	_st
	XREF	_gxSt
	XREF	_numStartArgs__xBASELIB
	XREF	_startArgs__xBASELIB
	XREF	_SysBase
	XREF	_IntuitionBase
	XREF	_TimerBase
	XREF	_DOSBase
	XREF	_PowerPCBase
	XREF	_sysData__sysBASELIB
	XREF	_msgbuff__sysBASELIB
	XREF	_main__sysBASELIB
	XREF	_allocated__MEM
	XREF	_totSize__MEM
	XREF	_nextFree__MEM
	XREF	_cnt__MEM
	XREF	_maxAllocs__MEM
	XREF	_fpuPrecision__CPU
	XREF	_cpuNames__CPU
	XREF	_GfxBase
	XREF	_CyberGfxBase
	XREF	_surfaceTypes__x2D
	XREF	_Warp3DBase
	XREF	_hw3D__sys3DDEVICE
	XREF	_context__sys3DDEVICE
	XREF	_drawRegion__x3D
	XREF	_fogData__x3D
	XREF	_flags__x3D
	XREF	_vertices__x3D
	XREF	_currTex__x3D
	XREF	_drawSurface__x3D
	XREF	_currCol__x3D
	XREF	_useV4__x3D
	XREF	_flags__xGFX
	XREF	_mode__xGFX
	XREF	_numModes__xGFX
	XREF	_KeymapBase
	XREF	_useCount__xKEY
	XREF	_TimerBase__MILLICLOCK
	XREF	_current__MILLICLOCK
	XREF	_clockFreq__MILLICLOCK
	XREF	_threadCnt__THREAD
	XREF	_threadsIdle__THREAD
	XREF	_rootThread__THREAD
	XREF	_sigXSF__XSFHEAD
	XREF	_fileMarker__XSFOBJ
	XREF	_DiskfontBase
	XREF	_flags__DRAW
	XREF	_stack__VGPU
	XREF	_stackPos__VGPU
	XREF	_vertexBase__VGPU
	XREF	_vertexTop__VGPU
	XREF	_dataPos__VGPU
	XREF	_instPos__VGPU
	XREF	_exe_flags__VGPU
	XREF	_exe_stateReg__VGPU
	XREF	_exe_colourReg__VGPU
	XREF	_exe_texReg__VGPU
	XREF	_exe_fogReg__VGPU
	XREF	_exe_errReg__VGPU
	XREF	_funcTab__VGPU
	XREF	_qTrigTab__DRAWLIST

	SECTION "Round16__r23d:0",CODE

	rts

	SECTION "_rPool__xSURFACE:0",CODE


	XDEF	_INIT_8_Surface_cpp__rPool__xSURFACE
_INIT_8_Surface_cpp__rPool__xSURFACE
L141
;xPOOL_S<RastPort> xSURFACE::rPool;
	lea	_rPool__xSURFACE,a0
	clr.l	(a0)
	clr.l	4(a0)
	clr.l	$C(a0)
	move.l	#-1,$10(a0)
	clr.l	$14(a0)
	clr.l	$18(a0)
	clr.l	$1C(a0)
	clr.l	$20(a0)
	rts

	XDEF	_EXIT_8_Surface_cpp__rPool__xSURFACE
_EXIT_8_Surface_cpp__rPool__xSURFACE
L142
	move.l	#_rPool__xSURFACE,-(a7)
	jsr	_0dt__POOL_ST__T
	addq.w	#4,a7
	rts

	SECTION "_rPool__xSURFACE:2",BSS

	XDEF	_rPool__xSURFACE
_rPool__xSURFACE
	ds.b	36

	SECTION "Init__xSURFACE_:0",CODE


;sint32 xSURFACE::Init()
	XDEF	Init__xSURFACE_
Init__xSURFACE_
L151	EQU	-$8
	link	a5,#L151
	movem.l	d2/a6,-(a7)
L143
;	if (rPool.Create(RPORTPOOLSIZE)!=OK)
	pea	$64.w
	move.w	#$100,-(a7)
	move.l	#_rPool__xSURFACE,-(a7)
	jsr	Create__POOL_ST__TUsUj
	add.w	#$A,a7
	tst.l	d0
	beq.b	L145
L144
;		return ERR_RSC_INVALID;
	move.l	#-$3050008,d0
	movem.l	(a7)+,d2/a6
	unlk	a5
	rts
L145
;	RastPort *r = 0;
	clr.l	-4(a5)
;	if (rPool.New(&r,RPORTPOOLSIZE)!=WRN_RSC_EXHAUSTED)
	move.w	#$100,-(a7)
	pea	-4(a5)
	move.l	#_rPool__xSURFACE,-(a7)
	jsr	NewT__POOL_ST__TPvUs
	add.w	#$A,a7
	cmp.l	#-$2050006,d0
	beq.b	L147
L146
;		return ERR_RSC_INVALID;
	move.l	#-$3050008,d0
	movem.l	(a7)+,d2/a6
	unlk	a5
	rts
L147
;	for (sint32 i = 0;
	moveq	#0,d2
	bra.b	L149
L148
;		InitRastPort(&r[i]);
	move.l	d2,d0
	muls.l	#$64,d0
	move.l	-4(a5),a0
	move.l	_GfxBase,a6
	lea	0(a0,d0.l),a1
	jsr	-$C6(a6)
	addq.l	#1,d2
L149
	cmp.l	#$100,d2
	blt.b	L148
L150
;	rPool.Free(&r);
	pea	-4(a5)
	move.l	#_rPool__xSURFACE,-(a7)
	jsr	FreeT__POOL_ST__TPv
	addq.w	#$8,a7
;	return OK;
	moveq	#0,d0
	movem.l	(a7)+,d2/a6
	unlk	a5
	rts

	SECTION "Done__xSURFACE_:0",CODE


;sint32 xSURFACE::Done()
	XDEF	Done__xSURFACE_
Done__xSURFACE_
L152
;	return rPool.Delete(true);
	clr.w	-(a7)
	move.w	#1,-(a7)
	move.l	#_rPool__xSURFACE,-(a7)
	jsr	Delete__POOL_ST__Tss
	addq.w	#$8,a7
	rts

	SECTION "Attach__xSURFACE__Tr14P08RastPort:0",CODE


;sint32 xSURFACE::Attach(register sysLAYER* r)
	XDEF	Attach__xSURFACE__Tr14P08RastPort
Attach__xSURFACE__Tr14P08RastPort
	movem.l	a2/a3/a6,-(a7)
	move.l	a6,a3
	move.l	$10(a7),a2
L153
;	if (flags & OWNBITMAP) // cant attach if own BitMap
	move.l	a2,a0
	move.l	$1C(a0),d0
	and.l	#4,d0
	beq.b	L155
L154
;		return ERR_PTR_USED;
	move.l	#-$3020003,d0
	movem.l	(a7)+,a2/a3/a6
	rts
L155
;	if (r==0)
	move.l	a3,a0
	cmp.w	#0,a0
	bne.b	L157
L156
;		return ERR_PTR_ZERO;
	move.l	#-$3020002,d0
	movem.l	(a7)+,a2/a3/a6
	rts
L157
;	if (r->BitMap==0)
	move.l	a3,a1
	move.l	4(a1),a0
	cmp.w	#0,a0
	bne.b	L161
L158
;		if (flags & OWNRPORT)
	move.l	a2,a0
	move.l	$1C(a0),d0
	and.l	#1,d0
	beq.b	L160
L159
;			rPool.Free(&rPort);
	pea	$C(a2)
	move.l	#_rPool__xSURFACE,-(a7)
	jsr	FreeT__POOL_ST__TPv
	addq.w	#$8,a7
L160
;		rPort		= r;
	move.l	a2,a1
	move.l	a3,$C(a1)
;		flags		= EXTERNRPORT;
	move.l	a2,a0
	move.l	#2,$1C(a0)
;		width		= 0;
	move.l	a2,a0
	clr.w	(a0)
;		height	= 0;
	move.l	a2,a0
	clr.w	2(a0)
;		depth		= 0;
	move.l	a2,a0
	clr.w	4(a0)
;		format	= SURF_NONE;
	move.l	a2,a0
	move.w	#$F,6(a0)
;		return OK;
	moveq	#0,d0
	movem.l	(a7)+,a2/a3/a6
	rts
L161
;		if (GetCyberMapAttr(r->BitMap, CYBRMATTR_ISCYBERGFX)==false)
	move.l	a3,a1
	move.l	_CyberGfxBase,a6
	move.l	#$80000008,d0
	move.l	4(a1),a0
	jsr	-$60(a6)
	tst.l	d0
	bne.b	L163
L162
;			flags |= ERR_HANDLE;
	move.l	a2,a0
	move.l	$1C(a0),d0
	or.l	#$40000,d0
	move.l	a2,a0
	move.l	d0,$1C(a0)
;			return ERR_RSC_INVALID;
	move.l	#-$3050008,d0
	movem.l	(a7)+,a2/a3/a6
	rts
L163
;			if (flags & OWNRPORT)
	move.l	a2,a0
	move.l	$1C(a0),d0
	and.l	#1,d0
	beq.b	L165
L164
;				rPool.Free(&rPort);
	pea	$C(a2)
	move.l	#_rPool__xSURFACE,-(a7)
	jsr	FreeT__POOL_ST__TPv
	addq.w	#$8,a7
L165
;			rPort = r;
	move.l	a2,a1
	move.l	a3,$C(a1)
;			flags = EXTERNRPORT|EXTERNBITMAP;
	move.l	a2,a0
	move.l	#$A,$1C(a0)
;			ReadAttrs(rPort->BitMap);
	move.l	a2,a1
	move.l	$C(a1),a0
	move.l	4(a0),-(a7)
	move.l	a2,-(a7)
	jsr	ReadAttrs__xSURFACE__TP06BitMap
	addq.w	#$8,a7
;			return OK;
	moveq	#0,d0
	movem.l	(a7)+,a2/a3/a6
	rts

	SECTION "Attach__xSURFACE__Tr14P06BitMap:0",CODE


;sint32 xSURFACE::Attach(register sysSURFACE* s)
	XDEF	Attach__xSURFACE__Tr14P06BitMap
Attach__xSURFACE__Tr14P06BitMap
	movem.l	a2/a3/a6,-(a7)
	move.l	a6,a3
	move.l	$10(a7),a2
L166
;	if (flags & (BITMAP|EXTERNRPORT))
	move.l	a2,a0
	move.l	$1C(a0),d0
	and.l	#$E,d0
	beq.b	L168
L167
;		return ERR_PTR_USED;
	move.l	#-$3020003,d0
	movem.l	(a7)+,a2/a3/a6
	rts
L168
;	if (s==0)
	move.l	a3,a0
	cmp.w	#0,a0
	bne.b	L170
L169
;		return ERR_PTR_ZERO;
	move.l	#-$3020002,d0
	movem.l	(a7)+,a2/a3/a6
	rts
L170
;	if (GetCyberMapAttr(s, CYBRMATTR_ISCYBERGFX)==false)
	move.l	_CyberGfxBase,a6
	move.l	#$80000008,d0
	move.l	a3,a0
	jsr	-$60(a6)
	tst.l	d0
	bne.b	L172
L171
;		flags |= ERR_HANDLE;
	move.l	a2,a0
	move.l	$1C(a0),d0
	or.l	#$40000,d0
	move.l	a2,a0
	move.l	d0,$1C(a0)
;		return ERR_RSC_INVALID;
	move.l	#-$3050008,d0
	movem.l	(a7)+,a2/a3/a6
	rts
L172
;	if ((flags & OWNRPORT)==0)
	move.l	a2,a0
	move.l	$1C(a0),d0
	and.l	#1,d0
	bne.b	L176
L173
;		if(rPool.New(&rPort)!=OK)
	pea	$C(a2)
	move.l	#_rPool__xSURFACE,-(a7)
	jsr	NewT__POOL_ST__TPv
	addq.w	#$8,a7
	tst.l	d0
	beq.b	L175
L174
;			return ERR_RSC_EXHAUSTED;
	move.l	#-$3050006,d0
	movem.l	(a7)+,a2/a3/a6
	rts
L175
;		flags |= OWNRPORT
	move.l	a2,a0
	move.l	$1C(a0),d0
	or.l	#1,d0
	move.l	a2,a0
	move.l	d0,$1C(a0)
L176
;	rPort->BitMap = s;
	move.l	a2,a1
	move.l	$C(a1),a0
	move.l	a3,4(a0)
;	flags |= EXTERNBITMAP;
	move.l	a2,a0
	move.l	$1C(a0),d0
	or.l	#$8,d0
	move.l	a2,a0
	move.l	d0,$1C(a0)
;	ReadAttrs(s);
	move.l	a3,-(a7)
	move.l	a2,-(a7)
	jsr	ReadAttrs__xSURFACE__TP06BitMap
	addq.w	#$8,a7
;	return OK;
	moveq	#0,d0
	movem.l	(a7)+,a2/a3/a6
	rts

	SECTION "Create__xSURFACE__Tsss:0",CODE


;sint32 xSURFACE::Create(S_WH, sint16 d)
	XDEF	Create__xSURFACE__Tsss
Create__xSURFACE__Tsss
	movem.l	d2-d4/a2/a6,-(a7)
	move.w	$20(a7),d0
	move.w	$1E(a7),d2
	move.w	$1C(a7),d4
	move.l	$18(a7),a2
L177
;	if (flags & BITMAP)
	move.l	a2,a0
	move.l	$1C(a0),d1
	and.l	#$C,d1
	beq.b	L179
L178
;		return ERR_RSC_LOCKED;
	move.l	#-$3050004,d0
	movem.l	(a7)+,d2-d4/a2/a6
	rts
L179
;	if (w <= 0 || h <= 0)
	cmp.w	#0,d4
	ble.b	L181
L180
	cmp.w	#0,d2
	bgt.b	L182
L181
;		return ERR_VALUE;
	move.l	#-$3010000,d0
	movem.l	(a7)+,d2-d4/a2/a6
	rts
L182
;	if (d <= 8)				
	cmp.w	#$8,d0
	bgt.b	L184
L183
;	if (d <= 8)				f = (SURF_8<<24)	| BMF_SPECIALFMT | 
	move.l	#$92,d3
	bra.b	L191
L184
;	else if (d <= 15)	
	cmp.w	#$F,d0
	bgt.b	L186
L185
;	else if (d <= 15)	f = (SURF_15<<24)	| BMF_SPECIA
	move.l	#$1000092,d3
	bra.b	L191
L186
;	else if (d <= 16)	
	cmp.w	#$10,d0
	bgt.b	L188
L187
;	else if (d <= 16)	f = (SURF_16<<24)	| BMF_SPECIA
	move.l	#$5000092,d3
	bra.b	L191
L188
;	else if (d <= 24)	
	cmp.w	#$18,d0
	bgt.b	L190
L189
;	else if (d <= 24)	f = (SURF_24<<24)	| BMF_SPECIA
	move.l	#$9000092,d3
	bra.b	L191
L190
;	else							f = (SURF_32<<24) | BMF_SPECIALFMT | BMF_MIN
	move.l	#$B000092,d3
L191
;	if ((flags & RPORT) == 0) // No RastPort ?
	move.l	a2,a0
	move.l	$1C(a0),d0
	and.l	#3,d0
	bne.b	L195
L192
;		if(rPool.New(&rPort)!=OK)
	pea	$C(a2)
	move.l	#_rPool__xSURFACE,-(a7)
	jsr	NewT__POOL_ST__TPv
	addq.w	#$8,a7
	tst.l	d0
	beq.b	L194
L193
;			return ERR_RSC_EXHAUSTED;
	move.l	#-$3050006,d0
	movem.l	(a7)+,d2-d4/a2/a6
	rts
L194
;		flags |= OWNRPORT;
	move.l	a2,a0
	move.l	$1C(a0),d0
	or.l	#1,d0
	move.l	a2,a0
	move.l	d0,$1C(a0)
L195
;	rPort->BitMap = AllocBitMap(w, h, BIZZARE_PLANES, f, 0);
	move.w	d2,d1
	ext.l	d1
	move.w	d4,d0
	ext.l	d0
	move.l	_GfxBase,a6
	moveq	#$9,d2
	sub.l	a0,a0
	jsr	-$396(a6)
	move.l	a2,a1
	move.l	$C(a1),a0
	move.l	d0,4(a0)
;	if (rPort->BitMap == 0)
	move.l	a2,a1
	move.l	$C(a1),a0
	move.l	4(a0),a0
	cmp.w	#0,a0
	bne.b	L199
L196
;		if (flags & OWNRPORT)
	move.l	a2,a0
	move.l	$1C(a0),d0
	and.l	#1,d0
	beq.b	L198
L197
;			rPool.Free(&rPort);
	pea	$C(a2)
	move.l	#_rPool__xSURFACE,-(a7)
	jsr	FreeT__POOL_ST__TPv
	addq.w	#$8,a7
;			flags &= ~RPORT;
	move.l	a2,a0
	move.l	$1C(a0),d0
	and.l	#-4,d0
	move.l	a2,a0
	move.l	d0,$1C(a0)
L198
;		flags |= ERR_CREATE | ERR_NOFREEMEM;
	move.l	a2,a0
	move.l	$1C(a0),d0
	or.l	#$90000,d0
	move.l	a2,a0
	move.l	d0,$1C(a0)
;		return ERR_NO_FREE_STORE;
	move.l	#-$3030001,d0
	movem.l	(a7)+,d2-d4/a2/a6
	rts
L199
;	flags |= OWNBITMAP;
	move.l	a2,a0
	move.l	$1C(a0),d0
	or.l	#4,d0
	move.l	a2,a0
	move.l	d0,$1C(a0)
;	ReadAttrs(rPort->BitMap);
	move.l	a2,a1
	move.l	$C(a1),a0
	move.l	4(a0),-(a7)
	move.l	a2,-(a7)
	jsr	ReadAttrs__xSURFACE__TP06BitMap
	addq.w	#$8,a7
;	return OK;
	moveq	#0,d0
	movem.l	(a7)+,d2-d4/a2/a6
	rts

	SECTION "Create__xSURFACE__TssP08xSURFACE:0",CODE


;sint32 xSURFACE::Create(S_WH, xSURFACE* surf)
	XDEF	Create__xSURFACE__TssP08xSURFACE
Create__xSURFACE__TssP08xSURFACE
	movem.l	d2/d3/a2/a6,-(a7)
	move.w	$1A(a7),d2
	move.w	$18(a7),d3
	move.l	$14(a7),a2
	move.l	$1C(a7),a6
L200
;	if (flags & BITMAP)
	move.l	a2,a0
	move.l	$1C(a0),d0
	and.l	#$C,d0
	beq.b	L202
L201
;		return ERR_RSC_LOCKED;
	move.l	#-$3050004,d0
	movem.l	(a7)+,d2/d3/a2/a6
	rts
L202
;	if (w <= 0 || h <= 0)
	cmp.w	#0,d3
	ble.b	L204
L203
	cmp.w	#0,d2
	bgt.b	L205
L204
;		return ERR_VALUE;
	move.l	#-$3010000,d0
	movem.l	(a7)+,d2/d3/a2/a6
	rts
L205
;	if ( (surf==0) || (((surf->flags) & BITMAP)==0) )
	cmp.w	#0,a6
	beq.b	L207
L206
	move.l	$1C(a6),d0
	and.l	#$C,d0
	bne.b	L208
L207
;		flags = ERR_CREATE | ERR_FRIEND;
	move.l	a2,a0
	move.l	#$A0000,$1C(a0)
;		return ERR_PTR_ZERO;
	move.l	#-$3020002,d0
	movem.l	(a7)+,d2/d3/a2/a6
	rts
L208
;	if ((flags & RPORT) == 0) // No RastPort ?
	move.l	a2,a0
	move.l	$1C(a0),d0
	and.l	#3,d0
	bne.b	L212
L209
;		if(rPool.New(&rPort)!=OK)
	pea	$C(a2)
	move.l	#_rPool__xSURFACE,-(a7)
	jsr	NewT__POOL_ST__TPv
	addq.w	#$8,a7
	tst.l	d0
	beq.b	L211
L210
;			return ERR_RSC_EXHAUSTED;
	move.l	#-$3050006,d0
	movem.l	(a7)+,d2/d3/a2/a6
	rts
L211
;		flags |= OWNRPORT;
	move.l	a2,a0
	move.l	$1C(a0),d0
	or.l	#1,d0
	move.l	a2,a0
	move.l	d0,$1C(a0)
L212
;	rPort->BitMap = AllocBitMap(w, h, 8, BMF_MINPLANES|BMF_DISPLAYABLE
	move.l	$C(a6),a0
	move.w	d2,d1
	ext.l	d1
	move.w	d3,d0
	ext.l	d0
	move.l	_GfxBase,a6
	moveq	#$8,d2
	moveq	#$12,d3
	move.l	4(a0),a0
	jsr	-$396(a6)
	move.l	a2,a1
	move.l	$C(a1),a0
	move.l	d0,4(a0)
;	if (rPort->BitMap == 0)
	move.l	a2,a1
	move.l	$C(a1),a0
	move.l	4(a0),a0
	cmp.w	#0,a0
	bne.b	L216
L213
;		if (flags & OWNRPORT)
	move.l	a2,a0
	move.l	$1C(a0),d0
	and.l	#1,d0
	beq.b	L215
L214
;			rPool.Free(&rPort);
	pea	$C(a2)
	move.l	#_rPool__xSURFACE,-(a7)
	jsr	FreeT__POOL_ST__TPv
	addq.w	#$8,a7
;			flags &= ~RPORT;
	move.l	a2,a0
	move.l	$1C(a0),d0
	and.l	#-4,d0
	move.l	a2,a0
	move.l	d0,$1C(a0)
L215
;		flags = ERR_CREATE | ERR_NOFREEMEM;
	move.l	a2,a0
	move.l	#$90000,$1C(a0)
;		return ERR_NO_FREE_STORE;
	move.l	#-$3030001,d0
	movem.l	(a7)+,d2/d3/a2/a6
	rts
L216
;	flags |= OWNBITMAP;
	move.l	a2,a0
	move.l	$1C(a0),d0
	or.l	#4,d0
	move.l	a2,a0
	move.l	d0,$1C(a0)
;	ReadAttrs(rPort->BitMap);
	move.l	a2,a1
	move.l	$C(a1),a0
	move.l	4(a0),-(a7)
	move.l	a2,-(a7)
	jsr	ReadAttrs__xSURFACE__TP06BitMap
	addq.w	#$8,a7
;	return OK;
	moveq	#0,d0
	movem.l	(a7)+,d2/d3/a2/a6
	rts

	SECTION "Delete__xSURFACE__T:0",CODE


;sint32 xSURFACE::Delete()
	XDEF	Delete__xSURFACE__T
Delete__xSURFACE__T
	movem.l	a2/a6,-(a7)
	move.l	$C(a7),a2
L217
;	if (lockHandle)
	move.l	a2,a1
	tst.l	$10(a1)
	beq.b	L219
L218
;		return ERR_RSC_LOCKED;
	move.l	#-$3050004,d0
	movem.l	(a7)+,a2/a6
	rts
L219
;	if (rPort==0)
	move.l	a2,a1
	move.l	$C(a1),a0
	cmp.w	#0,a0
	bne.b	L221
L220
;		return OK;
	moveq	#0,d0
	movem.l	(a7)+,a2/a6
	rts
L221
;	if (flags & OWNBITMAP && rPort->BitMap)
	move.l	a2,a0
	move.l	$1C(a0),d0
	and.l	#4,d0
	beq.b	L224
L222
	move.l	a2,a1
	move.l	$C(a1),a0
	tst.l	4(a0)
	beq.b	L224
L223
;		FreeBitMap(rPort->BitMap);
	move.l	a2,a1
	move.l	$C(a1),a0
	move.l	_GfxBase,a6
	move.l	4(a0),a0
	jsr	-$39C(a6)
;		rPort->BitMap = 0;
	move.l	a2,a1
	move.l	$C(a1),a0
	clr.l	4(a0)
L224
;	if (flags & OWNRPORT)
	move.l	a2,a0
	move.l	$1C(a0),d0
	and.l	#1,d0
	beq.b	L226
L225
;		rPort->BitMap = 0;
	move.l	a2,a1
	move.l	$C(a1),a0
	clr.l	4(a0)
;		rPool.Free(&rPort);
	pea	$C(a2)
	move.l	#_rPool__xSURFACE,-(a7)
	jsr	FreeT__POOL_ST__TPv
	addq.w	#$8,a7
L226
;	flags = 0;
	move.l	a2,a0
	clr.l	$1C(a0)
;	width = 0;
	move.l	a2,a0
	clr.w	(a0)
;	height = 0;
	move.l	a2,a0
	clr.w	2(a0)
;	depth = 0;
	move.l	a2,a0
	clr.w	4(a0)
;	format = SURF_NONE;
	move.l	a2,a0
	move.w	#$F,6(a0)
;	rPort	= 0;
	move.l	a2,a1
	clr.l	$C(a1)
;	return OK;
	moveq	#0,d0
	movem.l	(a7)+,a2/a6
	rts

	SECTION "ReadAttrs__xSURFACE__TP06BitMap:0",CODE


;void xSURFACE::ReadAttrs(sysSURFACE* b)
	XDEF	ReadAttrs__xSURFACE__TP06BitMap
ReadAttrs__xSURFACE__TP06BitMap
	movem.l	a2/a3/a6,-(a7)
	movem.l	$10(a7),a2/a3
L227
;	width		= GetCyberMapAttr(b, CYBRMATTR_WIDTH);
	move.l	_CyberGfxBase,a6
	move.l	#$80000005,d0
	move.l	a3,a0
	jsr	-$60(a6)
	move.l	a2,a0
	move.w	d0,(a0)
;	height	= GetCyberMapAttr(b, CYBRMATTR_HEIGHT);
	move.l	_CyberGfxBase,a6
	move.l	#$80000006,d0
	move.l	a3,a0
	jsr	-$60(a6)
	move.l	a2,a0
	move.w	d0,2(a0)
;	depth		= GetCyberMapAttr(b, CYBRMATTR_DEPTH);
	move.l	_CyberGfxBase,a6
	move.l	#$80000007,d0
	move.l	a3,a0
	jsr	-$60(a6)
	move.l	a2,a0
	move.w	d0,4(a0)
;	format	= GetCyberMapAttr(b, CYBRMATTR_PIXFMT);
	move.l	_CyberGfxBase,a6
	move.l	#$80000004,d0
	move.l	a3,a0
	jsr	-$60(a6)
	move.l	a2,a0
	move.w	d0,6(a0)
;	if (GetCyberMapAttr(b, CYBRMATTR_ISLINEARMEM))
	move.l	_CyberGfxBase,a6
	move.l	#$80000009,d0
	move.l	a3,a0
	jsr	-$60(a6)
	tst.l	d0
	beq.b	L229
L228
;		flags |=  LINEARMEM;
	move.l	a2,a0
	move.l	$1C(a0),d0
	or.l	#$400,d0
	move.l	a2,a0
	move.l	d0,$1C(a0)
	bra.b	L230
L229
;		flags &= ~LINEARMEM;
	move.l	a2,a0
	move.l	$1C(a0),d0
	and.l	#-$401,d0
	move.l	a2,a0
	move.l	d0,$1C(a0)
L230
	movem.l	(a7)+,a2/a3/a6
	rts

	SECTION "_0dt__xSURFACE__T:0",CODE


;xSURFACE::~xSURFACE()
	XDEF	_0dt__xSURFACE__T
_0dt__xSURFACE__T
	movem.l	a2/a6,-(a7)
	move.l	$C(a7),a2
L231
;	if (rPort)
	move.l	a2,a1
	tst.l	$C(a1)
	beq.b	L239
L232
;		if (rPort->BitMap)
	move.l	a2,a1
	move.l	$C(a1),a0
	tst.l	4(a0)
	beq.b	L237
L233
;			if (lockHandle)
	move.l	a2,a1
	tst.l	$10(a1)
	beq.b	L235
L234
;				UnLockBitMap(lockHandle);
	move.l	a2,a1
	move.l	_CyberGfxBase,a6
	move.l	$10(a1),a0
	jsr	-$AE(a6)
L235
;			if (flags & OWNBITMAP)
	move.l	a2,a0
	move.l	$1C(a0),d0
	and.l	#4,d0
	beq.b	L237
L236
;				FreeBitMap(rPort->BitMap);
	move.l	a2,a1
	move.l	$C(a1),a0
	move.l	_GfxBase,a6
	move.l	4(a0),a0
	jsr	-$39C(a6)
L237
;		if (flags & OWNRPORT)
	move.l	a2,a0
	move.l	$1C(a0),d0
	and.l	#1,d0
	beq.b	L239
L238
;			rPort->BitMap = 0;
	move.l	a2,a1
	move.l	$C(a1),a0
	clr.l	4(a0)
;			rPool.Free(&rPort);
	pea	$C(a2)
	move.l	#_rPool__xSURFACE,-(a7)
	jsr	FreeT__POOL_ST__TPv
	addq.w	#$8,a7
L239
	movem.l	(a7)+,a2/a6
	rts

	END
