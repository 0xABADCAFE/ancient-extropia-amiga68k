
; Storm C Compiler
; extropialib:lib/Platforms/Amiga68k/GraphicsLib/DrawList.cpp
	mc68030
	mc68881
	XREF	Delete__xTEXFONT__T
	XREF	_0ct__xTEXSURF__T
	XREF	Delete__xTEXSURF__T
	XREF	ReadBody__xTEXSURF__TR05XSFIO
	XREF	WriteBody__xTEXSURF__TR05XSFIO
	XREF	ReadyForRead__xTEXSURF__T
	XREF	ReadyForWrite__xTEXSURF__T
	XREF	_0ct__XSFOBJ__T
	XREF	Set__XSFHEAD__TPCcUcUcUcUc
	XREF	op__equal__XSFHEAD__TR05XSFIO
	XREF	op__equal__XSFHEAD__TR07XSFHEAD
	XREF	op__notEqual__XSFHEAD__TR07XSFHEAD
	XREF	Value__XDATAID__TPCc
	XREF	Refresh__xDBSCREEN__T
	XREF	Close__xDBSCREEN__T
	XREF	Open__xDBSCREEN__T
	XREF	Close__xSCREEN__T
	XREF	Open__xSCREEN__T
	XREF	Set__xSCREEN__TP06xDMODEPCc
	XREF	Close__xDBWIN__T
	XREF	Open__xDBWIN__T
	XREF	Set__xDBWIN__TsssssPCc
	XREF	MoveEvent__xDISPLAYIO__T
	XREF	ResizeEvent__xDISPLAYIO__T
	XREF	Idle__xDISPLAYIO__T
	XREF	HandleEvent__xDISPLAYIO__T
	XREF	ApplyInputModification__xDISPLAYIO__T
	XREF	ViewSurface__xDISPLAY__T
	XREF	DrawSurface__xDISPLAY__T
	XREF	Refresh__xDISPLAY__T
	XREF	Close__xDISPLAY__T
	XREF	Open__xDISPLAY__T
	XREF	_0dt__LOCK__T
	XREF	_0dt__THREAD__T
	XREF	Run__THREAD__T
	XREF	_0dt__DELAY__T
	XREF	_0ct__DELAY__T
	XREF	Pause__DELAY__TUj
	XREF	Pause__DELAY__TUjUj
	XREF	Abort__DELAY__T
	XREF	UnLink__xCHAINABLE__T
	XREF	Close__xFILEIO__T
	XREF	Flush__xFILEIO__T
	XREF	Write64Swap__xFILEIO__TPvUi
	XREF	Write32Swap__xFILEIO__TPvUi
	XREF	Write16Swap__xFILEIO__TPvUi
	XREF	Write__xFILEIO__TPvUiUi
	XREF	Read64Swap__xFILEIO__TPvUi
	XREF	Read32Swap__xFILEIO__TPvUi
	XREF	Read16Swap__xFILEIO__TPvUi
	XREF	Read__xFILEIO__TPvUiUi
	XREF	Tell__xFILEIO__T
	XREF	Seek__xFILEIO__Tjj
	XREF	Open__xFILEIO__TPCcjj
	XREF	SendPacket__xFILEIO__TPv
	XREF	WaitPacket__xFILEIO__T
	XREF	InputQueued__xINPUT__T
	XREF	Idle__xINPUT__T
	XREF	ExitEvent__xINPUT__T
	XREF	MouseEvent__xINPUT__Tjjj
	XREF	ApplyInputModification__xINPUT__T
	XREF	_0dt__xKEY__T
	XREF	_0ct__xKEY__T
	XREF	KeyEvent__xKEY__Tjsj
	XREF	_0dt__xSURFACE__T
	XREF	_0dt__POOL_ST__T
	XREF	_0ct__POOL_ST__TUsUj
	XREF	FreeT__POOL_ST__TPv
	XREF	NewT__POOL_ST__TPvUs
	XREF	NewT__POOL_ST__TPv
	XREF	Create__POOL_ST__TUsUj
	XREF	_0dt__POOL_LT__T
	XREF	SetDrawArea__x3D__P08xSURFACEssss
	XREF	FreeContext__x3D_
	XREF	BuildContext__x3D__P08xSURFACEs
	XREF	DrawSurface__x3D__P08xSURFACE
	XREF	v3DrawLineStrip__x3D__jj
	XREF	v3DrawLines__x3D__jj
	XREF	_W3D_DrawArray
	XREF	_W3D_BindTexture
	XREF	Free__MEM__Pv
	XREF	Alloc__MEM__UisE
	XREF	_system
	XREF	_std__in
	XREF	_std__out
	XREF	_std__err
	XREF	_st
	XREF	_gxSt
	XREF	_numStartArgs__xBASELIB
	XREF	_startArgs__xBASELIB
	XREF	_SysBase
	XREF	_IntuitionBase
	XREF	_TimerBase
	XREF	_DOSBase
	XREF	_PowerPCBase
	XREF	_sysData__sysBASELIB
	XREF	_msgbuff__sysBASELIB
	XREF	_main__sysBASELIB
	XREF	_allocated__MEM
	XREF	_totSize__MEM
	XREF	_nextFree__MEM
	XREF	_cnt__MEM
	XREF	_maxAllocs__MEM
	XREF	_fpuPrecision__CPU
	XREF	_cpuNames__CPU
	XREF	_GfxBase
	XREF	_CyberGfxBase
	XREF	_surfaceTypes__x2D
	XREF	_Warp3DBase
	XREF	_hw3D__sys3DDEVICE
	XREF	_context__sys3DDEVICE
	XREF	_drawRegion__x3D
	XREF	_fogData__x3D
	XREF	_flags__x3D
	XREF	_vertices__x3D
	XREF	_currTex__x3D
	XREF	_drawSurface__x3D
	XREF	_currCol__x3D
	XREF	_useV4__x3D
	XREF	_flags__xGFX
	XREF	_mode__xGFX
	XREF	_numModes__xGFX
	XREF	_rPool__xSURFACE
	XREF	_KeymapBase
	XREF	_useCount__xKEY
	XREF	_TimerBase__MILLICLOCK
	XREF	_current__MILLICLOCK
	XREF	_clockFreq__MILLICLOCK
	XREF	_threadCnt__THREAD
	XREF	_threadsIdle__THREAD
	XREF	_rootThread__THREAD
	XREF	_sigXSF__XSFHEAD
	XREF	_fileMarker__XSFOBJ
	XREF	_DiskfontBase
	XREF	_stack__VGPU
	XREF	_stackPos__VGPU
	XREF	_vertexBase__VGPU
	XREF	_vertexTop__VGPU
	XREF	_dataPos__VGPU
	XREF	_instPos__VGPU
	XREF	_exe_flags__VGPU
	XREF	_exe_stateReg__VGPU
	XREF	_exe_colourReg__VGPU
	XREF	_exe_texReg__VGPU
	XREF	_exe_fogReg__VGPU
	XREF	_exe_errReg__VGPU
	XREF	_funcTab__VGPU

	SECTION "Round16__r23d:0",CODE

	rts

	SECTION "_flags__DRAW:1",DATA

	XDEF	_flags__DRAW
_flags__DRAW
	dc.l	0

	SECTION "Bind__DRAW__P08xSURFACE:0",CODE


;sint32 DRAW::Bind(xSURFACE* s)
	XDEF	Bind__DRAW__P08xSURFACE
Bind__DRAW__P08xSURFACE
	movem.l	d2/a6,-(a7)
	move.l	$C(a7),a6
L103
;	if (!s || !(s->Handle()))
	cmp.w	#0,a6
	beq.b	L108
L104
	move.l	a6,a0
	tst.l	$C(a0)
	beq.b	L107
L105
	move.l	$C(a0),a0
	tst.l	4(a0)
	bne.b	L109
L106
L107
L108
;		return ERR_PTR_ZERO;
	move.l	#-$3020002,d0
	movem.l	(a7)+,d2/a6
	rts
L109
;	if (x3D::Context())
	move.l	_context__sys3DDEVICE,a0
	cmp.w	#0,a0
	beq	L120
L110
;		if (s->Format()==x3D::DrawSurface()->Format())
	move.l	a6,a0
	move.l	$8(a0),a1
	move.l	a0,d0
	add.l	$14(a1),d0
	move.l	d0,-(a7)
	move.l	$10(a1),a1
	jsr	(a1)
	move.l	d0,d2
	addq.w	#4,a7
	move.l	_drawSurface__x3D,a0
	move.l	$8(a0),a1
	move.l	a0,d0
	add.l	$14(a1),d0
	move.l	d0,-(a7)
	move.l	$10(a1),a1
	jsr	(a1)
	addq.w	#4,a7
	cmp.l	d0,d2
	bne	L119
L111
;			if (x3D::SetDrawArea(s, 0, 0, s->Width(), s->Height())==false)
	move.l	a6,a0
	move.l	$8(a0),a1
	move.l	a0,d0
	add.l	$24(a1),d0
	move.l	d0,-(a7)
	move.l	$20(a1),a1
	jsr	(a1)
	addq.w	#4,a7
	move.w	d0,-(a7)
	move.l	a6,a0
	move.l	$8(a0),a1
	move.l	a0,d0
	add.l	$2C(a1),d0
	move.l	d0,-(a7)
	move.l	$28(a1),a1
	jsr	(a1)
	addq.w	#4,a7
	move.w	d0,-(a7)
	clr.w	-(a7)
	clr.w	-(a7)
	move.l	a6,-(a7)
	jsr	SetDrawArea__x3D__P08xSURFACEssss
	add.w	#$C,a7
	tst.w	d0
	bne.b	L113
L112
;				return ERR_RSC_INVALID;
	move.l	#-$3050008,d0
	movem.l	(a7)+,d2/a6
	rts
L113
;			if (x3D::ZBuffer() && (s->Size() != x3D::DrawSurface()->Size())
	move.l	_flags__x3D,d0
	and.l	#$10000,d0
	sne	d0
	and.l	#1,d0
	tst.w	d0
	beq.b	L118
L114
	move.l	a6,a0
	move.w	(a0),d2
	muls	2(a0),d2
	move.l	_drawSurface__x3D,a0
	move.w	2(a0),d0
	muls	(a0),d0
	cmp.l	d0,d2
	beq.b	L118
L115
;				x3D::FreeZBuffer();
	and.l	#-$10001,_flags__x3D
	move.l	_context__sys3DDEVICE,a0
	move.l	_Warp3DBase,a6
	jsr	-$DE(a6)
;				x3D::AllocZBuffer();
	move.l	_context__sys3DDEVICE,a0
	move.l	_Warp3DBase,a6
	jsr	-$D8(a6)
	tst.l	d0
	bne.b	L117
L116
	or.l	#$10000,_flags__x3D
	bra.b	L118
L117
	and.l	#-$10001,_flags__x3D
L118
;			return OK;
	moveq	#0,d0
	movem.l	(a7)+,d2/a6
	rts
L119
;			x3D::FreeContext();
	jsr	FreeContext__x3D_
L120
;	return x3D::BuildContext(s,false);
	clr.w	-(a7)
	move.l	a6,-(a7)
	jsr	BuildContext__x3D__P08xSURFACEs
	addq.w	#6,a7
	movem.l	(a7)+,d2/a6
	rts

	SECTION "Release__DRAW_:0",CODE


;sint32 DRAW::Release()
	XDEF	Release__DRAW_
Release__DRAW_
	movem.l	a2/a6,-(a7)
L121
;	if (x3D::Context())
	move.l	_context__sys3DDEVICE,a0
	cmp.w	#0,a0
	beq.b	L123
L122
;		x3D::FreeDrawArea();
	clr.l	_drawRegion__x3D+4
	clr.l	_drawRegion__x3D
	clr.l	_drawRegion__x3D+$8
	clr.l	_drawRegion__x3D+$C
	move.l	_context__sys3DDEVICE,a0
	move.l	_Warp3DBase,a6
	moveq	#0,d1
	sub.l	a1,a1
	move.l	#_drawRegion__x3D,a2
	jsr	-$C0(a6)
;		return OK;
	moveq	#0,d0
	movem.l	(a7)+,a2/a6
	rts
L123
;	return WRN_RSC_UNAVAILABLE;
	move.l	#-$2050005,d0
	movem.l	(a7)+,a2/a6
	rts

	SECTION "Init__DRAW_:0",CODE


;sint32 DRAW::Init()
	XDEF	Init__DRAW_
Init__DRAW_
L124
;	return OK;
	moveq	#0,d0
	rts

	SECTION "Done__DRAW_:0",CODE


;sint32 DRAW::Done()
	XDEF	Done__DRAW_
Done__DRAW_
L125
;	if (x3D::Context())
	move.l	_context__sys3DDEVICE,a0
	cmp.w	#0,a0
	beq.b	L127
L126
;		x3D::FreeContext();
	jsr	FreeContext__x3D_
L127
;	return OK;
	moveq	#0,d0
	rts

	SECTION "_qTrigTab__DRAWLIST:1",DATA

	XDEF	_qTrigTab__DRAWLIST
_qTrigTab__DRAWLIST
	dc.l	0,$3DC8BD34,$3E47C5C0,$3E94A02F,$3EC3EF14,$3EF15AE7,$3F0E39D9,$3F226797,$3F3504F3,$3F45E402,$3F54DB30
	dc.l	$3F61C596,$3F6C835E,$3F74FA0A,$3F7B14BE,$3F7EC46D,$3F800000

	SECTION "InitRegs__DRAWLIST__T:0",CODE


;void DRAWLIST::InitRegs()
	XDEF	InitRegs__DRAWLIST__T
InitRegs__DRAWLIST__T
	move.l	4(a7),a0
L129
;	currFlushCnt	= 0;
	clr.l	$2E(a0)
;	breakCnt			= 0;
	clr.l	$32(a0)
;	nestCount			= 0;
	clr.l	$36(a0)
;	commandReg		= 0;
	clr.l	$3A(a0)
;	stateReg			= 0;
	clr.l	$3E(a0)
;	colourReg			= 0;
	clr.l	$42(a0)
;	depthReg			= 0;
	clr.l	$46(a0)
;	alphaReg			= 0;
	clr.l	$4A(a0)
;	texReg				= 0;
	clr.l	$4E(a0)
;	logicReg			= L_CLEAR;
	move.l	#1,$52(a0)
;	fogReg				= F_LINEAR;
	move.l	#1,$56(a0)
;	zTestReg			= DEPTH_ALWAYS;
	move.l	#$8,$5A(a0)
;	aTestReg			= ALPHA_ALWAYS;
	move.l	#$8,$5E(a0)
	rts

	SECTION "_0ct__DRAWLIST__T:0",CODE


;DRAWLIST::DRAWLIST() 
	XDEF	_0ct__DRAWLIST__T
_0ct__DRAWLIST__T
	move.l	4(a7),a0
L130
	clr.l	$A(a0)
	clr.l	$E(a0)
	clr.l	$12(a0)
	clr.l	$16(a0)
	clr.l	$1A(a0)
	clr.l	$1E(a0)
	clr.l	$22(a0)
	rts

	SECTION "_0ct__DRAWLIST__Tjj:0",CODE


;DRAWLIST::DRAWLIST(sint32 vBuf, sint32 cBuf) 
	XDEF	_0ct__DRAWLIST__Tjj
_0ct__DRAWLIST__Tjj
	move.l	d2,-(a7)
	movem.l	$C(a7),d0/d1
	move.l	$8(a7),a0
L131
	clr.l	$A(a0)
	clr.l	$E(a0)
;	Create(vBuf, cBuf);
	move.l	d1,-(a7)
	move.l	d0,-(a7)
	move.l	a0,-(a7)
	jsr	Create__DRAWLIST__Tjj
	add.w	#$C,a7
	move.l	(a7)+,d2
	rts

	SECTION "Create__DRAWLIST__Tjj:0",CODE


;sint32 DRAWLIST::Create(sint32 vBuf, sint32 cBuf)
	XDEF	Create__DRAWLIST__Tjj
Create__DRAWLIST__Tjj
	movem.l	d2-d4/a2,-(a7)
	movem.l	$18(a7),d2/d3
	move.l	$14(a7),a2
L132
;	if (vertBuf)
	tst.l	$E(a2)
	beq.b	L134
L133
;		return ERR_RSC_LOCKED;
	move.l	#-$3050004,d0
	movem.l	(a7)+,d2-d4/a2
	rts
L134
;	vBuf	= Clamp(vBuf, 256, 262144);
	move.l	#$40000,d4
	move.l	#$100,d1
	move.l	d2,d0
	cmp.l	d1,d0
	bge.b	L136
L135
	move.l	d1,d2
	bra.b	L140
L136
	cmp.l	d4,d0
	ble.b	L138
L137
	move.l	d4,d2
	bra.b	L139
L138
	move.l	d0,d2
L139
L140
;	cBuf	= Clamp(cBuf, 256, 65536);
	move.l	#$10000,d4
	move.l	#$100,d1
	move.l	d3,d0
	cmp.l	d1,d0
	bge.b	L142
L141
	move.l	d1,d3
	bra.b	L146
L142
	cmp.l	d4,d0
	ble.b	L144
L143
	move.l	d4,d3
	bra.b	L145
L144
	move.l	d0,d3
L145
L146
;	void*	data	= MEM::Alloc((cBuf*sizeof(DCOMMAND))+(vBuf*sizeof(DVERT
	clr.l	-(a7)
	move.w	#1,-(a7)
	move.l	d3,d0
	moveq	#3,d1
	asl.l	d1,d0
	move.l	d2,d1
	moveq	#5,d4
	asl.l	d4,d1
	add.l	d1,d0
	move.l	d0,-(a7)
	jsr	Alloc__MEM__UisE
	add.w	#$A,a7
	move.l	d0,a0
;	if (!data)
	cmp.w	#0,a0
	bne.b	L148
L147
;		vertBuf 		= 0;
	clr.l	$E(a2)
;		instBuf 		= 0;
	clr.l	$12(a2)
;		currVert		= 0;
	clr.l	$16(a2)
;		currInst		= 0;
	clr.l	$1A(a2)
;		vBufSize		= 0;
	clr.l	$1E(a2)
;		iBufSize		= 0;
	clr.l	$22(a2)
;		return ERR_NO_FREE_STORE;
	move.l	#-$3030001,d0
	movem.l	(a7)+,d2-d4/a2
	rts
L148
;	vertBuf 		= (DVERTEX*)data;
	move.l	a0,$E(a2)
;	instBuf 		= (DCOMMAND*)((sint32)data+(vBuf*sizeof(DVERTEX)));
	move.l	d2,d0
	moveq	#5,d1
	asl.l	d1,d0
	move.l	a0,d1
	add.l	d0,d1
	move.l	d1,$12(a2)
;	currVert		= vertBuf;
	move.l	$E(a2),a0
	move.l	a0,$16(a2)
;	currInst		= instBuf;
	move.l	$12(a2),a0
	move.l	a0,$1A(a2)
;	vBufSize		= vBuf;
	move.l	d2,$1E(a2)
;	iBufSize		= cBuf;
	move.l	d3,$22(a2)
;	InitRegs();
	move.l	a2,-(a7)
	jsr	InitRegs__DRAWLIST__T
	addq.w	#4,a7
;	return OK;
	moveq	#0,d0
	movem.l	(a7)+,d2-d4/a2
	rts

	SECTION "Delete__DRAWLIST__T:0",CODE


;void DRAWLIST::Delete()
	XDEF	Delete__DRAWLIST__T
Delete__DRAWLIST__T
	move.l	a2,-(a7)
	move.l	$8(a7),a2
L149
;	if (vertBuf)
	tst.l	$E(a2)
	beq.b	L151
L150
;		MEM::Free(vertBuf);
	move.l	$E(a2),-(a7)
	jsr	Free__MEM__Pv
	addq.w	#4,a7
;		vertBuf 		= 0;
	clr.l	$E(a2)
;		instBuf 		= 0;
	clr.l	$12(a2)
;		currVert		= 0;
	clr.l	$16(a2)
;		currInst		= 0;
	clr.l	$1A(a2)
;		vBufSize		= 0;
	clr.l	$1E(a2)
;		iBufSize		= 0;
	clr.l	$22(a2)
;		InitRegs();
	move.l	a2,-(a7)
	jsr	InitRegs__DRAWLIST__T
	addq.w	#4,a7
L151
	move.l	(a7)+,a2
	rts

	SECTION "_0dt__DRAWLIST__T:0",CODE


;DRAWLIST::~DRAWLIST()
	XDEF	_0dt__DRAWLIST__T
_0dt__DRAWLIST__T
	move.l	4(a7),a0
L152
;	Delete();
	move.l	a0,-(a7)
	jsr	Delete__DRAWLIST__T
	addq.w	#4,a7
	rts

	END
