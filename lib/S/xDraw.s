
; Storm C Compiler
; Mendoza:Extropia/eXtropia/lib/Platforms/Amiga68k/GraphicsLib/xDraw.cpp
	mc68030
	mc68881
	XREF	_sin__r
	XREF	Delete__xTEXTURE__T
	XREF	Create__xTEXTURE__TsssPvPUj
	XREF	Refresh__xDBSCREEN__T
	XREF	Close__xDBSCREEN__T
	XREF	Open__xDBSCREEN__T
	XREF	Close__xSCREEN__T
	XREF	Open__xSCREEN__T
	XREF	Set__xSCREEN__TP06xDMODEPCc
	XREF	Close__xDBWIN__T
	XREF	Open__xDBWIN__T
	XREF	Set__xDBWIN__TsssssPCc
	XREF	Idle__xDISPLAYIO_ASYNC__T
	XREF	Done__xDISPLAYIO_ASYNC__T
	XREF	Init__xDISPLAYIO_ASYNC__T
	XREF	MoveEvent__xDISPLAYIO__T
	XREF	ResizeEvent__xDISPLAYIO__T
	XREF	Idle__xDISPLAYIO__T
	XREF	HandleEvent__xDISPLAYIO__T
	XREF	ApplyInputModification__xDISPLAYIO__T
	XREF	ViewSurface__xDISPLAY__T
	XREF	DrawSurface__xDISPLAY__T
	XREF	Refresh__xDISPLAY__T
	XREF	Close__xDISPLAY__T
	XREF	Open__xDISPLAY__T
	XREF	Close__xFILEIO__T
	XREF	Write__xFILEIO__TPvUiUi
	XREF	Read__xFILEIO__TPvUiUi
	XREF	Open__xFILEIO__TPCcjj
	XREF	SendPacket__xFILEIO__TPv
	XREF	WaitPacket__xFILEIO__T
	XREF	InputQueued__xINPUT__T
	XREF	Idle__xINPUT__T
	XREF	ExitEvent__xINPUT__T
	XREF	MouseEvent__xINPUT__Tjjj
	XREF	ApplyInputModification__xINPUT__T
	XREF	_0dt__xKEY__T
	XREF	_0ct__xKEY__T
	XREF	KeyEvent__xKEY__Tjsj
	XREF	_0dt__xSURFACE__T
	XREF	_0dt__POOL_ST__T
	XREF	_0ct__POOL_ST__TUsUj
	XREF	FreeT__POOL_ST__TPv
	XREF	NewT__POOL_ST__TPvUs
	XREF	NewT__POOL_ST__TPv
	XREF	Create__POOL_ST__TUsUj
	XREF	PrintAlloc__POOL_ST__TR07ostreamjj
	XREF	_0dt__POOL_LT__T
	XREF	SetDrawArea__x3D__P08xSURFACEssss
	XREF	FreeContext__x3D_
	XREF	BuildContext__x3D__P08xSURFACEs
	XREF	UnLink__xCHAINABLE__T
	XREF	_0ct__xTHREADABLE__TPCcUjjs
	XREF	ShutDown__xTHREADABLE__T
	XREF	Done__xTHREADABLE__T
	XREF	Init__xTHREADABLE__T
	XREF	_0dt__xLOCKABLE__T
	XREF	Zero__MEM__PvUi
	XREF	Free__MEM__Pv
	XREF	Alloc__MEM__Uiss
	XREF	MessageBox__sysBASELIB__PcPcPce
	XREF	_system
	XREF	op__leftshift__ostream__Td
	XREF	op__leftshift__ostream__Tf
	XREF	op__leftshift__ostream__TUj
	XREF	op__leftshift__ostream__Tj
	XREF	op__leftshift__ostream__TPCc
	XREF	op__leftshift__ostream__Tc
	XREF	opfx__ostream__T
	XREF	read__istream__TPci
	XREF	get__istream__TRc
	XREF	getline__istream__TPcic
	XREF	get__istream__TPcic
	XREF	op__rightshift__istream__TRc
	XREF	op__rightshift__istream__TPc
	XREF	doallocate__streambuf__T
	XREF	xsgetn__streambuf__TPci
	XREF	xsputn__streambuf__TPCci
	XREF	underflow__streambuf__T
	XREF	overflow__streambuf__Ti
	XREF	setbuf__streambuf__TPcUi
	XREF	sputn__streambuf__TPCci
	XREF	_0dt__streambuf__T
	XREF	userword__ios__Ti
	XREF	init__ios__TP09streambuf
	XREF	_vsprintf
	XREF	op__delete__PvUi
	XREF	_std__in
	XREF	_std__out
	XREF	_std__err
	XREF	_basefield__ios
	XREF	_adjustfield__ios
	XREF	_floatfield__ios
	XREF	_aNextBit__ios
	XREF	_aNextWord__ios
	XREF	_cin
	XREF	_cout
	XREF	_cerr
	XREF	_clog
	XREF	_st
	XREF	_gxSt
	XREF	_errSev__xBASELIB
	XREF	_errTbl__xBASELIB
	XREF	_SysBase
	XREF	_IntuitionBase
	XREF	_DOSBase
	XREF	_PowerPCBase
	XREF	_sysData__sysBASELIB
	XREF	_msgbuff__sysBASELIB
	XREF	_main__sysBASELIB
	XREF	_allocated__MEM
	XREF	_totSize__MEM
	XREF	_nextFree__MEM
	XREF	_cnt__MEM
	XREF	_maxAllocs__MEM
	XREF	_GfxBase
	XREF	_TimerBase
	XREF	_TimerBase__xTIMABLE
	XREF	_current__xTIMABLE
	XREF	_clockFreq__xTIMABLE
	XREF	_threadCnt__xTHREADABLE
	XREF	_main__xTHREADABLE
	XREF	_CyberGfxBase
	XREF	_formatNames__x2D
	XREF	_surfaceTypes__x2D
	XREF	_Warp3DBase
	XREF	_pointRender__SUPPORTS3D
	XREF	_lineRender__SUPPORTS3D
	XREF	_triangleRender__SUPPORTS3D
	XREF	_otherPrimitives__SUPPORTS3D
	XREF	_shadingModes__SUPPORTS3D
	XREF	_textureModes__SUPPORTS3D
	XREF	_textureFmts__SUPPORTS3D
	XREF	_alpha__SUPPORTS3D
	XREF	_fogModes__SUPPORTS3D
	XREF	_zBuffer__SUPPORTS3D
	XREF	_stencil__SUPPORTS3D
	XREF	_misc__SUPPORTS3D
	XREF	_primNames__SUPPORTS3D
	XREF	_renderNames__SUPPORTS3D
	XREF	_shadingNames__SUPPORTS3D
	XREF	_texModeNames__SUPPORTS3D
	XREF	_texFormatNames__SUPPORTS3D
	XREF	_alphaNames__SUPPORTS3D
	XREF	_fogNames__SUPPORTS3D
	XREF	_zBufferNames__SUPPORTS3D
	XREF	_stencilNames__SUPPORTS3D
	XREF	_miscNames__SUPPORTS3D
	XREF	_hw3D__SUPPORTS3D
	XREF	_context__x3D
	XREF	_drawRegion__x3D
	XREF	_fogData__x3D
	XREF	_flags__x3D
	XREF	_vertices__x3D
	XREF	_currTex__x3D
	XREF	_drawSurface__x3D
	XREF	_currCol__x3D
	XREF	_flags__xGFX
	XREF	_mode__xGFX
	XREF	_numModes__xGFX
	XREF	_rPool__xSURFACE
	XREF	_KeymapBase
	XREF	_useCount__xKEY

	SECTION "_0ct__streampos__T:0",CODE

	rts

	SECTION "_DiskfontBase:1",DATA

	XDEF	_DiskfontBase
_DiskfontBase
	dc.l	0

	SECTION "_fontInfo__xDRAW:0",CODE


L221
	dc.b	'XCourier.font',0
L222
	dc.b	'XHelvetica.font',0
L223
	dc.b	'times.font',0

	SECTION "_fontInfo__xDRAW:1",DATA

	XDEF	_fontInfo__xDRAW
_fontInfo__xDRAW
	dc.l	L221
	dc.w	$D
	dc.b	0,0
	dc.l	L222
	dc.w	$D
	dc.b	0,$20
	dc.l	L222
	dc.w	$D
	dc.b	0,$20
	dc.l	L223
	dc.w	$D
	dc.b	0,$20

	SECTION "_fontData__xDRAW:1",DATA

	XDEF	_fontData__xDRAW
_fontData__xDRAW
	dc.l	0,0,0,0

	SECTION "_flags__xDRAW:1",DATA

	XDEF	_flags__xDRAW
_flags__xDRAW
	dc.l	0

	SECTION "_flushCnt__xDRAW:1",DATA

	XDEF	_flushCnt__xDRAW
_flushCnt__xDRAW
	dc.l	0

	SECTION "_vArray__xDRAW:1",DATA

	XDEF	_vArray__xDRAW
_vArray__xDRAW
	dc.l	0

	SECTION "_vBuffer__xDRAW:1",DATA

	XDEF	_vBuffer__xDRAW
_vBuffer__xDRAW
	dc.l	0

	SECTION "_fault__xDRAW:1",DATA

	XDEF	_fault__xDRAW
_fault__xDRAW
	dc.l	0

	SECTION "_vBufPos__xDRAW:1",DATA

	XDEF	_vBufPos__xDRAW
_vBufPos__xDRAW
	dc.l	0

	SECTION "_vArraySize__xDRAW:1",DATA

	XDEF	_vArraySize__xDRAW
_vArraySize__xDRAW
	dc.l	0

	SECTION "_zDepth__xDRAW:1",DATA

	XDEF	_zDepth__xDRAW
_zDepth__xDRAW
	dc.l	$3FF00000,0

	SECTION "_maxVBufPos__xDRAW:1",DATA

	XDEF	_maxVBufPos__xDRAW
_maxVBufPos__xDRAW
	dc.l	0

	SECTION "_currentCol__xDRAW:1",DATA

	XDEF	_currentCol__xDRAW
_currentCol__xDRAW
	dc.l	-$1000000

	SECTION "_cTab__xDRAW:1",DATA

	XDEF	_cTab__xDRAW
_cTab__xDRAW
	dc.l	0,$3B800000,$3C000000,$3C400000,$3C800000,$3CA00000,$3CC00000,$3CE00000,$3D000000,$3D100000,$3D200000
	dc.l	$3D300000,$3D400000,$3D500000,$3D600000,$3D700000,$3D800000,$3D880000,$3D900000,$3D980000,$3DA00000,$3DA80000
	dc.l	$3DB00000,$3DB80000,$3DC00000,$3DC80000,$3DD00000,$3DD80000,$3DE00000,$3DE80000,$3DF00000,$3DF80000,$3E000000
	dc.l	$3E040000,$3E080000,$3E0C0000,$3E100000,$3E140000,$3E180000,$3E1C0000,$3E200000,$3E240000,$3E280000,$3E2C0000
	dc.l	$3E300000,$3E340000,$3E380000,$3E3C0000,$3E400000,$3E440000,$3E480000,$3E4C0000,$3E500000,$3E540000,$3E580000
	dc.l	$3E5C0000,$3E600000,$3E640000,$3E680000,$3E6C0000,$3E700000,$3E740000,$3E780000,$3E7C0000,$3E800000,$3E820000
	dc.l	$3E840000,$3E860000,$3E880000,$3E8A0000,$3E8C0000,$3E8E0000,$3E900000,$3E920000,$3E940000,$3E960000,$3E980000
	dc.l	$3E9A0000,$3E9C0000,$3E9E0000,$3EA00000,$3EA20000,$3EA40000,$3EA60000,$3EA80000,$3EAA0000,$3EAC0000,$3EAE0000
	dc.l	$3EB00000,$3EB20000,$3EB40000,$3EB60000,$3EB80000,$3EBA0000,$3EBC0000,$3EBE0000,$3EC00000,$3EC20000,$3EC40000
	dc.l	$3EC60000,$3EC80000,$3ECA0000,$3ECC0000,$3ECE0000,$3ED00000,$3ED20000,$3ED40000,$3ED60000,$3ED80000,$3EDA0000
	dc.l	$3EDC0000,$3EDE0000,$3EE00000,$3EE20000,$3EE40000,$3EE60000,$3EE80000,$3EEA0000,$3EEC0000,$3EEE0000,$3EF00000
	dc.l	$3EF20000,$3EF40000,$3EF60000,$3EF80000,$3EFA0000,$3EFC0000,$3EFE0000,$3F000000,$3F010000,$3F020000,$3F030000
	dc.l	$3F040000,$3F050000,$3F060000,$3F070000,$3F080000,$3F090000,$3F0A0000,$3F0B0000,$3F0C0000,$3F0D0000,$3F0E0000
	dc.l	$3F0F0000,$3F100000,$3F110000,$3F120000,$3F130000,$3F140000,$3F150000,$3F160000,$3F170000,$3F180000,$3F190000
	dc.l	$3F1A0000,$3F1B0000,$3F1C0000,$3F1D0000,$3F1E0000,$3F1F0000,$3F200000,$3F210000,$3F220000,$3F230000,$3F240000
	dc.l	$3F250000,$3F260000,$3F270000,$3F280000,$3F290000,$3F2A0000,$3F2B0000,$3F2C0000,$3F2D0000,$3F2E0000,$3F2F0000
	dc.l	$3F300000,$3F310000,$3F320000,$3F330000,$3F340000,$3F350000,$3F360000,$3F370000,$3F380000,$3F390000,$3F3A0000
	dc.l	$3F3B0000,$3F3C0000,$3F3D0000,$3F3E0000,$3F3F0000,$3F400000,$3F410000,$3F420000,$3F430000,$3F440000,$3F450000
	dc.l	$3F460000,$3F470000,$3F480000,$3F490000,$3F4A0000,$3F4B0000,$3F4C0000,$3F4D0000,$3F4E0000,$3F4F0000,$3F500000
	dc.l	$3F510000,$3F520000,$3F530000,$3F540000,$3F550000,$3F560000,$3F570000,$3F580000,$3F590000,$3F5A0000,$3F5B0000
	dc.l	$3F5C0000,$3F5D0000,$3F5E0000,$3F5F0000,$3F600000,$3F610000,$3F620000,$3F630000,$3F640000,$3F650000,$3F660000
	dc.l	$3F670000,$3F680000,$3F690000,$3F6A0000,$3F6B0000,$3F6C0000,$3F6D0000,$3F6E0000,$3F6F0000,$3F700000,$3F710000
	dc.l	$3F720000,$3F730000,$3F740000,$3F750000,$3F760000,$3F770000,$3F780000,$3F790000,$3F7A0000,$3F7B0000,$3F7C0000
	dc.l	$3F7D0000,$3F7E0000,$3F7F0000

	SECTION "_sTab__xDRAW:0",CODE


	XDEF	_INIT_8_xDraw_cpp__sTab__xDRAW
_INIT_8_xDraw_cpp__sTab__xDRAW
L237
;float32 xDRAW::sTab[XDRAW_TRIGSIZE+2] = { 0 };
	move.l	#_sTab__xDRAW,a0
	lea	4(a0),a0
	moveq	#$10,d0
L238
	clr.l	(a0)+
	dbra	d0,L238
	rts

	SECTION "_sTab__xDRAW:1",DATA

	XDEF	_sTab__xDRAW
_sTab__xDRAW
	dc.l	0
	ds.b	68

	SECTION "_nestCount__xDRAW:1",DATA

	XDEF	_nestCount__xDRAW
_nestCount__xDRAW
	dc.l	0

	SECTION "Init__xDRAW__Uj:0",CODE


;sint32 xDRAW::Init(uint32 vSize)
	XDEF	Init__xDRAW__Uj
Init__xDRAW__Uj
	movem.l	d2/d3/a6,-(a7)
	move.l	$10(a7),d3
L244
;	if (!DiskfontBase)
	tst.l	_DiskfontBase
	bne.b	L247
L245
;		if (!(DiskfontBase = OpenLibrary("diskfont.library", 39)))
	move.l	_SysBase,a6
	moveq	#$27,d0
	move.l	#L240,a1
	jsr	-$228(a6)
	move.l	d0,_DiskfontBase
	tst.l	_DiskfontBase
	bne.b	L247
L246
;			sysBASELIB::MessageBox("Debug Info", "Proceed", "x
	move.l	#L241,-(a7)
	move.l	#L242,-(a7)
	move.l	#L243,-(a7)
	jsr	MessageBox__sysBASELIB__PcPcPce
	add.w	#$C,a7
	move.l	#-$3050005,d0
	movem.l	(a7)+,d2/d3/a6
	rts
L247
;		fontData[0] = OpenDiskFont(fontInfo);
	move.l	_DiskfontBase,a6
	move.l	#_fontInfo__xDRAW,a0
	jsr	-$1E(a6)
	move.l	#_fontData__xDRAW,a1
	move.l	d0,(a1)
;		fontData[1] = OpenDiskFont(fontInfo+1);
	move.l	#_fontInfo__xDRAW,a1
	move.l	_DiskfontBase,a6
	lea	$8(a1),a0
	jsr	-$1E(a6)
	move.l	#_fontData__xDRAW,a1
	move.l	d0,4(a1)
;		fontData[2] = OpenDiskFont(fontInfo+2);
	move.l	#_fontInfo__xDRAW,a1
	move.l	_DiskfontBase,a6
	lea	$10(a1),a0
	jsr	-$1E(a6)
	move.l	#_fontData__xDRAW,a1
	move.l	d0,$8(a1)
;		fontData[3] = OpenDiskFont(fontInfo+3);
	move.l	#_fontInfo__xDRAW,a1
	move.l	_DiskfontBase,a6
	lea	$18(a1),a0
	jsr	-$1E(a6)
	move.l	#_fontData__xDRAW,a1
	move.l	d0,$C(a1)
;	vArraySize = ClipInt(vSize, 1024, 65536);
	move.l	#$10000,d2
	move.l	#$400,d1
	move.l	d3,d0
	cmp.l	d1,d0
	bge.b	L249
L248
	move.l	d1,d0
	bra.b	L253
L249
	cmp.l	d2,d0
	ble.b	L251
L250
	move.l	d2,d0
L251
L252
L253
	move.l	d0,_vArraySize__xDRAW
;	for (sint32 i = 0;
	moveq	#0,d2
	bra.b	L255
L254
;		sTab[i] = sin(((float64)i*3.1415926536)/(2*XDRAW_TRIGSIZE));
	fmove.l	d2,fp0
	fmul.d	#$.400921FB.20000000,fp0
	fdiv.d	#$.40400000.00000000,fp0
	fmove.d	fp0,-(a7)
	jsr	_sin__r
	addq.w	#$8,a7
	move.l	#_sTab__xDRAW,a1
	fmove.s	fp0,0(a1,d2.l*4)
	addq.l	#1,d2
L255
	cmp.l	#$10,d2
	blt.b	L254
L256
;	sTab[XDRAW_TRIGSIZE]		= 1.0;
	move.l	#_sTab__xDRAW,a1
	move.l	#$3F800000,$40(a1)
;	sTab[XDRAW_TRIGSIZE+1]	= sTab[XDRAW_TRIGSIZE-1];
	move.l	#_sTab__xDRAW,a1
	fmove.s	$3C(a1),fp0
	move.l	#_sTab__xDRAW,a1
	fmove.s	fp0,$44(a1)
;	vBuffer = New(vBuffer, vArraySize);
	move.l	_vArraySize__xDRAW,d2
	clr.w	-(a7)
	move.w	#1,-(a7)
	move.l	d2,d0
	moveq	#6,d1
	asl.l	d1,d0
	addq.l	#$8,d0
	move.l	d0,-(a7)
	jsr	Alloc__MEM__Uiss
	addq.w	#$8,a7
	move.l	d0,a0
	cmp.w	#0,a0
	beq.b	L261
L257
	move.l	d2,(a0)
	move.l	#$40,4(a0)
	addq.w	#$8,a0
	moveq	#0,d0
	bra.b	L259
L258
	addq.l	#1,d0
L259
	cmp.l	d2,d0
	blo.b	L258
L260
	bra.b	L262
L261
	sub.l	a0,a0
L262
	move.l	a0,_vBuffer__xDRAW
;	if (vBuffer==NOTSET)
	move.l	_vBuffer__xDRAW,a0
	cmp.w	#0,a0
	bne.b	L264
L263
	move.l	#-$3030001,d0
	movem.l	(a7)+,d2/d3/a6
	rts
L264
	moveq	#0,d0
	movem.l	(a7)+,d2/d3/a6
	rts

L243
	dc.b	'Debug Info',0
L242
	dc.b	'Proceed',0
L240
	dc.b	'diskfont.library',0
L241
	dc.b	'xDRAW::Init()',$A,'Failed to open diskfont.library',0

	SECTION "Done__xDRAW_:0",CODE


;sint32 xDRAW::Done()
	XDEF	Done__xDRAW_
Done__xDRAW_
	movem.l	d2/a2/a6,-(a7)
L265
;	FreeContext();
	jsr	FreeContext__x3D_
;	if (vBuffer)
	tst.l	_vBuffer__xDRAW
	beq.b	L274
L266
;		Delete(vBuffer);
	move.l	_vBuffer__xDRAW,a6
	cmp.w	#0,a6
	beq.b	L273
L267
	move.l	a6,d0
	subq.l	#$8,d0
	move.l	d0,a2
	moveq	#0,d2
	bra.b	L271
L268
	move.l	d2,d0
	asl.l	#6,d0
	lea	0(a6,d0.l),a0
	cmp.w	#0,a0
	beq.b	L270
L269
	pea	$40.w
	move.l	a0,-(a7)
	jsr	op__delete__PvUi
	addq.w	#$8,a7
L270
	addq.l	#1,d2
L271
	move.l	a2,a0
	cmp.l	(a0),d2
	blo.b	L268
L272
	move.l	a2,-(a7)
	jsr	Free__MEM__Pv
	addq.w	#4,a7
L273
L274
;	vBuffer = 0;
	clr.l	_vBuffer__xDRAW
;	if (DiskfontBase)
	tst.l	_DiskfontBase
	beq.b	L281
L275
;		for (sint32 i=0;
	moveq	#0,d2
	bra.b	L279
L276
;			if (fontData[i]) 
	move.l	#_fontData__xDRAW,a1
	tst.l	0(a1,d2.l*4)
	beq.b	L278
L277
;			if (fontData[i]) CloseFont(fontData[i]);
	move.l	#_fontData__xDRAW,a1
	move.l	_GfxBase,a6
	move.l	0(a1,d2.l*4),a1
	jsr	-$4E(a6)
L278
	addq.l	#1,d2
L279
	cmp.l	#4,d2
	blt.b	L276
L280
;		CloseLibrary(DiskfontBase);
	move.l	_DiskfontBase,a1
	move.l	_SysBase,a6
	jsr	-$19E(a6)
;		DiskfontBase = NOTSET;
	clr.l	_DiskfontBase
L281
	moveq	#0,d0
	movem.l	(a7)+,d2/a2/a6
	rts

	SECTION "AllocDepthBuffer__xDRAW_:0",CODE


;sint32 xDRAW::AllocDepthBuffer()
	XDEF	AllocDepthBuffer__xDRAW_
AllocDepthBuffer__xDRAW_
	move.l	a6,-(a7)
L282
;	if (flags & ZBUFFER)
	move.l	_flags__xDRAW,d0
	and.l	#4,d0
	beq.b	L284
L283
	moveq	#0,d0
	move.l	(a7)+,a6
	rts
L284
;	if (x3D::Context())
	move.l	_context__x3D,a0
	cmp.w	#0,a0
	beq.b	L290
L285
;		uint32 r = W3D_AllocZBuffer(x3D::Context());
	move.l	_context__x3D,a0
	move.l	_Warp3DBase,a6
	jsr	-$D8(a6)
;		switch(r)
	cmp.l	#-$17,d0
	beq.b	L288
	bhi.b	L291
	cmp.l	#0,d0
	beq.b	L286
	bra.b	L289
L291
	cmp.l	#-$8,d0
	beq.b	L287
	bra.b	L289
;			
L286
;			case W3D_SUCCESS:		flags |= ZBUFFER;
	or.l	#4,_flags__xDRAW
	moveq	#0,d0
	move.l	(a7)+,a6
	rts
L287
	move.l	#-$3030001,d0
	move.l	(a7)+,a6
	rts
L288
	move.l	#-$3050005,d0
	move.l	(a7)+,a6
	rts
L289
	move.l	#-$3050008,d0
	move.l	(a7)+,a6
	rts
L290
; 
	move.l	(a7)+,a6
	rts

	SECTION "FreeDepthBuffer__xDRAW_:0",CODE


;sint32 xDRAW::FreeDepthBuffer()
	XDEF	FreeDepthBuffer__xDRAW_
FreeDepthBuffer__xDRAW_
	move.l	a6,-(a7)
L292
;	if (flags & ZBUFFER)
	move.l	_flags__xDRAW,d0
	and.l	#4,d0
	beq.b	L298
L293
;		flags &= ~ZBUFFER;
	and.l	#-5,_flags__xDRAW
;	sint32 n = vsprintf(textBuff
	move.l	_context__x3D,a0
	cmp.w	#0,a0
	beq.b	L298
L294
;			uint32 r = W3D_FreeZBuffer(x3D::Context());
	move.l	_context__x3D,a0
	move.l	_Warp3DBase,a6
	jsr	-$DE(a6)
;			switch(r)
	cmp.l	#0,d0
	beq.b	L295
	cmp.l	#-$17,d0
	beq.b	L296
	bra.b	L297
;				
L295
	moveq	#0,d0
	move.l	(a7)+,a6
	rts
L296
	move.l	#-$3050005,d0
	move.l	(a7)+,a6
	rts
L297
	move.l	#-$3050008,d0
	move.l	(a7)+,a6
	rts
L298
	moveq	#0,d0
	move.l	(a7)+,a6
	rts

	SECTION "Bind__xDRAW__P08xSURFACE:0",CODE


;sint32 xDRAW::Bind(xSURFACE* s)
	XDEF	Bind__xDRAW__P08xSURFACE
Bind__xDRAW__P08xSURFACE
	movem.l	d2/a2/a6,-(a7)
	move.l	$10(a7),a2
L299
;	if (x3D::Context())
	move.l	_context__x3D,a0
	cmp.w	#0,a0
	beq	L306
L300
;		if (!x3D::DrawSurface() || x3D::DrawSurface()->Format()==s->Form
	tst.l	_drawSurface__x3D
	beq.b	L302
L301
	move.l	_drawSurface__x3D,a0
	move.l	$8(a0),a1
	move.l	a0,d0
	add.l	$14(a1),d0
	move.l	d0,-(a7)
	move.l	$10(a1),a1
	jsr	(a1)
	move.l	d0,d2
	addq.w	#4,a7
	move.l	a2,a0
	move.l	$8(a0),a1
	move.l	a0,d0
	add.l	$14(a1),d0
	move.l	d0,-(a7)
	move.l	$10(a1),a1
	jsr	(a1)
	addq.w	#4,a7
	cmp.l	d0,d2
	bne.b	L303
L302
;			W3D_Flush(x3D::Context());
	move.l	_context__x3D,a0
	move.l	_Warp3DBase,a6
	jsr	-$138(a6)
;			x3D::SetDrawArea(s, 0, 0, s->Width(), s->Height());
	move.l	a2,a0
	move.l	$8(a0),a1
	move.l	a0,d0
	add.l	$24(a1),d0
	move.l	d0,-(a7)
	move.l	$20(a1),a1
	jsr	(a1)
	addq.w	#4,a7
	move.w	d0,-(a7)
	move.l	a2,a0
	move.l	$8(a0),a1
	move.l	a0,d0
	add.l	$2C(a1),d0
	move.l	d0,-(a7)
	move.l	$28(a1),a1
	jsr	(a1)
	addq.w	#4,a7
	move.w	d0,-(a7)
	clr.w	-(a7)
	clr.w	-(a7)
	move.l	a2,-(a7)
	jsr	SetDrawArea__x3D__P08xSURFACEssss
	add.w	#$C,a7
	moveq	#0,d0
	movem.l	(a7)+,d2/a2/a6
	rts
L303
;			FreeContext();
	jsr	FreeContext__x3D_
;			if (BuildContext(s,TRUE)==OK)
	move.w	#1,-(a7)
	move.l	a2,-(a7)
	jsr	BuildContext__x3D__P08xSURFACEs
	addq.w	#6,a7
	tst.l	d0
	bne.b	L305
L304
	moveq	#0,d0
	movem.l	(a7)+,d2/a2/a6
	rts
L305
	move.l	#-$3050005,d0
	movem.l	(a7)+,d2/a2/a6
	rts
L306
;		if (BuildContext(s, TRUE)==OK)
	move.w	#1,-(a7)
	move.l	a2,-(a7)
	jsr	BuildContext__x3D__P08xSURFACEs
	addq.w	#6,a7
	tst.l	d0
	bne.b	L308
L307
	moveq	#0,d0
	movem.l	(a7)+,d2/a2/a6
	rts
L308
	move.l	#-$3050005,d0
	movem.l	(a7)+,d2/a2/a6
	rts

	SECTION "Release__xDRAW_:0",CODE


;sint32 xDRAW::Release()
	XDEF	Release__xDRAW_
Release__xDRAW_
	movem.l	a2/a6,-(a7)
L312
;	if (x3D::Context())
	move.l	_context__x3D,a0
	cmp.w	#0,a0
	beq.b	L316
L313
;		if (x3D::DrawSurface())
	move.l	_drawSurface__x3D,a0
	cmp.w	#0,a0
	beq.b	L315
L314
;			W3D_Flush(x3D::Context());
	move.l	_context__x3D,a0
	move.l	_Warp3DBase,a6
	jsr	-$138(a6)
L315
;		W3D_FreeAllTexObj(x3D::Context());
	move.l	_context__x3D,a0
	move.l	_Warp3DBase,a6
	jsr	-$17A(a6)
;		x3D::FreeDrawArea();
	clr.l	_drawRegion__x3D+4
	clr.l	_drawRegion__x3D
	clr.l	_drawRegion__x3D+$8
	clr.l	_drawRegion__x3D+$C
	move.l	_context__x3D,a0
	move.l	_Warp3DBase,a6
	moveq	#0,d1
	sub.l	a1,a1
	move.l	#_drawRegion__x3D,a2
	jsr	-$C0(a6)
L316
;	sysBASELIB::MessageBox("Debug Info","Proceed","xDRAW::
	move.l	_flushCnt__xDRAW,-(a7)
	move.l	_maxVBufPos__xDRAW,-(a7)
	move.l	#L309,-(a7)
	move.l	#L310,-(a7)
	move.l	#L311,-(a7)
	jsr	MessageBox__sysBASELIB__PcPcPce
	add.w	#$14,a7
;	flushCnt = maxVBufPos = 0;
	clr.l	_maxVBufPos__xDRAW
	move.l	_maxVBufPos__xDRAW,_flushCnt__xDRAW
	moveq	#0,d0
	movem.l	(a7)+,a2/a6
	rts

L311
	dc.b	'Debug Info',0
L310
	dc.b	'Proceed',0
L309
	dc.b	'xDRAW::Release()',$A,'Peak vertex count %d',$A,'Vertex buffer flus'
	dc.b	'hed %d times',0

	SECTION "Dump__xDRAW__R07ostreamjj:0",CODE


;void xDRAW::Dump(ostream& out, sint32 s, sint32 r)
	XDEF	Dump__xDRAW__R07ostreamjj
Dump__xDRAW__R07ostreamjj
	movem.l	d2-d4/a2,-(a7)
	movem.l	$18(a7),d3/d4
	move.l	$14(a7),a2
L322
;	for (sint32 i = s;
	move.l	d3,d2
	bra	L324
L323
;		out << "vBuffer[" << i << "] : X,Y,Z = " << vBuffer[i].x << ", "
	move.l	#L317,-(a7)
	move.l	d2,d0
	asl.l	#6,d0
	move.l	_vBuffer__xDRAW,a1
	lea	0(a1,d0.l),a0
	move.l	$2C(a0),-(a7)
	move.l	#L318,-(a7)
	move.l	d2,d0
	asl.l	#6,d0
	move.l	_vBuffer__xDRAW,a1
	lea	0(a1,d0.l),a0
	move.l	$28(a0),-(a7)
	move.l	#L318,-(a7)
	move.l	d2,d0
	asl.l	#6,d0
	move.l	_vBuffer__xDRAW,a1
	lea	0(a1,d0.l),a0
	move.l	$24(a0),-(a7)
	move.l	#L318,-(a7)
	move.l	d2,d0
	asl.l	#6,d0
	move.l	_vBuffer__xDRAW,a1
	lea	0(a1,d0.l),a0
	move.l	$20(a0),-(a7)
	move.l	#L319,-(a7)
	move.l	d2,d0
	asl.l	#6,d0
	move.l	_vBuffer__xDRAW,a1
	move.l	$C(a1,d0.l),-(a7)
	move.l	$8(a1,d0.l),-(a7)
	move.l	#L318,-(a7)
	move.l	d2,d0
	asl.l	#6,d0
	move.l	_vBuffer__xDRAW,a1
	move.l	4(a1,d0.l),-(a7)
	move.l	#L318,-(a7)
	move.l	d2,d0
	asl.l	#6,d0
	move.l	_vBuffer__xDRAW,a1
	move.l	0(a1,d0.l),-(a7)
	move.l	#L320,-(a7)
	move.l	d2,-(a7)
	move.l	#L321,-(a7)
	move.l	a2,-(a7)
	jsr	op__leftshift__ostream__TPCc
	addq.w	#$8,a7
	move.l	d0,-(a7)
	jsr	op__leftshift__ostream__Tj
	addq.w	#$8,a7
	move.l	d0,-(a7)
	jsr	op__leftshift__ostream__TPCc
	addq.w	#$8,a7
	move.l	d0,-(a7)
	jsr	op__leftshift__ostream__Tf
	addq.w	#$8,a7
	move.l	d0,-(a7)
	jsr	op__leftshift__ostream__TPCc
	addq.w	#$8,a7
	move.l	d0,-(a7)
	jsr	op__leftshift__ostream__Tf
	addq.w	#$8,a7
	move.l	d0,-(a7)
	jsr	op__leftshift__ostream__TPCc
	addq.w	#$8,a7
	move.l	d0,-(a7)
	jsr	op__leftshift__ostream__Td
	add.w	#$C,a7
	move.l	d0,-(a7)
	jsr	op__leftshift__ostream__TPCc
	addq.w	#$8,a7
	move.l	d0,-(a7)
	jsr	op__leftshift__ostream__Tf
	addq.w	#$8,a7
	move.l	d0,-(a7)
	jsr	op__leftshift__ostream__TPCc
	addq.w	#$8,a7
	move.l	d0,-(a7)
	jsr	op__leftshift__ostream__Tf
	addq.w	#$8,a7
	move.l	d0,-(a7)
	jsr	op__leftshift__ostream__TPCc
	addq.w	#$8,a7
	move.l	d0,-(a7)
	jsr	op__leftshift__ostream__Tf
	addq.w	#$8,a7
	move.l	d0,-(a7)
	jsr	op__leftshift__ostream__TPCc
	addq.w	#$8,a7
	move.l	d0,-(a7)
	jsr	op__leftshift__ostream__Tf
	addq.w	#$8,a7
	move.l	d0,-(a7)
	jsr	op__leftshift__ostream__TPCc
	addq.w	#$8,a7
	addq.l	#1,d2
L324
	move.l	d3,d0
	add.l	d4,d0
	cmp.l	d0,d2
	blt	L323
L325
	movem.l	(a7)+,d2-d4/a2
	rts

L317
	dc.b	$A,0
L318
	dc.b	', ',0
L319
	dc.b	', R,G,B,A = ',0
L320
	dc.b	'] : X,Y,Z = ',0
L321
	dc.b	'vBuffer[',0

	SECTION "SimpleText__xDRAW__UjUjPce:0",CODE


;void xDRAW::SimpleText(ICOORD2D c, uint32 font, char* text,...)
	XDEF	SimpleText__xDRAW__UjUjPce
SimpleText__xDRAW__UjUjPce
L333	EQU	-$8
	link	a5,#L333
	movem.l	d2-d4/a6,-(a7)
	movem.l	$8(a5),d3/d4
L326
;	if (!x3D::DrawSurface() || !x3D::DrawSurface()->rPort || !text)
	tst.l	_drawSurface__x3D
	beq.b	L329
L327
	move.l	_drawSurface__x3D,a0
	tst.l	$C(a0)
	beq.b	L329
L328
	tst.l	$10(a5)
	bne.b	L330
L329
	movem.l	(a7)+,d2-d4/a6
	unlk	a5
	rts
L330
;	va_start(arglist,text)
	lea	$10(a5),a0
	move.l	a0,d0
	addq.l	#4,d0
;	sint32 n = vsprintf(textBuffer,text,arglist);
	move.l	d0,-(a7)
	move.l	$10(a5),-(a7)
	move.l	#_textBuffer__SimpleText__xDRAW__UjUjPce,-(a7)
	jsr	_vsprintf
	add.w	#$C,a7
	move.l	d0,d2
;	if (n<0)
	bpl.b	L332
L331
	movem.l	(a7)+,d2-d4/a6
	unlk	a5
	rts
L332
;	::SetFont(x3D::DrawSurface()->rPort, fontData[font]);
	move.l	#_fontData__xDRAW,a1
	move.l	0(a1,d4.l*4),a0
	move.l	_drawSurface__x3D,a1
	move.l	_GfxBase,a6
	move.l	$C(a1),a1
	jsr	-$42(a6)
;	::Move(x3D::DrawSurface()->rPort, CoordX(c), CoordY(c));
	move.l	d3,d1
	and.l	#$FFFF,d1
	ext.l	d1
	move.l	d3,d0
	moveq	#$10,d3
	asr.l	d3,d0
	ext.l	d0
	move.l	_drawSurface__x3D,a0
	move.l	_GfxBase,a6
	move.l	$C(a0),a1
	jsr	-$F0(a6)
;	::Text(x3D::DrawSurface()->rPort, textBuffer, n);
	move.l	_drawSurface__x3D,a0
	move.l	$C(a0),a1
	move.l	_GfxBase,a6
	move.l	d2,d0
	move.l	#_textBuffer__SimpleText__xDRAW__UjUjPce,a0
	jsr	-$3C(a6)
	movem.l	(a7)+,d2-d4/a6
	unlk	a5
	rts

	SECTION "SimpleText__xDRAW__UjUjPce:2",BSS

_textBuffer__SimpleText__xDRAW__UjUjPce
	ds.b	256

	END
