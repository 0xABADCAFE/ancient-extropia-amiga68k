
; Storm C Compiler
; Mendoza:Extropia/eXtropia/prj/AXON/Cell.cpp
	mc68030
	mc68881
	XREF	_0dt__BUILDING__T
	XREF	Render__BUILDING__TR04VIEW
	XREF	Place__BUILDING__TRC05VEC3Dfsss
	XREF	_0dt__PINETREE__T
	XREF	Render__PINETREE__TR04VIEW
	XREF	Place__PINETREE__TRC05VEC3Dfsss
	XREF	Render__RGBCUBE__TR04VIEW
	XREF	Place__RGBCUBE__TRC05VEC3Dfsss
	XREF	Render__MODEL__TR04VIEW
	XREF	Rotate__MODEL__Tsss
	XREF	Move__MODEL__TRC05VEC3D
	XREF	Place__MODEL__TRC05VEC3Dfsss
	XREF	ClipBox__MODEL__T
	XREF	_0dt__VIEW__T
	XREF	Transform__VIEW__TP03C3DP10W3D_VertexUj
	XREF	Close__VIEW__T
	XREF	Open__VIEW__T
	XREF	MoveEvent__VIEW__T
	XREF	ResizeEvent__VIEW__T
	XREF	ExitEvent__VIEW__T
	XREF	KeyEvent__VIEW__Tjs
	XREF	MouseEvent__VIEW__Tjjj
	XREF	op__multAsgn__TRANSFORM__TRC09TRANSFORM
	XREF	Rotate__TRANSFORM__Tfff
	XREF	Define__PLANE__TP03C3DP03C3DP03C3D
	XREF	Define__PLANE__TP05VEC3DP05VEC3DP05VEC3D
	XREF	_fabs__r
	XREF	_sqrt__r
	XREF	Delete__xTEXTURE__T
	XREF	Create__xTEXTURE__TsssPvPUj
	XREF	Close__xDBWIN__T
	XREF	Open__xDBWIN__T
	XREF	Set__xDBWIN__TsssssPCc
	XREF	Idle__xDISPLAYIO_ASYNC__T
	XREF	Done__xDISPLAYIO_ASYNC__T
	XREF	Init__xDISPLAYIO_ASYNC__T
	XREF	MoveEvent__xDISPLAYIO__T
	XREF	ResizeEvent__xDISPLAYIO__T
	XREF	Idle__xDISPLAYIO__T
	XREF	HandleEvent__xDISPLAYIO__T
	XREF	ApplyInputModification__xDISPLAYIO__T
	XREF	ViewSurface__xDISPLAY__T
	XREF	DrawSurface__xDISPLAY__T
	XREF	Refresh__xDISPLAY__T
	XREF	Close__xDISPLAY__T
	XREF	Open__xDISPLAY__T
	XREF	_0dt__xSURFACE__T
	XREF	_0dt__POOL_ST__T
	XREF	_0ct__POOL_ST__TUsUj
	XREF	FreeT__POOL_ST__TPv
	XREF	NewT__POOL_ST__TPvUs
	XREF	NewT__POOL_ST__TPv
	XREF	Create__POOL_ST__TUsUj
	XREF	PrintAlloc__POOL_ST__TR07ostreamjj
	XREF	_0dt__POOL_LT__T
	XREF	Close__xFILEIO__T
	XREF	Write__xFILEIO__TPvUiUi
	XREF	Read__xFILEIO__TPvUiUi
	XREF	Open__xFILEIO__TPCcjj
	XREF	SendPacket__xFILEIO__TPv
	XREF	WaitPacket__xFILEIO__T
	XREF	InputQueued__xINPUT__T
	XREF	Idle__xINPUT__T
	XREF	ExitEvent__xINPUT__T
	XREF	KeyEvent__xINPUT__Tjs
	XREF	MouseEvent__xINPUT__Tjjj
	XREF	ApplyInputModification__xINPUT__T
	XREF	UnLink__xCHAINABLE__T
	XREF	_0ct__xTHREADABLE__TPCcUjjs
	XREF	ShutDown__xTHREADABLE__T
	XREF	Done__xTHREADABLE__T
	XREF	Init__xTHREADABLE__T
	XREF	_0dt__xLOCKABLE__T
	XREF	FreeLock__xLOCKABLE__Ts
	XREF	WaitLock__xLOCKABLE__T
	XREF	_0dt__sysRTLIB__T
	XREF	MessageBox__sysBASELIB__PcPcPce
	XREF	_system
	XREF	op__leftshift__ostream__Td
	XREF	op__leftshift__ostream__TUj
	XREF	op__leftshift__ostream__Tj
	XREF	op__leftshift__ostream__TPCc
	XREF	op__leftshift__ostream__Tc
	XREF	opfx__ostream__T
	XREF	read__istream__TPci
	XREF	get__istream__TRc
	XREF	getline__istream__TPcic
	XREF	get__istream__TPcic
	XREF	op__rightshift__istream__TRc
	XREF	op__rightshift__istream__TPc
	XREF	doallocate__streambuf__T
	XREF	xsgetn__streambuf__TPci
	XREF	xsputn__streambuf__TPCci
	XREF	underflow__streambuf__T
	XREF	overflow__streambuf__Ti
	XREF	setbuf__streambuf__TPcUi
	XREF	sputn__streambuf__TPCci
	XREF	_0dt__streambuf__T
	XREF	userword__ios__Ti
	XREF	init__ios__TP09streambuf
	XREF	_sprintf
	XREF	_memset
	XREF	_memmove
	XREF	_strncpy
	XREF	_std__in
	XREF	_std__out
	XREF	_std__err
	XREF	_basefield__ios
	XREF	_adjustfield__ios
	XREF	_floatfield__ios
	XREF	_aNextBit__ios
	XREF	_aNextWord__ios
	XREF	_cin
	XREF	_cout
	XREF	_cerr
	XREF	_clog
	XREF	_st
	XREF	_gxSt
	XREF	_errBuff__xBASELIB
	XREF	_errSev__xBASELIB
	XREF	_errTbl__xBASELIB
	XREF	_SysBase
	XREF	_IntuitionBase
	XREF	_DOSBase
	XREF	_sysData__sysBASELIB
	XREF	_msgbuff__sysBASELIB
	XREF	_main__sysBASELIB
	XREF	_allocated__MEM
	XREF	_totSize__MEM
	XREF	_nextFree__MEM
	XREF	_cnt__MEM
	XREF	_maxAllocs__MEM
	XREF	_GfxBase
	XREF	_TimerBase
	XREF	_TimerBase__xTIMABLE
	XREF	_current__xTIMABLE
	XREF	_clockFreq__xTIMABLE
	XREF	_threadCnt__xTHREADABLE
	XREF	_main__xTHREADABLE
	XREF	_CyberGfxBase
	XREF	_Warp3DBase
	XREF	_graphics__x2D
	XREF	_cyberGfx__x2D
	XREF	_formatNames__x2D
	XREF	_surfaceTypes__x2D
	XREF	_warp3D__x3D
	XREF	_hw3D__x3D
	XREF	_pointRender__x3D
	XREF	_lineRender__x3D
	XREF	_triangleRender__x3D
	XREF	_otherPrimitives__x3D
	XREF	_shadingModes__x3D
	XREF	_textureModes__x3D
	XREF	_textureFmts__x3D
	XREF	_alpha__x3D
	XREF	_fogModes__x3D
	XREF	_zBuffer__x3D
	XREF	_stencil__x3D
	XREF	_misc__x3D
	XREF	_primNames__x3D
	XREF	_renderNames__x3D
	XREF	_shadingNames__x3D
	XREF	_texModeNames__x3D
	XREF	_texFormatNames__x3D
	XREF	_alphaNames__x3D
	XREF	_fogNames__x3D
	XREF	_zBufferNames__x3D
	XREF	_stencilNames__x3D
	XREF	_miscNames__x3D
	XREF	_drawSurface__x3D
	XREF	_context__x3D
	XREF	_drawRegion__x3D
	XREF	_fogData__x3D
	XREF	_flags__xGFX
	XREF	_mode__xGFX
	XREF	_numModes__xGFX
	XREF	_rPool__xSURFACE
	XREF	_DiskfontBase
	XREF	_fontInfo__xDRAW
	XREF	_fontData__xDRAW
	XREF	_fonts__xDRAW
	XREF	_flags__xDRAW
	XREF	_flushCnt__xDRAW
	XREF	_cTab__xDRAW
	XREF	_sTab__xDRAW
	XREF	_fault__xDRAW
	XREF	_vBufPos__xDRAW
	XREF	_zDepth__xDRAW
	XREF	_maxVBufPos__xDRAW
	XREF	_vArraySize__xDRAW
	XREF	_vArray__xDRAW
	XREF	_vBuffer__xDRAW
	XREF	_nestCount__xDRAW
	XREF	_currentCol__xDRAW
	XREF	_sineData__QTRIG
	XREF	_gradData__QTRIG
	XREF	_vCachePtr__AXON
	XREF	_vCache__AXON
	XREF	_heap__TEXTUREHEAP
	XREF	_keys__TEXTUREHEAP
	XREF	_index__TEXTUREHEAP
	XREF	_heapSize__TEXTUREHEAP
	XREF	_lastTexture__TEXTUREHEAP
	XREF	_lastKey__TEXTUREHEAP
	XREF	_dimension__WORLDMAP
	XREF	_logDim__WORLDMAP
	XREF	_fracLimit__WORLDMAP
	XREF	_worldGrid__WORLDMAP
	XREF	_minZ__WORLDMAP
	XREF	_maxZ__WORLDMAP
	XREF	_floodLevel__WORLDMAP
	XREF	_scale__WORLDMAP
	XREF	_unitName__WORLDMAP
	XREF	_detailLevel__WORLDMAP
	XREF	_cell__WORLDMAP
	XREF	_visible__WORLDMAP
	XREF	_wet__WORLDMAP
	XREF	_things__WORLDMAP
	XREF	_frames__WORLDMAP
	XREF	_frameTime__WORLDMAP
	XREF	_totalTime__WORLDMAP
	XREF	_stopWatch__WORLDMAP
	XREF	_ground__WORLDMAP
	XREF	_water__WORLDMAP
	XREF	_count__PINETREE
	XREF	_texture__PINETREE
	XREF	_points__PINETREE
	XREF	_count__BUILDING
	XREF	_texture__BUILDING
	XREF	_points__BUILDING

	SECTION "_0ct__streampos__T:0",CODE

	rts

	SECTION "_0ct__MAPCELL__T:0",CODE


;MAPCELL::MAPCELL() 
	XDEF	_0ct__MAPCELL__T
_0ct__MAPCELL__T
	move.l	4(a7),a0
L320
	clr.l	(a0)
	move.l	#4,4(a0)
	clr.l	$8(a0)
	clr.l	$C(a0)
	clr.l	$10(a0)
	clr.l	$14(a0)
	lea	$18(a0),a1
	moveq	#4,d0
L321
	add.w	#$18,a1
	subq.l	#1,d0
	tst.l	d0
	bpl.b	L321
L322
	add.w	#$90,a0
	moveq	#1,d0
L323
	add.w	#$28,a0
	subq.l	#1,d0
	tst.l	d0
	bpl.b	L323
L324
;MAPCELL::MAPCELL() 
	rts

	SECTION "_0dt__MAPCELL__T:0",CODE


;MAPCELL::~MAPCELL()
	XDEF	_0dt__MAPCELL__T
_0dt__MAPCELL__T
	move.l	4(a7),a0
L325
;MAPCELL::~MAPCELL()
	add.w	#$90,a0
	moveq	#1,d0
L326
	add.w	#$28,a0
	subq.l	#1,d0
	tst.l	d0
	bpl.b	L326
L327
	rts

	SECTION "Set__MAPCELL__TR03C3DR03C3DR03C3DR03C3DUjP08xTEXTUREP08xTEXTURE:0",CODE


;void MAPCELL::Set(C3D& tl, C3D& tr, C3D& br, C3D& bl, uint32 c, xTEX
	XDEF	Set__MAPCELL__TR03C3DR03C3DR03C3DR03C3DUjP08xTEXTUREP08xTEXTURE
Set__MAPCELL__TR03C3DR03C3DR03C3DR03C3DUjP08xTEXTUREP08xTEXTURE
L334	EQU	-$10
	link	a5,#L334
	movem.l	d2/a2/a3/a6,-(a7)
	fmovem.x fp2,-(a7)
	move.l	$1C(a5),d2
	move.l	$8(a5),a2
	move.l	$18(a5),a3
	move.l	$10(a5),a6
L328
;	data[0].x = (tl.x + tr.x)/2F;
	move.l	$C(a5),a0
	fmove.s	(a0),fp0
	move.l	a6,a0
	fadd.s	(a0),fp0
	fdiv.s	#$.40000000,fp0
	fmove.s	fp0,$18(a2)
;	data[0].y = (tl.y + bl.y)/2F;
	move.l	$C(a5),a0
	fmove.s	4(a0),fp0
	move.l	a3,a0
	fadd.s	4(a0),fp0
	fdiv.s	#$.40000000,fp0
	fmove.s	fp0,$1C(a2)
;	data[0].z = tr.z + bl.z / 2F;
	move.l	a6,a0
	fmove.s	$8(a0),fp0
	move.l	a3,a0
	fmove.s	$8(a0),fp1
	fdiv.s	#$.40000000,fp1
	fadd.x	fp1,fp0
	fmove.s	fp0,$20(a2)
;	data[0].u = 2F*d->Width();
	move.l	$24(a5),a0
	move.l	$8(a0),a1
	move.l	a0,d0
	add.l	$2C(a1),d0
	move.l	d0,-(a7)
	move.l	$28(a1),a1
	jsr	(a1)
	addq.w	#4,a7
	fmove.l	d0,fp0
	fmul.s	#$.40000000,fp0
	fmove.s	fp0,$24(a2)
;	data[0].v = 2F*d->Height();
	move.l	$24(a5),a0
	move.l	$8(a0),a1
	move.l	a0,d0
	add.l	$24(a1),d0
	move.l	d0,-(a7)
	move.l	$20(a1),a1
	jsr	(a1)
	addq.w	#4,a7
	fmove.l	d0,fp0
	fmul.s	#$.40000000,fp0
	fmove.s	fp0,$28(a2)
;	data[0].c = c;
	move.l	d2,$2C(a2)
;	data[1] = tl;
	move.l	$C(a5),a1
	lea	$18(a2),a0
	add.w	#$18,a0
	move.l	(a1),(a0)
	move.l	4(a1),4(a0)
	move.l	$8(a1),$8(a0)
	move.l	$C(a1),$C(a0)
	move.l	$10(a1),$10(a0)
	move.l	$14(a1),$14(a0)
;	data[2] = bl;
	move.l	a3,a1
	lea	$18(a2),a0
	add.w	#$30,a0
	move.l	(a1),(a0)
	move.l	4(a1),4(a0)
	move.l	$8(a1),$8(a0)
	move.l	$C(a1),$C(a0)
	move.l	$10(a1),$10(a0)
	move.l	$14(a1),$14(a0)
;	data[3] = tr;
	move.l	a6,a1
	lea	$18(a2),a0
	add.w	#$48,a0
	move.l	(a1),(a0)
	move.l	4(a1),4(a0)
	move.l	$8(a1),$8(a0)
	move.l	$C(a1),$C(a0)
	move.l	$10(a1),$10(a0)
	move.l	$14(a1),$14(a0)
;	data[4] = br;
	move.l	$14(a5),a1
	lea	$18(a2),a0
	add.w	#$60,a0
	move.l	(a1),(a0)
	move.l	4(a1),4(a0)
	move.l	$8(a1),$8(a0)
	move.l	$C(a1),$C(a0)
	move.l	$10(a1),$10(a0)
	move.l	$14(a1),$14(a0)
;	plane[0].Define(tl, bl, tr);
	move.l	a6,-(a7)
	move.l	a3,-(a7)
	move.l	$C(a5),-(a7)
	pea	$90(a2)
	jsr	Define__PLANE__TP03C3DP03C3DP03C3D
	add.w	#$10,a7
;	plane[1].Define(br, tr, bl);
	move.l	a3,-$10(a5)
	lea	$90(a2),a0
	move.l	-$10(a5),-(a7)
	pea	(a6)
	move.l	$14(a5),-(a7)
	pea	$28(a0)
	jsr	Define__PLANE__TP03C3DP03C3DP03C3D
	add.w	#$10,a7
;	tex = t->TexHandle();
	move.l	$20(a5),a0
	move.l	$10(a0),$10(a2)
;	detail = d->TexHandle();
	move.l	$24(a5),a0
	move.l	$10(a0),$14(a2)
;	for(sint32 i=0;
	moveq	#0,d0
	bra.b	L332
L329
;	
;		if (data[i].z < WORLDMAP::SeaLevel())
	lea	$18(a2),a0
	move.l	d0,d1
	muls.l	#$18,d1
	fmove.s	_floodLevel__WORLDMAP,fp0
	fmove.s	$8(a0,d1.l),fp1
	fcmp.x	fp0,fp1
	fboge.b	L331
L330
;			flags |= WATER;
	or.l	#$10,(a2)
L331
	addq.l	#1,d0
L332
	cmp.l	#5,d0
	blt.b	L329
L333
	fmovem.x (a7)+,fp2
	movem.l	(a7)+,d2/a2/a3/a6
	unlk	a5
	rts

	SECTION "FindPlane__MAPCELL__TRC05VEC3D:0",CODE


;sint32 MAPCELL::FindPlane(const VEC3D& p)
	XDEF	FindPlane__MAPCELL__TRC05VEC3D
FindPlane__MAPCELL__TRC05VEC3D
	move.l	a2,-(a7)
	fmovem.x fp2,-(a7)
	movem.l	$14(a7),a0/a1
L336
;	if (p.x < data[1].x || p.y > data[1].y || p.x > data[4].x || p.y <
	fmove.s	(a1),fp1
	lea	$18(a0),a2
	fcmp.s	$18(a2),fp1
	fbolt.b	L340
L337
	lea	$18(a0),a2
	fmove.s	4(a1),fp1
	fcmp.s	$1C(a2),fp1
	fbogt.b	L340
L338
	fmove.s	(a1),fp1
	lea	$18(a0),a2
	fcmp.s	$60(a2),fp1
	fbogt.b	L340
L339
	lea	$18(a0),a2
	fmove.s	4(a1),fp1
	fcmp.s	$64(a2),fp1
	fboge.b	L343
L340
;	
;		cout << "MAPCELL::FindPlane() : Point outside cell\n";
	move.l	#L335,-(a7)
	move.l	_cout,a0
	cmp.w	#0,a0
	beq.b	L342
L341
	addq.w	#4,a0
L342
	move.l	a0,-(a7)
	jsr	op__leftshift__ostream__TPCc
	addq.w	#$8,a7
	move.l	#-$3010000,d0
	fmovem.x (a7)+,fp2
	move.l	(a7)+,a2
	rts
L343
	lea	$18(a0),a2
	fmove.s	4(a1),fp1
	fsub.s	$64(a2),fp1
	lea	$18(a0),a0
	fmove.s	(a1),fp0
	fsub.s	$18(a0),fp0
	fcmp.x	fp0,fp1
	fboge.b	L345
L344
	moveq	#1,d0
	bra.b	L346
L345
	moveq	#0,d0
L346
	fmovem.x (a7)+,fp2
	move.l	(a7)+,a2
	rts

L335
	dc.b	'MAPCELL::FindPlane() : Point outside cell',$A,0

	SECTION "DropToFloor__MAPCELL__TR05VEC3D:0",CODE


;sint32 MAPCELL::DropToFloor(VEC3D& c)
	XDEF	DropToFloor__MAPCELL__TR05VEC3D
DropToFloor__MAPCELL__TR05VEC3D
	movem.l	a2/a3,-(a7)
	fmovem.x fp2,-(a7)
	movem.l	$18(a7),a2/a3
L347
;	sint32 p = FindPlane(c);
	move.l	a3,-(a7)
	move.l	a2,-(a7)
	jsr	FindPlane__MAPCELL__TRC05VEC3D
	addq.w	#$8,a7
;	if (p!=ERR_VALUE)
	cmp.l	#-$3010000,d0
	beq.b	L349
L348
;	
;		plane[p].ZForXY(c);
	move.l	a3,a1
	lea	$90(a2),a0
	muls.l	#$28,d0
	add.l	d0,a0
	fmove.s	(a1),fp1
	fmove.s	$1C(a0),fp0
	fmul.x	fp1,fp0
	fmove.s	$20(a0),fp1
	fmul.s	4(a1),fp1
	fadd.x	fp1,fp0
	fadd.s	$24(a0),fp0
	fmove.s	fp0,$8(a1)
	moveq	#0,d0
	fmovem.x (a7)+,fp2
	movem.l	(a7)+,a2/a3
	rts
L349
	move.l	#-$3010000,d0
	fmovem.x (a7)+,fp2
	movem.l	(a7)+,a2/a3
	rts

	SECTION "Topology__MAPCELL___r_T:0",CODE


;float32 MAPCELL::Topology()
	XDEF	Topology__MAPCELL___r_T
Topology__MAPCELL___r_T
	move.l	a2,-(a7)
	fmovem.x fp2/fp3,-(a7)
	move.l	$20(a7),a2
L350
;	float32 z_average = (data[1].z + data[2].z + data[3].z + data[4].z)
	lea	$18(a2),a0
	fmove.s	$20(a0),fp2
	lea	$18(a2),a0
	fadd.s	$38(a0),fp2
	lea	$18(a2),a0
	fadd.s	$50(a0),fp2
	lea	$18(a2),a0
	fadd.s	$68(a0),fp2
	fdiv.s	#$.40800000,fp2
;	float32 dz = fabs(data[1].z-z_average) + fabs(data[2].z-z_average)
	lea	$18(a2),a0
	fmove.s	$20(a0),fp0
	fsub.x	fp2,fp0
	fmove.d	fp0,-(a7)
	jsr	_fabs__r
	fmove.x	fp0,fp3
	addq.w	#$8,a7
	lea	$18(a2),a0
	fmove.s	$38(a0),fp0
	fsub.x	fp2,fp0
	fmove.d	fp0,-(a7)
	jsr	_fabs__r
	addq.w	#$8,a7
	fadd.x	fp0,fp3
	lea	$18(a2),a0
	fmove.s	$50(a0),fp0
	fsub.x	fp2,fp0
	fmove.d	fp0,-(a7)
	jsr	_fabs__r
	addq.w	#$8,a7
	fadd.x	fp0,fp3
	lea	$18(a2),a0
	fmove.s	$68(a0),fp0
	fsub.x	fp2,fp0
	fmove.d	fp0,-(a7)
	jsr	_fabs__r
	addq.w	#$8,a7
	fadd.x	fp3,fp0
	fdiv.s	#$.40800000,fp0
	fmovem.x (a7)+,fp2/fp3
	move.l	(a7)+,a2
	rts

	SECTION "AddThing__MAPCELL__TR05MODELfffsss:0",CODE


;bool MAPCELL::AddThing(MODEL& t, float32 px, float32 py, float32 s, 
	XDEF	AddThing__MAPCELL__TR05MODELfffsss
AddThing__MAPCELL__TR05MODELfffsss
L367	EQU	-$C
	link	a5,#L367
	movem.l	d2-d4/a2/a3,-(a7)
	fmovem.x fp2/fp3/fp4/fp5/fp6,-(a7)
	movem.l	$8(a5),a0/a2
	move.w	$1C(a5),d2
	move.w	$1E(a5),d3
	move.w	$20(a5),d4
	fmove.s	$14(a5),fp3
	fmove.s	$18(a5),fp5
	fmove.s	$10(a5),fp6
L351
;	if (thing || flags & WATER)
	tst.l	$C(a0)
	bne.b	L353
L352
	move.l	(a0),d0
	and.l	#$10,d0
	beq.b	L354
L353
	moveq	#0,d0
	fmovem.x (a7)+,fp2/fp3/fp4/fp5/fp6
	movem.l	(a7)+,d2-d4/a2/a3
	unlk	a5
	rts
L354
;	thing = &t;
	move.l	a2,$C(a0)
;	VEC3D newpos(ClipFloat(px+data[1].x, data[1].x, data[4].x), 
	lea	-$C(a5),a1
	fmove.s	#$.00000000,fp4
	moveq	#$18,d0
	add.l	a0,d0
	moveq	#$18,d1
	add.l	d0,d1
	move.l	d1,a3
	fmove.s	4(a3),fp2
	moveq	#$18,d0
	add.l	a0,d0
	moveq	#$60,d1
	add.l	d0,d1
	move.l	d1,a3
	fmove.s	4(a3),fp1
	moveq	#$18,d0
	add.l	a0,d0
	moveq	#$60,d1
	add.l	d0,d1
	move.l	d1,a3
	fmove.s	4(a3),fp0
	fadd.x	fp3,fp0
	fcmp.x	fp1,fp0
	fboge.b	L356
L355
	bra.b	L360
L356
	fcmp.x	fp2,fp0
	fbole.b	L358
L357
	fmove.x	fp2,fp1
	bra.b	L359
L358
	fmove.x	fp0,fp1
L359
L360
	moveq	#$18,d0
	add.l	a0,d0
	moveq	#$60,d1
	add.l	d0,d1
	move.l	d1,a3
	fmove.s	(a3),fp3
	moveq	#$18,d0
	add.l	a0,d0
	moveq	#$18,d1
	add.l	d0,d1
	move.l	d1,a3
	fmove.s	(a3),fp2
	moveq	#$18,d0
	add.l	a0,d0
	moveq	#$18,d1
	add.l	d0,d1
	move.l	d1,a3
	fmove.s	(a3),fp0
	fadd.x	fp6,fp0
	fcmp.x	fp2,fp0
	fboge.b	L362
L361
	fmove.x	fp2,fp0
	bra.b	L366
L362
	fcmp.x	fp3,fp0
	fbole.b	L364
L363
	fmove.x	fp3,fp0
L364
L365
L366
	fmove.s	fp0,(a1)
	fmove.s	fp1,4(a1)
	fmove.s	fp4,$8(a1)
;	DropToFloor(newpos);
	pea	-$C(a5)
	move.l	a0,-(a7)
	jsr	DropToFloor__MAPCELL__TR05VEC3D
	addq.w	#$8,a7
;	t.Place(newpos, s, rx, ry, rz);
	move.w	d4,-(a7)
	move.w	d3,-(a7)
	move.w	d2,-(a7)
	fmove.s	fp5,-(a7)
	pea	-$C(a5)
	move.l	$8C(a2),a0
	move.l	a2,d0
	add.l	$2C(a0),d0
	move.l	d0,-(a7)
	move.l	$28(a0),a0
	jsr	(a0)
	add.w	#$12,a7
	moveq	#1,d0
	fmovem.x (a7)+,fp2/fp3/fp4/fp5/fp6
	movem.l	(a7)+,d2-d4/a2/a3
	unlk	a5
	rts

	SECTION "Visibility__MAPCELL__TR04VIEW:0",CODE


;bool MAPCELL::Visibility(VIEW& view)
	XDEF	Visibility__MAPCELL__TR04VIEW
Visibility__MAPCELL__TR04VIEW
	movem.l	d2/d3/a2/a3,-(a7)
	fmovem.x fp2/fp3/fp4/fp5/fp6,-(a7)
	move.l	$54(a7),a1
	move.l	$50(a7),a2
L369
; c |= b;
;	flags &= ~VIS;
	and.l	#-$10,(a2)
;	sint16 numVerts = (flags & WATER) ? (2*points)+4 : (2*points);
	move.l	(a2),d0
	and.l	#$10,d0
	beq.b	L371
L370
	move.l	4(a2),d0
	moveq	#1,d1
	asl.l	d1,d0
	addq.l	#4,d0
	bra.b	L372
L371
	move.l	4(a2),d0
	moveq	#1,d1
	asl.l	d1,d0
L372
	move.w	d0,d1
;	float32 c = QTRIG::CosI(view.Pitch());
	move.w	$186(a1),d0
	ext.l	d0
	cmp.l	#$5A,d0
	bhs.b	L374
L373
	bra.b	L381
L374
	cmp.l	#$B4,d0
	bhs.b	L376
L375
	bra.b	L381
L376
	cmp.l	#$10E,d0
	bhs.b	L378
L377
	bra.b	L381
L378
	cmp.l	#$168,d0
L379
L380
L381
;	if (view.State(VIEW::BOUNDS_PERP))
	move.l	#$10000,d0
	and.l	$180(a1),d0
	beq	L395
L382
;	
;		rsint32 i = 0;
	moveq	#0,d0
;		while (++i<5)
	bra	L393
L383
;		
;			rfloat32 x = data[i].x;
	lea	$18(a2),a0
	move.l	d0,d2
	muls.l	#$18,d2
	fmove.s	0(a0,d2.l),fp1
;			rfloat32 y = data[i].y;
	lea	$18(a2),a0
	move.l	d0,d2
	muls.l	#$18,d2
	fmove.s	4(a0,d2.l),fp0
;			if (x >= view.BTL().x && y <= view.BTL().y && x <= view.BBR().
	fcmp.s	$160(a1),fp1
	fbolt.b	L393
L384
	fcmp.s	$164(a1),fp0
	fbogt.b	L393
L385
	fcmp.s	$16C(a1),fp1
	fbogt.b	L393
L386
	fcmp.s	$170(a1),fp0
	fbolt.b	L393
L387
;			
;				flags |= VIS;
	or.l	#$F,(a2)
;				projected = CachedVertices(numVerts);
	move.w	d1,d0
	ext.l	d0
	move.l	d0,d1
	add.l	_vCachePtr__AXON,d1
	cmp.l	#$4000,d1
	bls.b	L391
L388
	move.l	#L368,-(a7)
	move.l	_cout,a0
	cmp.w	#0,a0
	beq.b	L390
L389
	addq.w	#4,a0
L390
	move.l	a0,-(a7)
	jsr	op__leftshift__ostream__TPCc
	addq.w	#$8,a7
	sub.l	a0,a0
	bra.b	L392
L391
	move.l	_vCachePtr__AXON,d1
	asl.l	#6,d1
	move.l	_vCache__AXON,a1
	lea	0(a1,d1.l),a0
	add.l	d0,_vCachePtr__AXON
L392
	move.l	a0,$8(a2)
	moveq	#1,d0
	fmovem.x (a7)+,fp2/fp3/fp4/fp5/fp6
	movem.l	(a7)+,d2/d3/a2/a3
	rts
L393
	addq.l	#1,d0
	cmp.l	#5,d0
	blt	L383
L394
;				return 
;		projected = NOTSET;
	clr.l	$8(a2)
	moveq	#0,d0
	fmovem.x (a7)+,fp2/fp3/fp4/fp5/fp6
	movem.l	(a7)+,d2/d3/a2/a3
	rts
L395
;	
;		register VEC3D* vp = view.projected;
	lea	$118(a1),a0
;		
;			rsint32 i = 0;
	moveq	#0,d0
;			while (i<4)
	bra	L407
L396
;			
;				if (vp[i].x >= data[1].x && vp[i].y <= data[1].y && vp[i].x 
	move.l	d0,d2
	muls.l	#$C,d2
	add.l	a0,d2
	move.l	d2,a3
	fmove.s	(a3),fp1
	moveq	#$18,d2
	add.l	a2,d2
	moveq	#$18,d3
	add.l	d2,d3
	move.l	d3,a3
	fcmp.s	(a3),fp1
	fbolt.b	L406
L397
	move.l	d0,d2
	muls.l	#$C,d2
	add.l	a0,d2
	move.l	d2,a3
	fmove.s	4(a3),fp1
	moveq	#$18,d2
	add.l	a2,d2
	moveq	#$18,d3
	add.l	d2,d3
	move.l	d3,a3
	fcmp.s	4(a3),fp1
	fbogt.b	L406
L398
	move.l	d0,d2
	muls.l	#$C,d2
	add.l	a0,d2
	move.l	d2,a3
	fmove.s	(a3),fp1
	moveq	#$18,d2
	add.l	a2,d2
	moveq	#$60,d3
	add.l	d2,d3
	move.l	d3,a3
	fcmp.s	(a3),fp1
	fbogt.b	L406
L399
	move.l	d0,d2
	muls.l	#$C,d2
	add.l	a0,d2
	move.l	d2,a3
	fmove.s	4(a3),fp1
	moveq	#$18,d2
	add.l	a2,d2
	moveq	#$60,d3
	add.l	d2,d3
	move.l	d3,a3
	fcmp.s	4(a3),fp1
	fbolt.b	L406
L400
;				
;					flags |= VIS;
	or.l	#$F,(a2)
;					projected = CachedVertices(numVerts);
	move.w	d1,d0
	ext.l	d0
	move.l	d0,d1
	add.l	_vCachePtr__AXON,d1
	cmp.l	#$4000,d1
	bls.b	L404
L401
	move.l	#L368,-(a7)
	move.l	_cout,a0
	cmp.w	#0,a0
	beq.b	L403
L402
	addq.w	#4,a0
L403
	move.l	a0,-(a7)
	jsr	op__leftshift__ostream__TPCc
	addq.w	#$8,a7
	sub.l	a0,a0
	bra.b	L405
L404
	move.l	_vCachePtr__AXON,d1
	asl.l	#6,d1
	move.l	_vCache__AXON,a1
	lea	0(a1,d1.l),a0
	add.l	d0,_vCachePtr__AXON
L405
	move.l	a0,$8(a2)
	moveq	#1,d0
	fmovem.x (a7)+,fp2/fp3/fp4/fp5/fp6
	movem.l	(a7)+,d2/d3/a2/a3
	rts
L406
;				i++;
	addq.l	#1,d0
L407
	cmp.l	#4,d0
	blt	L396
L408
;		rfloat32 pp = QTRIG::CotI(view.vA);
	moveq	#0,d0
	move.w	$188(a1),d0
	cmp.l	#$5A,d0
	bhs.b	L410
L409
	moveq	#$5A,d2
	sub.l	d0,d2
	move.l	d2,d0
	asl.l	#2,d0
	add.l	#_gradData__QTRIG,d0
	move.l	d0,a3
	fmove.s	(a3),fp1
	fneg.s	fp1
	bra	L417
L410
	cmp.l	#$B4,d0
	bhs.b	L412
L411
	sub.l	#$5A,d0
	asl.l	#2,d0
	add.l	#_gradData__QTRIG,d0
	move.l	d0,a3
	fmove.s	(a3),fp1
	bra.b	L417
L412
	cmp.l	#$10E,d0
	bhs.b	L414
L413
	move.l	#$10E,d2
	sub.l	d0,d2
	move.l	d2,d0
	asl.l	#2,d0
	add.l	#_gradData__QTRIG,d0
	move.l	d0,a3
	fmove.s	(a3),fp1
	fneg.s	fp1
	bra.b	L417
L414
	cmp.l	#$168,d0
	bhs.b	L416
L415
	sub.l	#$10E,d0
	asl.l	#2,d0
	add.l	#_gradData__QTRIG,d0
	move.l	d0,a3
	fmove.s	(a3),fp1
	bra.b	L417
L416
	move.l	#$1C2,d2
	sub.l	d0,d2
	move.l	d2,d0
	asl.l	#2,d0
	add.l	#_gradData__QTRIG,d0
	move.l	d0,a3
	fmove.s	(a3),fp1
	fneg.s	fp1
L417
;		rfloat32 pl = QTRIG::TanI(view.vA);
	moveq	#0,d0
	move.w	$188(a1),d0
	cmp.l	#$5A,d0
	bhs.b	L419
L418
	asl.l	#2,d0
	add.l	#_gradData__QTRIG,d0
	move.l	d0,a3
	fmove.s	(a3),fp2
	bra	L426
L419
	cmp.l	#$B4,d0
	bhs.b	L421
L420
	move.l	#$B4,d2
	sub.l	d0,d2
	move.l	d2,d0
	asl.l	#2,d0
	add.l	#_gradData__QTRIG,d0
	move.l	d0,a3
	fmove.s	(a3),fp2
	fneg.s	fp2
	bra.b	L426
L421
	cmp.l	#$10E,d0
	bhs.b	L423
L422
	sub.l	#$B4,d0
	asl.l	#2,d0
	add.l	#_gradData__QTRIG,d0
	move.l	d0,a3
	fmove.s	(a3),fp2
	bra.b	L426
L423
	cmp.l	#$168,d0
	bhs.b	L425
L424
	move.l	#$168,d2
	sub.l	d0,d2
	move.l	d2,d0
	asl.l	#2,d0
	add.l	#_gradData__QTRIG,d0
	move.l	d0,a3
	fmove.s	(a3),fp2
	fneg.s	fp2
	bra.b	L426
L425
	sub.l	#$168,d0
	asl.l	#2,d0
	add.l	#_gradData__QTRIG,d0
	move.l	d0,a3
	fmove.s	(a3),fp2
L426
;		if (view.vA < 90) // 1st quarter
	move.w	$188(a1),d0
	cmp.w	#$5A,d0
	bhs	L441
L427
;		
;			rsint32 i = 0;
	moveq	#0,d0
;			while (i<5)
	bra	L439
L428
;			
;				rfloat32 x = data[i].x;
	lea	$18(a2),a1
	move.l	d0,d2
	muls.l	#$18,d2
	fmove.s	0(a1,d2.l),fp3
; rfloat32 y = data[i].y;
	lea	$18(a2),a1
	move.l	d0,d2
	muls.l	#$18,d2
	fmove.s	4(a1,d2.l),fp4
;				rfloat32 yTest = vp[0].y+(x-vp[0].x)*pl;
	fmove.x	fp3,fp5
	fsub.s	(a0),fp5
	fmul.x	fp2,fp5
	fmove.s	4(a0),fp0
	fadd.x	fp5,fp0
;				if (y <= yTest)
	fcmp.x	fp0,fp4
	fbogt.b	L438
L429
;				
;					yTest = vp[0].y+(x-vp[0].x)*pp;
	fmove.x	fp3,fp5
	fsub.s	(a0),fp5
	fmul.x	fp1,fp5
	fmove.s	4(a0),fp0
	fadd.x	fp5,fp0
;					if (y >= yTest)
	fcmp.x	fp0,fp4
	fbolt.b	L438
L430
;					
;						yTest = vp[2].y+(x-vp[2].x)*pl;
	fmove.x	fp3,fp5
	fsub.s	$18(a0),fp5
	fmul.x	fp2,fp5
	fmove.s	$1C(a0),fp0
	fadd.x	fp5,fp0
;						if (y >= yTest)
	fcmp.x	fp0,fp4
	fbolt.b	L438
L431
;						
;							yTest = vp[2].y+(x-vp[2].x)*pp;
	fsub.s	$18(a0),fp3
	fmul.x	fp1,fp3
	fmove.s	$1C(a0),fp0
	fadd.x	fp3,fp0
;							if (y <= yTest)
	fcmp.x	fp0,fp4
	fbogt.b	L438
L432
;							
;								flags |= VIS;
	or.l	#$F,(a2)
;								projected = CachedVertices(numVerts);
	move.w	d1,d0
	ext.l	d0
	move.l	d0,d1
	add.l	_vCachePtr__AXON,d1
	cmp.l	#$4000,d1
	bls.b	L436
L433
	move.l	#L368,-(a7)
	move.l	_cout,a0
	cmp.w	#0,a0
	beq.b	L435
L434
	addq.w	#4,a0
L435
	move.l	a0,-(a7)
	jsr	op__leftshift__ostream__TPCc
	addq.w	#$8,a7
	sub.l	a0,a0
	bra.b	L437
L436
	move.l	_vCachePtr__AXON,d1
	asl.l	#6,d1
	move.l	_vCache__AXON,a1
	lea	0(a1,d1.l),a0
	add.l	d0,_vCachePtr__AXON
L437
	move.l	a0,$8(a2)
	moveq	#1,d0
	fmovem.x (a7)+,fp2/fp3/fp4/fp5/fp6
	movem.l	(a7)+,d2/d3/a2/a3
	rts
L438
;				i++;
	addq.l	#1,d0
L439
	cmp.l	#5,d0
	blt	L428
L440
;			projected = NOTSET;
	clr.l	$8(a2)
	moveq	#0,d0
	fmovem.x (a7)+,fp2/fp3/fp4/fp5/fp6
	movem.l	(a7)+,d2/d3/a2/a3
	rts
L441
;		else if (view.vA < 180) // 2nd quarter
	move.w	$188(a1),d0
	cmp.w	#$B4,d0
	bhs	L456
L442
;		
;			rsint32 i = 0;
	moveq	#0,d0
;			while (i<5)
	bra	L454
L443
;			
;				rfloat32 x = data[i].x;
	lea	$18(a2),a1
	move.l	d0,d2
	muls.l	#$18,d2
	fmove.s	0(a1,d2.l),fp3
; rfloat32 y = data[i].y;
	lea	$18(a2),a1
	move.l	d0,d2
	muls.l	#$18,d2
	fmove.s	4(a1,d2.l),fp4
;				rfloat32 yTest = vp[0].y+(x-vp[0].x)*pl;
	fmove.x	fp3,fp5
	fsub.s	(a0),fp5
	fmul.x	fp2,fp5
	fmove.s	4(a0),fp0
	fadd.x	fp5,fp0
;				if (y >= yTest)
	fcmp.x	fp0,fp4
	fbolt.b	L453
L444
;				
;					yTest = vp[0].y+(x-vp[0].x)*pp;
	fmove.x	fp3,fp5
	fsub.s	(a0),fp5
	fmul.x	fp1,fp5
	fmove.s	4(a0),fp0
	fadd.x	fp5,fp0
;					if (y >= yTest)
	fcmp.x	fp0,fp4
	fbolt.b	L453
L445
;					
;						yTest = vp[2].y+(x-vp[2].x)*pl;
	fmove.x	fp3,fp5
	fsub.s	$18(a0),fp5
	fmul.x	fp2,fp5
	fmove.s	$1C(a0),fp0
	fadd.x	fp5,fp0
;						if (y <= yTest)
	fcmp.x	fp0,fp4
	fbogt.b	L453
L446
;						
;							yTest = vp[2].y+(x-vp[2].x)*pp;
	fsub.s	$18(a0),fp3
	fmul.x	fp1,fp3
	fmove.s	$1C(a0),fp0
	fadd.x	fp3,fp0
;							if (y <= yTest)
	fcmp.x	fp0,fp4
	fbogt.b	L453
L447
;							
;								flags |= VIS;
	or.l	#$F,(a2)
;								projected = CachedVertices(numVerts);
	move.w	d1,d0
	ext.l	d0
	move.l	d0,d1
	add.l	_vCachePtr__AXON,d1
	cmp.l	#$4000,d1
	bls.b	L451
L448
	move.l	#L368,-(a7)
	move.l	_cout,a0
	cmp.w	#0,a0
	beq.b	L450
L449
	addq.w	#4,a0
L450
	move.l	a0,-(a7)
	jsr	op__leftshift__ostream__TPCc
	addq.w	#$8,a7
	sub.l	a0,a0
	bra.b	L452
L451
	move.l	_vCachePtr__AXON,d1
	asl.l	#6,d1
	move.l	_vCache__AXON,a1
	lea	0(a1,d1.l),a0
	add.l	d0,_vCachePtr__AXON
L452
	move.l	a0,$8(a2)
	moveq	#1,d0
	fmovem.x (a7)+,fp2/fp3/fp4/fp5/fp6
	movem.l	(a7)+,d2/d3/a2/a3
	rts
L453
;				i++;
	addq.l	#1,d0
L454
	cmp.l	#5,d0
	blt	L443
L455
;			projected = NOTSET;
	clr.l	$8(a2)
	moveq	#0,d0
	fmovem.x (a7)+,fp2/fp3/fp4/fp5/fp6
	movem.l	(a7)+,d2/d3/a2/a3
	rts
L456
;		else if (view.vA < 270) // 3rd quarter
	move.w	$188(a1),d0
	cmp.w	#$10E,d0
	bhs	L471
L457
;		
;			rsint32 i = 0;
	moveq	#0,d0
;			while (i<5)
	bra	L469
L458
;			
;				rfloat32 x = data[i].x;
	lea	$18(a2),a1
	move.l	d0,d2
	muls.l	#$18,d2
	fmove.s	0(a1,d2.l),fp3
; rfloat32 y = data[i].y;
	lea	$18(a2),a1
	move.l	d0,d2
	muls.l	#$18,d2
	fmove.s	4(a1,d2.l),fp4
;				rfloat32 yTest = vp[0].y+(x-vp[0].x)*pl;
	fmove.x	fp3,fp5
	fsub.s	(a0),fp5
	fmul.x	fp2,fp5
	fmove.s	4(a0),fp0
	fadd.x	fp5,fp0
;				if (y >= yTest)
	fcmp.x	fp0,fp4
	fbolt.b	L468
L459
;				
;					yTest = vp[0].y+(x-vp[0].x)*pp;
	fmove.x	fp3,fp5
	fsub.s	(a0),fp5
	fmul.x	fp1,fp5
	fmove.s	4(a0),fp0
	fadd.x	fp5,fp0
;					if (y <= yTest)
	fcmp.x	fp0,fp4
	fbogt.b	L468
L460
;					
;						yTest = vp[2].y+(x-vp[2].x)*pl;
	fmove.x	fp3,fp5
	fsub.s	$18(a0),fp5
	fmul.x	fp2,fp5
	fmove.s	$1C(a0),fp0
	fadd.x	fp5,fp0
;						if (y <= yTest)
	fcmp.x	fp0,fp4
	fbogt.b	L468
L461
;						
;							yTest = vp[2].y+(x-vp[2].x)*pp;
	fsub.s	$18(a0),fp3
	fmul.x	fp1,fp3
	fmove.s	$1C(a0),fp0
	fadd.x	fp3,fp0
;							if (y >= yTest)
	fcmp.x	fp0,fp4
	fbolt.b	L468
L462
;							
;								flags |= VIS;
	or.l	#$F,(a2)
;								projected = CachedVertices(numVerts);
	move.w	d1,d0
	ext.l	d0
	move.l	d0,d1
	add.l	_vCachePtr__AXON,d1
	cmp.l	#$4000,d1
	bls.b	L466
L463
	move.l	#L368,-(a7)
	move.l	_cout,a0
	cmp.w	#0,a0
	beq.b	L465
L464
	addq.w	#4,a0
L465
	move.l	a0,-(a7)
	jsr	op__leftshift__ostream__TPCc
	addq.w	#$8,a7
	sub.l	a0,a0
	bra.b	L467
L466
	move.l	_vCachePtr__AXON,d1
	asl.l	#6,d1
	move.l	_vCache__AXON,a1
	lea	0(a1,d1.l),a0
	add.l	d0,_vCachePtr__AXON
L467
	move.l	a0,$8(a2)
	moveq	#1,d0
	fmovem.x (a7)+,fp2/fp3/fp4/fp5/fp6
	movem.l	(a7)+,d2/d3/a2/a3
	rts
L468
;				i++;
	addq.l	#1,d0
L469
	cmp.l	#5,d0
	blt	L458
L470
;			projected = NOTSET;
	clr.l	$8(a2)
	moveq	#0,d0
	fmovem.x (a7)+,fp2/fp3/fp4/fp5/fp6
	movem.l	(a7)+,d2/d3/a2/a3
	rts
L471
;		else if (view.vA < 360) // 4th quarter
	move.w	$188(a1),d0
	cmp.w	#$168,d0
	bhs	L486
L472
;		
;			rsint32 i = 0;
	moveq	#0,d0
;			while (i<5)
	bra	L484
L473
;			
;				rfloat32 x = data[i].x;
	lea	$18(a2),a1
	move.l	d0,d2
	muls.l	#$18,d2
	fmove.s	0(a1,d2.l),fp3
; rfloat32 y = data[i].y;
	lea	$18(a2),a1
	move.l	d0,d2
	muls.l	#$18,d2
	fmove.s	4(a1,d2.l),fp4
;				rfloat32 yTest = vp[0].y+(x-vp[0].x)*pl;
	fmove.x	fp3,fp5
	fsub.s	(a0),fp5
	fmul.x	fp2,fp5
	fmove.s	4(a0),fp0
	fadd.x	fp5,fp0
;				if (y <= yTest)
	fcmp.x	fp0,fp4
	fbogt.b	L483
L474
;				
;					yTest = vp[0].y+(x-vp[0].x)*pp;
	fmove.x	fp3,fp5
	fsub.s	(a0),fp5
	fmul.x	fp1,fp5
	fmove.s	4(a0),fp0
	fadd.x	fp5,fp0
;					if (y <= yTest)
	fcmp.x	fp0,fp4
	fbogt.b	L483
L475
;					
;						yTest = vp[2].y+(x-vp[2].x)*pl;
	fmove.x	fp3,fp5
	fsub.s	$18(a0),fp5
	fmul.x	fp2,fp5
	fmove.s	$1C(a0),fp0
	fadd.x	fp5,fp0
;						if (y >= yTest)
	fcmp.x	fp0,fp4
	fbolt.b	L483
L476
;						
;							yTest = vp[2].y+(x-vp[2].x)*pp;
	fsub.s	$18(a0),fp3
	fmul.x	fp1,fp3
	fmove.s	$1C(a0),fp0
	fadd.x	fp3,fp0
;							if (y >= yTest)
	fcmp.x	fp0,fp4
	fbolt.b	L483
L477
;							
;								flags |= VIS;
	or.l	#$F,(a2)
;								projected = CachedVertices(numVerts);
	move.w	d1,d0
	ext.l	d0
	move.l	d0,d1
	add.l	_vCachePtr__AXON,d1
	cmp.l	#$4000,d1
	bls.b	L481
L478
	move.l	#L368,-(a7)
	move.l	_cout,a0
	cmp.w	#0,a0
	beq.b	L480
L479
	addq.w	#4,a0
L480
	move.l	a0,-(a7)
	jsr	op__leftshift__ostream__TPCc
	addq.w	#$8,a7
	sub.l	a0,a0
	bra.b	L482
L481
	move.l	_vCachePtr__AXON,d1
	asl.l	#6,d1
	move.l	_vCache__AXON,a1
	lea	0(a1,d1.l),a0
	add.l	d0,_vCachePtr__AXON
L482
	move.l	a0,$8(a2)
	moveq	#1,d0
	fmovem.x (a7)+,fp2/fp3/fp4/fp5/fp6
	movem.l	(a7)+,d2/d3/a2/a3
	rts
L483
;				i++;
	addq.l	#1,d0
L484
	cmp.l	#5,d0
	blt	L473
L485
;			projected = NOTSET;
	clr.l	$8(a2)
	moveq	#0,d0
	fmovem.x (a7)+,fp2/fp3/fp4/fp5/fp6
	movem.l	(a7)+,d2/d3/a2/a3
	rts
L486
;			return 
	fmovem.x (a7)+,fp2/fp3/fp4/fp5/fp6
	movem.l	(a7)+,d2/d3/a2/a3
	rts

L368
	dc.b	'Vertex Overflow',$A,0

	SECTION "Display__MAPCELL__TR04VIEW:0",CODE


;void MAPCELL::Display(VIEW& view)
	XDEF	Display__MAPCELL__TR04VIEW
Display__MAPCELL__TR04VIEW
L492	EQU	-$28
	link	a5,#L492
	movem.l	d2/d3/a2/a3/a6,-(a7)
	fmovem.x fp2/fp3,-(a7)
	move.l	$8(a5),a2
L487
;	register sysVERTEX* vt = Vertices(4);
	moveq	#4,d2
	move.l	_vBufPos__xDRAW,d0
	add.l	d2,d0
	cmp.l	_vArraySize__xDRAW,d0
	blo.b	L491
L488
	move.l	_context__x3D,a0
	move.l	_Warp3DBase,a6
	jsr	-$138(a6)
	move.l	_vBufPos__xDRAW,d0
	cmp.l	_maxVBufPos__xDRAW,d0
	ble.b	L490
L489
	move.l	_vBufPos__xDRAW,_maxVBufPos__xDRAW
L490
	clr.l	_vBufPos__xDRAW
	and.l	#-3,_flags__xDRAW
	addq.l	#1,_flushCnt__xDRAW
L491
	move.l	_vBufPos__xDRAW,d0
	asl.l	#6,d0
	move.l	_vBuffer__xDRAW,a1
	lea	0(a1,d0.l),a0
	add.l	d2,_vBufPos__xDRAW
	or.l	#$40,_flags__xDRAW
	move.l	a0,a3
;	
;		rfloat32 scaleF = view.width/WORLDMAP::Scale();
	move.l	$C(a5),a0
	move.l	4(a0),a0
	move.w	(a0),d0
	ext.l	d0
	fmove.l	d0,fp0
	fmove.s	_scale__WORLDMAP,fp1
	fdiv.x	fp1,fp0
;		rfloat32 offset = (view.height-view.width)/2F;
	move.l	$C(a5),a0
	move.l	4(a0),a0
	move.w	2(a0),d0
	ext.l	d0
	move.l	$C(a5),a0
	move.l	4(a0),$C(a5)
	move.l	$C(a5),a0
	move.w	(a0),d1
	ext.l	d1
	sub.l	d1,d0
	fmove.l	d0,fp1
	fdiv.s	#$.40000000,fp1
;		vt[0].x=scaleF*data[1].x;
	lea	$18(a2),a0
	fmove.s	$18(a0),fp2
	fmul.x	fp0,fp2
	move.l	a3,a0
	fmove.s	fp2,(a0)
;		vt[0].y=scaleF*(WORLDMAP::Scale()-data[1].y)+offset;
	fmove.s	_scale__WORLDMAP,fp2
	lea	$18(a2),a0
	fsub.s	$1C(a0),fp2
	fmul.x	fp0,fp2
	fadd.x	fp1,fp2
	move.l	a3,a0
	fmove.s	fp2,4(a0)
;		vt[0].z=0;
	move.l	a3,a0
	clr.l	$8(a0)
	clr.l	$C(a0)
;		vt[1].x=scaleF*data[2].x;
	lea	$18(a2),a0
	fmove.s	$30(a0),fp2
	fmul.x	fp0,fp2
	fmove.s	fp2,$40(a3)
;		vt[1].y=scaleF*(WORLDMAP::Scale()-data[2].y)+offset;
	fmove.s	_scale__WORLDMAP,fp2
	lea	$18(a2),a0
	fsub.s	$34(a0),fp2
	fmul.x	fp0,fp2
	fadd.x	fp1,fp2
	fmove.s	fp2,$44(a3)
;		vt[1].z=0;
	clr.l	$48(a3)
	clr.l	$4C(a3)
;		vt[2].x=scaleF*data[3].x;
	lea	$18(a2),a0
	fmove.s	$48(a0),fp2
	fmul.x	fp0,fp2
	fmove.s	fp2,$80(a3)
;		vt[2].y=scaleF*(WORLDMAP::Scale()-data[3].y)+offset;
	fmove.s	_scale__WORLDMAP,fp2
	lea	$18(a2),a0
	fsub.s	$4C(a0),fp2
	fmul.x	fp0,fp2
	fadd.x	fp1,fp2
	fmove.s	fp2,$84(a3)
;		vt[2].z=0;
	clr.l	$88(a3)
	clr.l	$8C(a3)
;		vt[3].x=scaleF*data[4].x;
	lea	$18(a2),a0
	fmove.s	$60(a0),fp2
	fmul.x	fp0,fp2
	fmove.s	fp2,$C0(a3)
;		vt[3].y=scaleF*(WORLDMAP::Scale()-data[4].y)+offset;
	fmove.s	_scale__WORLDMAP,fp2
	lea	$18(a2),a0
	fsub.s	$64(a0),fp2
	fmul.x	fp2,fp0
	fadd.x	fp1,fp0
	fmove.s	fp0,$C4(a3)
;		vt[3].z=0;
	clr.l	$C8(a3)
	clr.l	$CC(a3)
;	
;		ruint32 c = (data[0].c & 0x00FFFFFF)|0xA0000000;
	move.l	$2C(a2),d0
	and.l	#$FFFFFF,d0
	or.l	#$A0000000,d0
;		SetColour(c);
	lea	-$18(a5),a0
	move.l	d0,d1
	move.l	#$FF0000,d0
	move.l	d1,d2
	and.l	d0,d2
	moveq	#$10,d3
	lsr.l	d3,d2
	move.l	#_cTab__xDRAW,a2
	move.l	0(a2,d2.l*4),(a0)+
	moveq	#$8,d2
	lsr.l	d2,d0
	move.l	d1,d2
	and.l	d0,d2
	moveq	#$8,d3
	lsr.l	d3,d2
	move.l	#_cTab__xDRAW,a2
	move.l	0(a2,d2.l*4),(a0)+
	moveq	#$8,d2
	lsr.l	d2,d0
	move.l	d1,d2
	and.l	d0,d2
	move.l	#_cTab__xDRAW,a2
	move.l	0(a2,d2.l*4),(a0)+
	moveq	#$18,d2
	asl.l	d2,d0
	and.l	d0,d1
	moveq	#$18,d0
	lsr.l	d0,d1
	move.l	#_cTab__xDRAW,a2
	move.l	0(a2,d1.l*4),(a0)
	move.l	_context__x3D,a0
	move.l	_Warp3DBase,a6
	lea	-$18(a5),a1
	jsr	-$168(a6)
;		TriStrip(vt,4);
	lea	-$28(a5),a0
	move.l	#4,(a0)+
	move.l	a3,(a0)+
	clr.l	(a0)+
	clr.l	(a0)+
	move.l	_context__x3D,a0
	move.l	_Warp3DBase,a6
	lea	-$28(a5),a1
	jsr	-$AE(a6)
	fmovem.x (a7)+,fp2/fp3
	movem.l	(a7)+,d2/d3/a2/a3/a6
	unlk	a5
	rts

	SECTION "Render__MAPCELL__TR04VIEW:0",CODE


;void MAPCELL::Render(VIEW& view)
	XDEF	Render__MAPCELL__TR04VIEW
Render__MAPCELL__TR04VIEW
L501	EQU	-$70
	link	a5,#L501
	movem.l	a2/a6,-(a7)
	fmovem.x fp2/fp3/fp4,-(a7)
	move.l	$C(a5),a2
	move.l	$8(a5),a6
L494
;	if (!projected)
	tst.l	$8(a6)
	bne.b	L498
L495
;	
;		cout << "Error : MAPCELL::Render() no points allocated\n";
	move.l	#L493,-(a7)
	move.l	_cout,a0
	cmp.w	#0,a0
	beq.b	L497
L496
	addq.w	#4,a0
L497
	move.l	a0,-(a7)
	jsr	op__leftshift__ostream__TPCc
	addq.w	#$8,a7
	fmovem.x (a7)+,fp2/fp3/fp4
	movem.l	(a7)+,a2/a6
	unlk	a5
	rts
L498
;	if (view.State(VIEW::CHANGED))
	move.l	#$20000,d0
	and.l	$180(a2),d0
	beq	L500
L499
;	
;		view.Transform(data+1, projected, points);
	move.l	4(a6),-(a7)
	move.l	$8(a6),-(a7)
	lea	$18(a6),a0
	pea	$18(a0)
	move.l	a2,-(a7)
	jsr	Transform__VIEW__TP03C3DP10W3D_VertexUj
	add.w	#$10,a7
;		
;			C3D d[4] = {
	lea	-$60(a5),a0
	fmove.s	_floodLevel__WORLDMAP,fp2
	lea	$18(a6),a1
	fmove.s	$1C(a1),fp1
	lea	$18(a6),a1
	move.l	$18(a1),(a0)
	fmove.s	fp1,4(a0)
	fmove.s	fp2,$8(a0)
	clr.l	$C(a0)
	clr.l	$10(a0)
	move.l	#-1,$14(a0)
	add.w	#$18,a0
	fmove.s	_floodLevel__WORLDMAP,fp2
	lea	$18(a6),a1
	fmove.s	$34(a1),fp1
	lea	$18(a6),a1
	move.l	$30(a1),(a0)
	fmove.s	fp1,4(a0)
	fmove.s	fp2,$8(a0)
	clr.l	$C(a0)
	move.l	#$43000000,$10(a0)
	move.l	#-1,$14(a0)
	add.w	#$18,a0
	fmove.s	_floodLevel__WORLDMAP,fp2
	lea	$18(a6),a1
	fmove.s	$4C(a1),fp1
	lea	$18(a6),a1
	move.l	$48(a1),(a0)
	fmove.s	fp1,4(a0)
	fmove.s	fp2,$8(a0)
	move.l	#$43000000,$C(a0)
	clr.l	$10(a0)
	move.l	#-1,$14(a0)
	add.w	#$18,a0
	fmove.s	_floodLevel__WORLDMAP,fp2
	lea	$18(a6),a1
	fmove.s	$64(a1),fp1
	lea	$18(a6),a1
	move.l	$60(a1),(a0)
	fmove.s	fp1,4(a0)
	fmove.s	fp2,$8(a0)
	move.l	#$43000000,$C(a0)
	move.l	#$43000000,$10(a0)
	move.l	#-1,$14(a0)
;			view.Transform(d, (projected+(2*points)), 4);
	pea	4.w
	move.l	4(a6),d0
	moveq	#1,d1
	asl.l	d1,d0
	asl.l	#6,d0
	move.l	$8(a6),a0
	pea	0(a0,d0.l)
	pea	-$60(a5)
	move.l	a2,-(a7)
	jsr	Transform__VIEW__TP03C3DP10W3D_VertexUj
	add.w	#$10,a7
L500
;	TriStripTx(projected, points, tex);
	move.l	$10(a6),a2
	move.l	$8(a6),a1
	lea	-$70(a5),a0
	move.l	4(a6),(a0)+
	move.l	a1,(a0)+
	move.l	a2,(a0)+
	clr.l	(a0)+
	move.l	_context__x3D,a0
	move.l	_Warp3DBase,a6
	lea	-$70(a5),a1
	jsr	-$AE(a6)
	fmovem.x (a7)+,fp2/fp3/fp4
	movem.l	(a7)+,a2/a6
	unlk	a5
	rts

L493
	dc.b	'Error : MAPCELL::Render() no points allocated',$A,0

	SECTION "WaterSurf__MAPCELL__T:0",CODE


;void MAPCELL::WaterSurf()
	XDEF	WaterSurf__MAPCELL__T
WaterSurf__MAPCELL__T
L503	EQU	-$10
	link	a5,#L503
	movem.l	d2/a2/a6,-(a7)
	move.l	$8(a5),a1
L502
;	TriStripTx((projected+(2*points)), 4, WORLDMAP::WaterTex());
	move.l	_frames__WORLDMAP,d0
	and.l	#7,d0
	move.l	#_water__WORLDMAP,a2
	move.l	0(a2,d0.l*4),a0
	move.l	$10(a0),a6
	move.l	4(a1),d0
	moveq	#1,d2
	asl.l	d2,d0
	asl.l	#6,d0
	move.l	$8(a1),a0
	lea	0(a0,d0.l),a1
	lea	-$10(a5),a0
	move.l	#4,(a0)+
	move.l	a1,(a0)+
	move.l	a6,(a0)+
	clr.l	(a0)+
	move.l	_context__x3D,a0
	move.l	_Warp3DBase,a6
	lea	-$10(a5),a1
	jsr	-$AE(a6)
	movem.l	(a7)+,d2/a2/a6
	unlk	a5
	rts

	SECTION "Detail__MAPCELL__T:0",CODE


;void MAPCELL::Detail()
	XDEF	Detail__MAPCELL__T
Detail__MAPCELL__T
L508	EQU	-$1C
	link	a5,#L508
	movem.l	d2/a2/a6,-(a7)
	move.l	$8(a5),a0
L504
;	
;		uint32* src = (uint32*)projected;
	move.l	$8(a0),a6
;		uint32* dst = (uint32*)(projected+points);
	move.l	4(a0),d0
	asl.l	#6,d0
	move.l	$8(a0),a1
	add.l	d0,a1
;		sint32 n = 1+points*(sizeof(sysVERTEX)/sizeof(uint32));
	move.l	4(a0),d0
	moveq	#4,d1
	asl.l	d1,d0
	addq.l	#1,d0
;		while (--n)
	bra.b	L506
L505
;			*(dst++) = *(src++);
	move.l	(a6)+,(a1)+
L506
	subq.l	#1,d0
	tst.l	d0
	bne.b	L505
L507
;	rfloat32 a = 1.66F*(WORLDMAP::LOD()-0.4F);
	fmove.s	_detailLevel__WORLDMAP,fp0
	fsub.s	#$.3ECCCCCD,fp0
	fmul.s	#$.3FD47AE1,fp0
;	sysVERTEX* t = projected+points;
	move.l	4(a0),d0
	asl.l	#6,d0
	move.l	$8(a0),a1
	add.l	d0,a1
;	
;		t[0].u = 0;
	clr.l	$14(a1)
;					t[0].v = 0;
	clr.l	$18(a1)
;					t[0].color.a = a;
	fmove.s	fp0,$2C(a1)
;		t[1].u = 0;
	clr.l	$54(a1)
;					t[1].v = data[0].v;
	move.l	$28(a0),$58(a1)
;	t[1].color.a = a;
	fmove.s	fp0,$6C(a1)
;		t[2].u = data[0].u;
	move.l	$24(a0),$94(a1)
;	t[2].v = 0;
	clr.l	$98(a1)
;					t[2].color.a = a;
	fmove.s	fp0,$AC(a1)
;		t[3].u = data[0].u;
	move.l	$24(a0),$D4(a1)
;	t[3].v = data[0].v;
	move.l	$28(a0),$D8(a1)
;	t[3].color.a = a;
	fmove.s	fp0,$EC(a1)
;	TriStripTx(projected+points, points, detail);
	move.l	$14(a0),a6
	move.l	4(a0),d1
	move.l	4(a0),d0
	asl.l	#6,d0
	move.l	$8(a0),a1
	add.l	d0,a1
	lea	-$1C(a5),a0
	move.l	d1,(a0)+
	move.l	a1,(a0)+
	move.l	a6,(a0)+
	clr.l	(a0)+
	move.l	_context__x3D,a0
	move.l	_Warp3DBase,a6
	lea	-$1C(a5),a1
	jsr	-$AE(a6)
	movem.l	(a7)+,d2/a2/a6
	unlk	a5
	rts

	END
