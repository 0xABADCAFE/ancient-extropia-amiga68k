
; Storm C Compiler
; Mendoza:Extropia/eXtropia/prj/AXON/World.cpp
	mc68030
	mc68881
	XREF	_0dt__BUILDING__T
	XREF	Render__BUILDING__TR04VIEW
	XREF	Place__BUILDING__TRC05VEC3Dfsss
	XREF	_0dt__PINETREE__T
	XREF	Render__PINETREE__TR04VIEW
	XREF	Place__PINETREE__TRC05VEC3Dfsss
	XREF	Render__RGBCUBE__TR04VIEW
	XREF	Place__RGBCUBE__TRC05VEC3Dfsss
	XREF	Render__MODEL__TR04VIEW
	XREF	Rotate__MODEL__Tsss
	XREF	Move__MODEL__TRC05VEC3D
	XREF	Place__MODEL__TRC05VEC3Dfsss
	XREF	ClipBox__MODEL__T
	XREF	_0dt__MAPCELL__T
	XREF	_0ct__MAPCELL__T
	XREF	WaterSurf__MAPCELL__T
	XREF	Detail__MAPCELL__T
	XREF	Render__MAPCELL__TR04VIEW
	XREF	Display__MAPCELL__TR04VIEW
	XREF	Visibility__MAPCELL__TR04VIEW
	XREF	Set__MAPCELL__TR03C3DR03C3DR03C3DR03C3DUjP08xTEXTUREP08xTEXTURE
	XREF	_0dt__VIEW__T
	XREF	Display__VIEW__T
	XREF	Project__VIEW__T
	XREF	Close__VIEW__T
	XREF	Open__VIEW__T
	XREF	MoveEvent__VIEW__T
	XREF	ResizeEvent__VIEW__T
	XREF	ExitEvent__VIEW__T
	XREF	KeyEvent__VIEW__Tjs
	XREF	MouseEvent__VIEW__Tjjj
	XREF	UseTex__TEXTUREHEAP__PCcj
	XREF	UsePPM__TEXTUREHEAP__PCcUj
	XREF	op__multAsgn__TRANSFORM__TRC09TRANSFORM
	XREF	Rotate__TRANSFORM__Tfff
	XREF	Define__PLANE__TP03C3DP03C3DP03C3D
	XREF	Define__PLANE__TP05VEC3DP05VEC3DP05VEC3D
	XREF	_sqrt__r
	XREF	RectShV__xDRAW__r14PUjUjUj
	XREF	Rect__xDRAW__UjUjUj
	XREF	Line__xDRAW__UjUjUj
	XREF	Delete__xTEXTURE__T
	XREF	Create__xTEXTURE__TsssPvPUj
	XREF	Close__xDBWIN__T
	XREF	Open__xDBWIN__T
	XREF	Set__xDBWIN__TsssssPCc
	XREF	Idle__xDISPLAYIO_ASYNC__T
	XREF	Done__xDISPLAYIO_ASYNC__T
	XREF	Init__xDISPLAYIO_ASYNC__T
	XREF	MoveEvent__xDISPLAYIO__T
	XREF	ResizeEvent__xDISPLAYIO__T
	XREF	Idle__xDISPLAYIO__T
	XREF	HandleEvent__xDISPLAYIO__T
	XREF	ApplyInputModification__xDISPLAYIO__T
	XREF	ViewSurface__xDISPLAY__T
	XREF	DrawSurface__xDISPLAY__T
	XREF	Refresh__xDISPLAY__T
	XREF	Close__xDISPLAY__T
	XREF	Open__xDISPLAY__T
	XREF	_0dt__xSURFACE__T
	XREF	_0dt__POOL_ST__T
	XREF	_0ct__POOL_ST__TUsUj
	XREF	FreeT__POOL_ST__TPv
	XREF	NewT__POOL_ST__TPvUs
	XREF	NewT__POOL_ST__TPv
	XREF	Create__POOL_ST__TUsUj
	XREF	PrintAlloc__POOL_ST__TR07ostreamjj
	XREF	_0dt__POOL_LT__T
	XREF	Close__xFILEIO__T
	XREF	Write__xFILEIO__TPvUiUi
	XREF	Read__xFILEIO__TPvUiUi
	XREF	Open__xFILEIO__TPCcjj
	XREF	SendPacket__xFILEIO__TPv
	XREF	WaitPacket__xFILEIO__T
	XREF	InputQueued__xINPUT__T
	XREF	Idle__xINPUT__T
	XREF	ExitEvent__xINPUT__T
	XREF	KeyEvent__xINPUT__Tjs
	XREF	MouseEvent__xINPUT__Tjjj
	XREF	ApplyInputModification__xINPUT__T
	XREF	UnLink__xCHAINABLE__T
	XREF	_0ct__xTHREADABLE__TPCcUjjs
	XREF	ShutDown__xTHREADABLE__T
	XREF	Done__xTHREADABLE__T
	XREF	Init__xTHREADABLE__T
	XREF	_0dt__xLOCKABLE__T
	XREF	FreeLock__xLOCKABLE__Ts
	XREF	WaitLock__xLOCKABLE__T
	XREF	_0dt__sysRTLIB__T
	XREF	MessageBox__sysBASELIB__PcPcPce
	XREF	_system
	XREF	_rand
	XREF	op__leftshift__ostream__Td
	XREF	op__leftshift__ostream__TUj
	XREF	op__leftshift__ostream__Tj
	XREF	op__leftshift__ostream__TPCc
	XREF	op__leftshift__ostream__Tc
	XREF	opfx__ostream__T
	XREF	read__istream__TPci
	XREF	get__istream__TRc
	XREF	getline__istream__TPcic
	XREF	get__istream__TPcic
	XREF	op__rightshift__istream__TRc
	XREF	op__rightshift__istream__TPc
	XREF	doallocate__streambuf__T
	XREF	xsgetn__streambuf__TPci
	XREF	xsputn__streambuf__TPCci
	XREF	underflow__streambuf__T
	XREF	overflow__streambuf__Ti
	XREF	setbuf__streambuf__TPcUi
	XREF	sputn__streambuf__TPCci
	XREF	_0dt__streambuf__T
	XREF	userword__ios__Ti
	XREF	init__ios__TP09streambuf
	XREF	_ftell
	XREF	_fseek
	XREF	_fwrite
	XREF	_fread
	XREF	_vfprintf
	XREF	_sprintf
	XREF	_fflush
	XREF	_feof
	XREF	_fclose
	XREF	_fopen
	XREF	_fgets
	XREF	_memset
	XREF	_memmove
	XREF	_strncpy
	XREF	op__delete__PvUi
	XREF	_std__in
	XREF	_std__out
	XREF	_std__err
	XREF	_basefield__ios
	XREF	_adjustfield__ios
	XREF	_floatfield__ios
	XREF	_aNextBit__ios
	XREF	_aNextWord__ios
	XREF	_cin
	XREF	_cout
	XREF	_cerr
	XREF	_clog
	XREF	_st
	XREF	_gxSt
	XREF	_errBuff__xBASELIB
	XREF	_errSev__xBASELIB
	XREF	_errTbl__xBASELIB
	XREF	_SysBase
	XREF	_IntuitionBase
	XREF	_DOSBase
	XREF	_sysData__sysBASELIB
	XREF	_msgbuff__sysBASELIB
	XREF	_main__sysBASELIB
	XREF	_allocated__MEM
	XREF	_totSize__MEM
	XREF	_nextFree__MEM
	XREF	_cnt__MEM
	XREF	_maxAllocs__MEM
	XREF	_GfxBase
	XREF	_TimerBase
	XREF	_TimerBase__xTIMABLE
	XREF	_current__xTIMABLE
	XREF	_clockFreq__xTIMABLE
	XREF	_threadCnt__xTHREADABLE
	XREF	_main__xTHREADABLE
	XREF	_CyberGfxBase
	XREF	_Warp3DBase
	XREF	_graphics__x2D
	XREF	_cyberGfx__x2D
	XREF	_formatNames__x2D
	XREF	_surfaceTypes__x2D
	XREF	_warp3D__x3D
	XREF	_hw3D__x3D
	XREF	_pointRender__x3D
	XREF	_lineRender__x3D
	XREF	_triangleRender__x3D
	XREF	_otherPrimitives__x3D
	XREF	_shadingModes__x3D
	XREF	_textureModes__x3D
	XREF	_textureFmts__x3D
	XREF	_alpha__x3D
	XREF	_fogModes__x3D
	XREF	_zBuffer__x3D
	XREF	_stencil__x3D
	XREF	_misc__x3D
	XREF	_primNames__x3D
	XREF	_renderNames__x3D
	XREF	_shadingNames__x3D
	XREF	_texModeNames__x3D
	XREF	_texFormatNames__x3D
	XREF	_alphaNames__x3D
	XREF	_fogNames__x3D
	XREF	_zBufferNames__x3D
	XREF	_stencilNames__x3D
	XREF	_miscNames__x3D
	XREF	_drawSurface__x3D
	XREF	_context__x3D
	XREF	_drawRegion__x3D
	XREF	_fogData__x3D
	XREF	_flags__xGFX
	XREF	_mode__xGFX
	XREF	_numModes__xGFX
	XREF	_rPool__xSURFACE
	XREF	_DiskfontBase
	XREF	_fontInfo__xDRAW
	XREF	_fontData__xDRAW
	XREF	_fonts__xDRAW
	XREF	_flags__xDRAW
	XREF	_flushCnt__xDRAW
	XREF	_cTab__xDRAW
	XREF	_sTab__xDRAW
	XREF	_fault__xDRAW
	XREF	_vBufPos__xDRAW
	XREF	_zDepth__xDRAW
	XREF	_maxVBufPos__xDRAW
	XREF	_vArraySize__xDRAW
	XREF	_vArray__xDRAW
	XREF	_vBuffer__xDRAW
	XREF	_nestCount__xDRAW
	XREF	_currentCol__xDRAW
	XREF	_sineData__QTRIG
	XREF	_gradData__QTRIG
	XREF	_vCachePtr__AXON
	XREF	_vCache__AXON
	XREF	_heap__TEXTUREHEAP
	XREF	_keys__TEXTUREHEAP
	XREF	_index__TEXTUREHEAP
	XREF	_heapSize__TEXTUREHEAP
	XREF	_lastTexture__TEXTUREHEAP
	XREF	_lastKey__TEXTUREHEAP
	XREF	_count__PINETREE
	XREF	_texture__PINETREE
	XREF	_points__PINETREE
	XREF	_count__BUILDING
	XREF	_texture__BUILDING
	XREF	_points__BUILDING

	SECTION "_0ct__streampos__T:0",CODE

	rts

	SECTION "_dimension__WORLDMAP:1",DATA

	XDEF	_dimension__WORLDMAP
_dimension__WORLDMAP
	dc.l	0

	SECTION "_logDim__WORLDMAP:1",DATA

	XDEF	_logDim__WORLDMAP
_logDim__WORLDMAP
	dc.l	0

	SECTION "_fracLimit__WORLDMAP:1",DATA

	XDEF	_fracLimit__WORLDMAP
_fracLimit__WORLDMAP
	dc.l	0

	SECTION "_worldGrid__WORLDMAP:1",DATA

	XDEF	_worldGrid__WORLDMAP
_worldGrid__WORLDMAP
	dc.l	0

	SECTION "_minZ__WORLDMAP:1",DATA

	XDEF	_minZ__WORLDMAP
_minZ__WORLDMAP
	dc.l	$BDCCCCCD

	SECTION "_maxZ__WORLDMAP:1",DATA

	XDEF	_maxZ__WORLDMAP
_maxZ__WORLDMAP
	dc.l	$3DCCCCCD

	SECTION "_floodLevel__WORLDMAP:1",DATA

	XDEF	_floodLevel__WORLDMAP
_floodLevel__WORLDMAP
	dc.l	0

	SECTION "_scale__WORLDMAP:1",DATA

	XDEF	_scale__WORLDMAP
_scale__WORLDMAP
	dc.l	$3F800000

	SECTION "_unitName__WORLDMAP:1",DATA

	XDEF	_unitName__WORLDMAP
_unitName__WORLDMAP
	dc.l	0

	SECTION "_detailLevel__WORLDMAP:1",DATA

	XDEF	_detailLevel__WORLDMAP
_detailLevel__WORLDMAP
	dc.l	0

	SECTION "_frames__WORLDMAP:1",DATA

	XDEF	_frames__WORLDMAP
_frames__WORLDMAP
	dc.l	0

	SECTION "_frameTime__WORLDMAP:1",DATA

	XDEF	_frameTime__WORLDMAP
_frameTime__WORLDMAP
	dc.l	0

	SECTION "_totalTime__WORLDMAP:1",DATA

	XDEF	_totalTime__WORLDMAP
_totalTime__WORLDMAP
	dc.l	0

	SECTION "_stopWatch__WORLDMAP:0",CODE


	XDEF	_INIT_8_World_cpp__stopWatch__WORLDMAP
_INIT_8_World_cpp__stopWatch__WORLDMAP
	XREF	sym_handlers
L435	EQU	-$10
	link	a5,#L435
	movem.l	d2/a2/a3/a6,-(a7)
L429
;xTIMER			WORLDMAP::stopWatch;
	lea	_stopWatch__WORLDMAP,a0
	move.l	a0,a2
	moveq	#$32,d2
	move.l	sym_handlers,-4(a5)
	move.l	a2,a3
	tst.l	_TimerBase__xTIMABLE
	bne.b	L431
L430
	move.l	_SysBase,a1
	lea	$15E(a1),a0
	move.l	_SysBase,a6
	move.l	#L428,a1
	jsr	-$114(a6)
	move.l	d0,_TimerBase__xTIMABLE
	move.l	_TimerBase,a6
	move.l	#_current__xTIMABLE,a0
	jsr	-$3C(a6)
	move.l	d0,_clockFreq__xTIMABLE
L431
	lea	-4(a5),a0
	move.l	a3,-(a0)
	move.l	#_0dt__xTIMABLE__T,-(a0)
	move.l	sym_handlers,-(a0)
	move.l	a0,sym_handlers
	move.l	d2,d0
	move.l	a2,a0
	cmp.l	#1,d0
	bls.b	L433
L432
	bra.b	L434
L433
	moveq	#1,d0
L434
	move.l	d0,$14(a0)
	move.l	$14(a0),d0
	mulu.l	_clockFreq__xTIMABLE,d0
	divul.l	#$3E8,d0
	move.l	d0,$10(a0)
	move.l	_TimerBase,a6
	move.l	#_current__xTIMABLE,a0
	jsr	-$3C(a6)
	lea	_current__xTIMABLE,a1
	lea	$8(a2),a0
	move.l	(a1),(a0)
	move.l	4(a1),4(a0)
	lea	_current__xTIMABLE,a1
	move.l	a2,a0
	move.l	(a1),(a0)
	move.l	4(a1),4(a0)
	move.l	-4(a5),sym_handlers
	movem.l	(a7)+,d2/a2/a3/a6
	unlk	a5
	rts

L428
	dc.b	'timer.device',0

	SECTION "_stopWatch__WORLDMAP:2",BSS

	XDEF	_stopWatch__WORLDMAP
_stopWatch__WORLDMAP
	ds.b	24

	SECTION "_cell__WORLDMAP:1",DATA

	XDEF	_cell__WORLDMAP
_cell__WORLDMAP
	dc.l	0

	SECTION "_visible__WORLDMAP:1",DATA

	XDEF	_visible__WORLDMAP
_visible__WORLDMAP
	dc.l	0

	SECTION "_wet__WORLDMAP:1",DATA

	XDEF	_wet__WORLDMAP
_wet__WORLDMAP
	dc.l	0

	SECTION "_things__WORLDMAP:1",DATA

	XDEF	_things__WORLDMAP
_things__WORLDMAP
	dc.l	0

	SECTION "_ground__WORLDMAP:0",CODE


	XDEF	_INIT_8_World_cpp__ground__WORLDMAP
_INIT_8_World_cpp__ground__WORLDMAP
L441
;xTEXTURE*		WORLDMAP::ground[MAX_GROUND_TEXTURES]	= {0};
	move.l	#_ground__WORLDMAP,a0
	lea	4(a0),a0
	moveq	#$E,d0
L442
	clr.l	(a0)+
	dbra	d0,L442
	rts

	SECTION "_ground__WORLDMAP:1",DATA

	XDEF	_ground__WORLDMAP
_ground__WORLDMAP
	dc.l	0
	ds.b	60

	SECTION "_water__WORLDMAP:0",CODE


	XDEF	_INIT_8_World_cpp__water__WORLDMAP
_INIT_8_World_cpp__water__WORLDMAP
L443
;xTEXTURE*		WORLDMAP::water[MAX_WATER_TEXTURES]		= {0};
	move.l	#_water__WORLDMAP,a0
	lea	4(a0),a0
	moveq	#6,d0
L444
	clr.l	(a0)+
	dbra	d0,L444
	rts

	SECTION "_water__WORLDMAP:1",DATA

	XDEF	_water__WORLDMAP
_water__WORLDMAP
	dc.l	0
	ds.b	28

	SECTION "Init__WORLDMAP__UjffffPc:0",CODE


;sint32 WORLDMAP::Init(uint32 dim, float32 s, float32 fracture, float
	XDEF	Init__WORLDMAP__UjffffPc
Init__WORLDMAP__UjffffPc
L653	EQU	-$60
	link	a5,#L653
	movem.l	d2-d6/a2/a6,-(a7)
	fmovem.x fp2/fp3/fp4/fp5,-(a7)
	move.l	$8(a5),d0
	move.l	$1C(a5),a0
	fmove.s	$C(a5),fp0
	fmove.s	$14(a5),fp1
	fmove.s	$10(a5),fp3
	fmove.s	$18(a5),fp4
L462
;	if (uName)
	cmp.w	#0,a0
	beq.b	L464
L463
;		unitName = uName;
	move.l	a0,_unitName__WORLDMAP
L464
;	if (s > 0)
	fcmp.s	#$.00000000,fp0
	fbole.b	L466
L465
;		scale = s;
	fmove.s	fp0,_scale__WORLDMAP
L466
;	minZ			 = ClipFloat(-(scale/2F), 0F, zmin);
	fmove.x	fp1,fp2
	fmove.s	#$.00000000,fp1
	fmove.s	_scale__WORLDMAP,fp0
	fdiv.s	#$.40000000,fp0
	fneg.s	fp0
	fcmp.x	fp1,fp0
	fboge.b	L468
L467
	fmove.x	fp1,fp0
	bra.b	L472
L468
	fcmp.x	fp2,fp0
	fbole.b	L470
L469
	fmove.x	fp2,fp0
L470
L471
L472
	fmove.s	fp0,_minZ__WORLDMAP
;	maxZ			 = ClipFloat(0F, (scale/2F), zmax);
	fmove.x	fp4,fp2
	fmove.s	_scale__WORLDMAP,fp1
	fdiv.s	#$.40000000,fp1
	fmove.s	#$.00000000,fp0
	fcmp.x	fp1,fp0
	fboge.b	L474
L473
	fmove.x	fp1,fp0
	bra.b	L478
L474
	fcmp.x	fp2,fp0
	fbole.b	L476
L475
	fmove.x	fp2,fp0
L476
L477
L478
	fmove.s	fp0,_maxZ__WORLDMAP
;	logDim		 = ClipInt(dim, 1, 8);
	moveq	#$8,d2
	moveq	#1,d1
	cmp.l	d1,d0
	bge.b	L480
L479
	move.l	d1,d0
	bra.b	L484
L480
	cmp.l	d2,d0
	ble.b	L482
L481
	move.l	d2,d0
L482
L483
L484
	move.l	d0,_logDim__WORLDMAP
;	fracLimit	 = ClipFloat(fracture, 0F, scale/20F);
	fmove.s	_scale__WORLDMAP,fp2
	fdiv.s	#$.41A00000,fp2
	fmove.s	#$.00000000,fp1
	fmove.x	fp3,fp0
	fcmp.x	fp1,fp0
	fboge.b	L486
L485
	fmove.x	fp1,fp0
	bra.b	L490
L486
	fcmp.x	fp2,fp0
	fbole.b	L488
L487
	fmove.x	fp2,fp0
L488
L489
L490
	fmove.s	fp0,_fracLimit__WORLDMAP
;	cout << "WORLDMAP::Init() : Initialising resources...";
	move.l	#L445,-(a7)
	move.l	_cout,a0
	cmp.w	#0,a0
	beq.b	L492
L491
	addq.w	#4,a0
L492
	move.l	a0,-(a7)
	jsr	op__leftshift__ostream__TPCc
	addq.w	#$8,a7
;	
;		ground[0] = TEXTUREHEAP::UsePPM("data/ground.ppm");
	move.l	#-$1000000,-(a7)
	move.l	#L446,-(a7)
	jsr	UsePPM__TEXTUREHEAP__PCcUj
	addq.w	#$8,a7
	move.l	#_ground__WORLDMAP,a1
	move.l	d0,(a1)
;		if (!ground[0])
	move.l	#_ground__WORLDMAP,a0
	tst.l	(a0)
	bne.b	L496
L493
;		
;			cout << "Error reading texture\n";
	move.l	#L447,-(a7)
	move.l	_cout,a0
	cmp.w	#0,a0
	beq.b	L495
L494
	addq.w	#4,a0
L495
	move.l	a0,-(a7)
	jsr	op__leftshift__ostream__TPCc
	addq.w	#$8,a7
;			Done();
	jsr	Done__WORLDMAP_
	move.l	#-$3050000,d0
	fmovem.x (a7)+,fp2/fp3/fp4/fp5
	movem.l	(a7)+,d2-d6/a2/a6
	unlk	a5
	rts
L496
;		
;			ground[0]->SetEnv(xTEXTURE::MODULATE);
	move.l	#_ground__WORLDMAP,a1
	move.l	(a1),a0
	move.l	$10(a0),a1
	move.l	_Warp3DBase,a6
	moveq	#3,d1
	move.l	$C(a0),a0
	sub.l	a2,a2
	jsr	-$7E(a6)
;			ground[0]->SetFilter(xTEXTURE::LINEAR);
	move.l	#_ground__WORLDMAP,a1
	move.l	(a1),a0
	move.l	$10(a0),a1
	move.l	_Warp3DBase,a6
	moveq	#1,d0
	moveq	#2,d1
	move.l	$C(a0),a0
	jsr	-$78(a6)
;	
;		char waterName[] = "data/rip0.tex";
	move.l	#L448,a1
	lea	-$E(a5),a0
	moveq	#6,d0
L654
	move.w	(a1)+,(a0)+
	dbra	d0,L654
;		for (sint32 i = 0;
	moveq	#0,d2
	bra	L503
L497
;		
;			sprintf(waterName, "data/rip%d.tex", i);
	move.l	d2,-(a7)
	move.l	#L449,-(a7)
	pea	-$E(a5)
	jsr	_sprintf
	add.w	#$C,a7
;			water[i] = TEXTUREHEAP::UseTex(waterName);
	move.l	#-1,-(a7)
	pea	-$E(a5)
	jsr	UseTex__TEXTUREHEAP__PCcj
	addq.w	#$8,a7
	move.l	#_water__WORLDMAP,a1
	move.l	d0,0(a1,d2.l*4)
;			if (!water[i])
	move.l	#_water__WORLDMAP,a1
	tst.l	0(a1,d2.l*4)
	bne.b	L501
L498
;			
;				cout << "Error reading texture " << waterName << "\n";
	move.l	#L450,-(a7)
	pea	-$E(a5)
	move.l	#L451,-(a7)
	move.l	_cout,a0
	cmp.w	#0,a0
	beq.b	L500
L499
	addq.w	#4,a0
L500
	move.l	a0,-(a7)
	jsr	op__leftshift__ostream__TPCc
	addq.w	#$8,a7
	move.l	d0,-(a7)
	jsr	op__leftshift__ostream__TPCc
	addq.w	#$8,a7
	move.l	d0,-(a7)
	jsr	op__leftshift__ostream__TPCc
	addq.w	#$8,a7
;				Done();
	jsr	Done__WORLDMAP_
	bra.b	L502
L501
;			
;				water[i]->SetEnv(xTEXTURE::MODULATE);
	move.l	#_water__WORLDMAP,a1
	move.l	0(a1,d2.l*4),a0
	move.l	$10(a0),a1
	move.l	_Warp3DBase,a6
	moveq	#3,d1
	move.l	$C(a0),a0
	sub.l	a2,a2
	jsr	-$7E(a6)
;				water[i]->SetFilter(xTEXTURE::LINEAR);
	move.l	#_water__WORLDMAP,a1
	move.l	0(a1,d2.l*4),a0
	move.l	$10(a0),a1
	move.l	_Warp3DBase,a6
	moveq	#1,d0
	moveq	#2,d1
	move.l	$C(a0),a0
	jsr	-$78(a6)
L502
	addq.l	#1,d2
L503
	cmp.l	#$8,d2
	blt	L497
L504
;	dimension = 1<<logDim;
	moveq	#1,d0
	move.l	_logDim__WORLDMAP,d1
	asl.l	d1,d0
	move.l	d0,_dimension__WORLDMAP
;	cell = New(cell, dimension*dimension);
	move.l	_dimension__WORLDMAP,d3
	mulu.l	_dimension__WORLDMAP,d3
	moveq	#1,d2
	move.l	d3,d0
	moveq	#$8,d1
	asl.l	d1,d0
	move.l	d0,d1
	addq.l	#$8,d1
	tst.l	_allocated__MEM
	bne.b	L506
L505
	sub.l	a0,a0
	bra	L520
L506
	move.w	d2,d0
	move.l	d1,d4
	move.l	_cnt__MEM,d1
	cmp.l	#$200,d1
	bne.b	L508
L507
	move.l	#L452,-(a7)
	move.l	#L453,-(a7)
	move.l	#L454,-(a7)
	jsr	MessageBox__sysBASELIB__PcPcPce
	add.w	#$C,a7
	move.l	#-$3010002,d0
	bra	L517
L508
	cmp.w	#1,d0
	bne.b	L510
L509
	move.l	#$10001,d1
	bra.b	L511
L510
	moveq	#1,d1
L511
	move.l	_SysBase,a6
	move.l	d4,d0
	jsr	-$2AC(a6)
	move.l	d0,a0
	cmp.w	#0,a0
	beq	L516
L512
	move.l	_nextFree__MEM,d2
	move.l	d2,d0
	muls.l	#$C,d0
	move.l	_allocated__MEM,a2
	move.l	a0,0(a2,d0.l)
	move.l	_SysBase,a6
	sub.l	a1,a1
	jsr	-$126(a6)
	move.l	d2,d1
	muls.l	#$C,d1
	move.l	_allocated__MEM,a1
	move.l	d0,4(a1,d1.l)
	move.l	d2,d0
	muls.l	#$C,d0
	move.l	_allocated__MEM,a1
	move.l	d4,$8(a1,d0.l)
	add.l	d4,_totSize__MEM
	addq.l	#1,_cnt__MEM
	bra.b	L514
L513
	addq.l	#1,_nextFree__MEM
L514
	move.l	_nextFree__MEM,d0
	muls.l	#$C,d0
	move.l	_allocated__MEM,a1
	move.l	0(a1,d0.l),a0
	cmp.w	#0,a0
	bne.b	L513
L515
	move.l	d2,d0
	bra.b	L517
L516
	move.l	#-$3030001,d0
L517
	tst.l	d0
	bmi.b	L519
L518
	muls.l	#$C,d0
	move.l	_allocated__MEM,a1
	move.l	0(a1,d0.l),a0
	bra.b	L520
L519
	sub.l	a0,a0
L520
	cmp.w	#0,a0
	beq.b	L527
L521
	move.l	d3,(a0)
	move.l	#$100,4(a0)
	move.l	a0,d0
	addq.l	#$8,d0
	move.l	d0,a6
	moveq	#0,d2
	bra.b	L525
L522
	move.l	d2,d0
	asl.l	#$8,d0
	lea	0(a6,d0.l),a0
	cmp.w	#0,a0
	beq.b	L524
L523
	move.l	a0,-(a7)
	jsr	_0ct__MAPCELL__T
	addq.w	#4,a7
L524
	addq.l	#1,d2
L525
	cmp.l	d3,d2
	blo.b	L522
L526
	bra.b	L528
L527
	sub.l	a6,a6
L528
	move.l	a6,_cell__WORLDMAP
;	if (!cell)
	tst.l	_cell__WORLDMAP
	bne.b	L530
L529
;	
;		Done();
	jsr	Done__WORLDMAP_
	move.l	#-$3030001,d0
	fmovem.x (a7)+,fp2/fp3/fp4/fp5
	movem.l	(a7)+,d2-d6/a2/a6
	unlk	a5
	rts
L530
;	visible = New(visible, (2*dimension*dimension)+2);
	move.l	_dimension__WORLDMAP,d2
	moveq	#1,d0
	asl.l	d0,d2
	mulu.l	_dimension__WORLDMAP,d2
	addq.l	#2,d2
	moveq	#1,d3
	move.l	d2,d0
	moveq	#2,d1
	asl.l	d1,d0
	move.l	d0,d1
	addq.l	#$8,d1
	tst.l	_allocated__MEM
	bne.b	L532
L531
	sub.l	a0,a0
	bra	L546
L532
	move.w	d3,d0
	move.l	d1,d4
	move.l	_cnt__MEM,d1
	cmp.l	#$200,d1
	bne.b	L534
L533
	move.l	#L452,-(a7)
	move.l	#L453,-(a7)
	move.l	#L454,-(a7)
	jsr	MessageBox__sysBASELIB__PcPcPce
	add.w	#$C,a7
	move.l	#-$3010002,d0
	bra	L543
L534
	cmp.w	#1,d0
	bne.b	L536
L535
	move.l	#$10001,d1
	bra.b	L537
L536
	moveq	#1,d1
L537
	move.l	_SysBase,a6
	move.l	d4,d0
	jsr	-$2AC(a6)
	move.l	d0,a0
	cmp.w	#0,a0
	beq	L542
L538
	move.l	_nextFree__MEM,d3
	move.l	d3,d0
	muls.l	#$C,d0
	move.l	_allocated__MEM,a2
	move.l	a0,0(a2,d0.l)
	move.l	_SysBase,a6
	sub.l	a1,a1
	jsr	-$126(a6)
	move.l	d3,d1
	muls.l	#$C,d1
	move.l	_allocated__MEM,a1
	move.l	d0,4(a1,d1.l)
	move.l	d3,d0
	muls.l	#$C,d0
	move.l	_allocated__MEM,a1
	move.l	d4,$8(a1,d0.l)
	add.l	d4,_totSize__MEM
	addq.l	#1,_cnt__MEM
	bra.b	L540
L539
	addq.l	#1,_nextFree__MEM
L540
	move.l	_nextFree__MEM,d0
	muls.l	#$C,d0
	move.l	_allocated__MEM,a1
	move.l	0(a1,d0.l),a0
	cmp.w	#0,a0
	bne.b	L539
L541
	move.l	d3,d0
	bra.b	L543
L542
	move.l	#-$3030001,d0
L543
	tst.l	d0
	bmi.b	L545
L544
	muls.l	#$C,d0
	move.l	_allocated__MEM,a1
	move.l	0(a1,d0.l),a0
	bra.b	L546
L545
	sub.l	a0,a0
L546
	cmp.w	#0,a0
	beq.b	L551
L547
	move.l	d2,(a0)
	move.l	#4,4(a0)
	move.l	a0,d0
	addq.l	#$8,d0
	move.l	d0,a0
	moveq	#0,d0
	bra.b	L549
L548
	addq.l	#1,d0
L549
	cmp.l	d2,d0
	blo.b	L548
L550
	bra.b	L552
L551
	sub.l	a0,a0
L552
	move.l	a0,_visible__WORLDMAP
;	if (!visible)
	tst.l	_visible__WORLDMAP
	bne.b	L554
L553
;	
;		Done();
	jsr	Done__WORLDMAP_
	move.l	#-$3030001,d0
	fmovem.x (a7)+,fp2/fp3/fp4/fp5
	movem.l	(a7)+,d2-d6/a2/a6
	unlk	a5
	rts
L554
;	wet = visible + (dimension*dimension)+1;
	move.l	_dimension__WORLDMAP,d0
	mulu.l	_dimension__WORLDMAP,d0
	move.l	_visible__WORLDMAP,a1
	lea	0(a1,d0.l*4),a0
	moveq	#4,d0
	add.l	a0,d0
	move.l	d0,_wet__WORLDMAP
;	things = New(things, MAX_VIS_MODELS+1);
	move.l	#$800,d2
	moveq	#1,d3
	move.l	d2,d0
	moveq	#2,d1
	asl.l	d1,d0
	move.l	d0,d1
	addq.l	#$8,d1
	tst.l	_allocated__MEM
	bne.b	L556
L555
	sub.l	a0,a0
	bra	L570
L556
	move.w	d3,d0
	move.l	d1,d4
	move.l	_cnt__MEM,d1
	cmp.l	#$200,d1
	bne.b	L558
L557
	move.l	#L452,-(a7)
	move.l	#L453,-(a7)
	move.l	#L454,-(a7)
	jsr	MessageBox__sysBASELIB__PcPcPce
	add.w	#$C,a7
	move.l	#-$3010002,d0
	bra	L567
L558
	cmp.w	#1,d0
	bne.b	L560
L559
	move.l	#$10001,d1
	bra.b	L561
L560
	moveq	#1,d1
L561
	move.l	_SysBase,a6
	move.l	d4,d0
	jsr	-$2AC(a6)
	move.l	d0,a0
	cmp.w	#0,a0
	beq	L566
L562
	move.l	_nextFree__MEM,d3
	move.l	d3,d0
	muls.l	#$C,d0
	move.l	_allocated__MEM,a2
	move.l	a0,0(a2,d0.l)
	move.l	_SysBase,a6
	sub.l	a1,a1
	jsr	-$126(a6)
	move.l	d3,d1
	muls.l	#$C,d1
	move.l	_allocated__MEM,a1
	move.l	d0,4(a1,d1.l)
	move.l	d3,d0
	muls.l	#$C,d0
	move.l	_allocated__MEM,a1
	move.l	d4,$8(a1,d0.l)
	add.l	d4,_totSize__MEM
	addq.l	#1,_cnt__MEM
	bra.b	L564
L563
	addq.l	#1,_nextFree__MEM
L564
	move.l	_nextFree__MEM,d0
	muls.l	#$C,d0
	move.l	_allocated__MEM,a1
	move.l	0(a1,d0.l),a0
	cmp.w	#0,a0
	bne.b	L563
L565
	move.l	d3,d0
	bra.b	L567
L566
	move.l	#-$3030001,d0
L567
	tst.l	d0
	bmi.b	L569
L568
	muls.l	#$C,d0
	move.l	_allocated__MEM,a1
	move.l	0(a1,d0.l),a0
	bra.b	L570
L569
	sub.l	a0,a0
L570
	cmp.w	#0,a0
	beq.b	L575
L571
	move.l	d2,(a0)
	move.l	#4,4(a0)
	move.l	a0,d0
	addq.l	#$8,d0
	move.l	d0,a0
	moveq	#0,d0
	bra.b	L573
L572
	addq.l	#1,d0
L573
	cmp.l	d2,d0
	blo.b	L572
L574
	bra.b	L576
L575
	sub.l	a0,a0
L576
	move.l	a0,_things__WORLDMAP
;	if (!things)
	tst.l	_things__WORLDMAP
	bne.b	L578
L577
;	
;		Done();
	jsr	Done__WORLDMAP_
	move.l	#-$3030001,d0
	fmovem.x (a7)+,fp2/fp3/fp4/fp5
	movem.l	(a7)+,d2-d6/a2/a6
	unlk	a5
	rts
L578
;	worldGrid = New(worldGrid, (dimension+1)*(dimension+1));
	move.l	_dimension__WORLDMAP,d2
	addq.l	#1,d2
	move.l	_dimension__WORLDMAP,d0
	addq.l	#1,d0
	mulu.l	d0,d2
	moveq	#1,d3
	move.l	d2,d0
	mulu.l	#$18,d0
	move.l	d0,d1
	addq.l	#$8,d1
	tst.l	_allocated__MEM
	bne.b	L580
L579
	sub.l	a0,a0
	bra	L594
L580
	move.w	d3,d0
	move.l	d1,d4
	move.l	_cnt__MEM,d1
	cmp.l	#$200,d1
	bne.b	L582
L581
	move.l	#L452,-(a7)
	move.l	#L453,-(a7)
	move.l	#L454,-(a7)
	jsr	MessageBox__sysBASELIB__PcPcPce
	add.w	#$C,a7
	move.l	#-$3010002,d0
	bra	L591
L582
	cmp.w	#1,d0
	bne.b	L584
L583
	move.l	#$10001,d1
	bra.b	L585
L584
	moveq	#1,d1
L585
	move.l	_SysBase,a6
	move.l	d4,d0
	jsr	-$2AC(a6)
	move.l	d0,a0
	cmp.w	#0,a0
	beq	L590
L586
	move.l	_nextFree__MEM,d3
	move.l	d3,d0
	muls.l	#$C,d0
	move.l	_allocated__MEM,a2
	move.l	a0,0(a2,d0.l)
	move.l	_SysBase,a6
	sub.l	a1,a1
	jsr	-$126(a6)
	move.l	d3,d1
	muls.l	#$C,d1
	move.l	_allocated__MEM,a1
	move.l	d0,4(a1,d1.l)
	move.l	d3,d0
	muls.l	#$C,d0
	move.l	_allocated__MEM,a1
	move.l	d4,$8(a1,d0.l)
	add.l	d4,_totSize__MEM
	addq.l	#1,_cnt__MEM
	bra.b	L588
L587
	addq.l	#1,_nextFree__MEM
L588
	move.l	_nextFree__MEM,d0
	muls.l	#$C,d0
	move.l	_allocated__MEM,a1
	move.l	0(a1,d0.l),a0
	cmp.w	#0,a0
	bne.b	L587
L589
	move.l	d3,d0
	bra.b	L591
L590
	move.l	#-$3030001,d0
L591
	tst.l	d0
	bmi.b	L593
L592
	muls.l	#$C,d0
	move.l	_allocated__MEM,a1
	move.l	0(a1,d0.l),a0
	bra.b	L594
L593
	sub.l	a0,a0
L594
	cmp.w	#0,a0
	beq.b	L601
L595
	move.l	d2,(a0)
	move.l	#$18,4(a0)
	move.l	a0,d0
	addq.l	#$8,d0
	move.l	d0,a1
	moveq	#0,d0
	bra.b	L599
L596
	move.l	d0,d1
	muls.l	#$18,d1
	lea	0(a1,d1.l),a0
	cmp.w	#0,a0
L597
L598
	addq.l	#1,d0
L599
	cmp.l	d2,d0
	blo.b	L596
L600
	bra.b	L602
L601
	sub.l	a1,a1
L602
	move.l	a1,_worldGrid__WORLDMAP
;	if (!worldGrid)
	tst.l	_worldGrid__WORLDMAP
	bne.b	L604
L603
;	
;		Done();
	jsr	Done__WORLDMAP_
	move.l	#-$3030001,d0
	fmovem.x (a7)+,fp2/fp3/fp4/fp5
	movem.l	(a7)+,d2-d6/a2/a6
	unlk	a5
	rts
L604
;	cout << "done\n";
	move.l	#L455,-(a7)
	move.l	_cout,a0
	cmp.w	#0,a0
	beq.b	L606
L605
	addq.w	#4,a0
L606
	move.l	a0,-(a7)
	jsr	op__leftshift__ostream__TPCc
	addq.w	#$8,a7
;	
;		cout << "WORLDMAP::Init() : Generating surface...";
	move.l	#L456,-(a7)
	move.l	_cout,a0
	cmp.w	#0,a0
	beq.b	L608
L607
	addq.w	#4,a0
L608
	move.l	a0,-(a7)
	jsr	op__leftshift__ostream__TPCc
	addq.w	#$8,a7
;		GeneratePoints();
	jsr	GeneratePoints__WORLDMAP_
;		for (sint32 j=0;
	moveq	#0,d3
	bra	L622
L609
;		
;			for (sint32 i=0;
	moveq	#0,d2
	bra	L620
L610
;			
;				ruint32 c = (i&1) ? ((j&1) ? 0xFF808080:0xFFFFFFFF) : ((j&1)
	move.l	d2,d0
	and.l	#1,d0
	beq.b	L615
L611
	move.l	d3,d0
	and.l	#1,d0
	beq.b	L613
L612
	move.l	#-$7F7F80,d1
	bra.b	L614
L613
	moveq	#-1,d1
L614
	bra.b	L619
L615
	move.l	d3,d0
	and.l	#1,d0
	beq.b	L617
L616
	moveq	#-1,d1
	bra.b	L618
L617
	move.l	#-$7F7F80,d1
L618
L619
;				sint32 bl = i+(j*(dimension+1));
	move.l	_dimension__WORLDMAP,d0
	addq.l	#1,d0
	mulu.l	d3,d0
	add.l	d2,d0
;				sint32 tl = i+((j+1)*(dimension+1));
	move.l	d3,d4
	addq.l	#1,d4
	move.l	_dimension__WORLDMAP,d5
	addq.l	#1,d5
	mulu.l	d5,d4
	add.l	d2,d4
;				Cell(i,j).Set(worldGrid[tl], worldGrid[tl+1], worldGrid[bl+1
	move.l	#_ground__WORLDMAP,a1
	move.l	(a1),-(a7)
	move.l	#_ground__WORLDMAP,a1
	move.l	(a1),-(a7)
	move.l	d1,-(a7)
	move.l	d0,d1
	muls.l	#$18,d1
	move.l	_worldGrid__WORLDMAP,a1
	pea	0(a1,d1.l)
	addq.l	#1,d0
	muls.l	#$18,d0
	move.l	_worldGrid__WORLDMAP,a1
	pea	0(a1,d0.l)
	move.l	d4,d0
	addq.l	#1,d0
	muls.l	#$18,d0
	move.l	_worldGrid__WORLDMAP,a1
	pea	0(a1,d0.l)
	muls.l	#$18,d4
	move.l	_worldGrid__WORLDMAP,a1
	pea	0(a1,d4.l)
	moveq	#0,d0
	move.w	d3,d0
	mulu.l	_dimension__WORLDMAP,d0
	moveq	#0,d1
	move.w	d2,d1
	add.l	d1,d0
	asl.l	#$8,d0
	move.l	_cell__WORLDMAP,a1
	pea	0(a1,d0.l)
	jsr	Set__MAPCELL__TR03C3DR03C3DR03C3DR03C3DUjP08xTEXTUREP08xTEXTURE
	add.w	#$20,a7
;inline uint32		ARGB4444ToCol32(ruint32 c)						
	addq.l	#1,d2
L620
	cmp.l	_dimension__WORLDMAP,d2
	blo	L610
L621
	addq.l	#1,d3
L622
	cmp.l	_dimension__WORLDMAP,d3
	blo	L609
L623
;				Cell(i,j).Set(worldGrid[tl], worldGrid[tl+1], worldGrid[bl+1
;		cout << "done\n";
	move.l	#L455,-(a7)
	move.l	_cout,a0
	cmp.w	#0,a0
	beq.b	L625
L624
	addq.w	#4,a0
L625
	move.l	a0,-(a7)
	jsr	op__leftshift__ostream__TPCc
	addq.w	#$8,a7
;	Delete(worldGrid);
	move.l	_worldGrid__WORLDMAP,a6
	cmp.w	#0,a6
	beq	L648
L626
	move.l	a6,d0
	subq.l	#$8,d0
	move.l	d0,a2
	moveq	#0,d2
	bra.b	L630
L627
	move.l	d2,d0
	muls.l	#$18,d0
	lea	0(a6,d0.l),a0
	cmp.w	#0,a0
	beq.b	L629
L628
	pea	$18.w
	move.l	a0,-(a7)
	jsr	op__delete__PvUi
	addq.w	#$8,a7
L629
	addq.l	#1,d2
L630
	move.l	a2,a0
	cmp.l	(a0),d2
	blo.b	L627
L631
	move.l	a2,a1
	tst.l	_allocated__MEM
	beq	L648
L632
	cmp.w	#0,a1
	beq	L647
L633
	moveq	#0,d0
	moveq	#0,d1
	bra.b	L635
L634
	move.l	d0,d1
	muls.l	#$C,d1
	move.l	_allocated__MEM,a2
	move.l	a1,d2
	cmp.l	0(a2,d1.l),d2
	seq	d2
	and.l	#1,d2
	move.l	d2,d1
	addq.l	#1,d0
L635
	tst.l	d1
	bne.b	L637
L636
	cmp.l	#$200,d0
	blt.b	L634
L637
	tst.l	d1
	bne.b	L639
L638
	move.l	#L457,-(a7)
	move.l	#L453,-(a7)
	move.l	#L454,-(a7)
	jsr	MessageBox__sysBASELIB__PcPcPce
	add.w	#$C,a7
	bra	L648
L639
	move.l	d0,d2
	subq.l	#1,d2
	cmp.l	#$200,d2
	blo.b	L641
L640
	move.l	#L458,-(a7)
	move.l	#L453,-(a7)
	move.l	#L454,-(a7)
	jsr	MessageBox__sysBASELIB__PcPcPce
	add.w	#$C,a7
	bra	L646
L641
	move.l	d2,d0
	muls.l	#$C,d0
	move.l	_allocated__MEM,a1
	move.l	0(a1,d0.l),a0
	cmp.w	#0,a0
	bne.b	L643
L642
	move.l	#L459,-(a7)
	move.l	#L453,-(a7)
	move.l	#L454,-(a7)
	jsr	MessageBox__sysBASELIB__PcPcPce
	add.w	#$C,a7
	bra	L646
L643
	move.l	d2,d0
	muls.l	#$C,d0
	move.l	_allocated__MEM,a1
	move.l	_SysBase,a6
	move.l	0(a1,d0.l),a1
	jsr	-$2B2(a6)
	move.l	d2,d0
	muls.l	#$C,d0
	move.l	_allocated__MEM,a1
	move.l	_totSize__MEM,d1
	sub.l	$8(a1,d0.l),d1
	move.l	d1,_totSize__MEM
	move.l	d2,d0
	muls.l	#$C,d0
	move.l	_allocated__MEM,a1
	clr.l	0(a1,d0.l)
	move.l	d2,d0
	muls.l	#$C,d0
	move.l	_allocated__MEM,a1
	clr.l	4(a1,d0.l)
	move.l	d2,d0
	muls.l	#$C,d0
	move.l	_allocated__MEM,a1
	clr.l	$8(a1,d0.l)
	subq.l	#1,_cnt__MEM
	cmp.l	_nextFree__MEM,d2
	bhs.b	L645
L644
	move.l	d2,_nextFree__MEM
L645
L646
	bra.b	L648
L647
	move.l	#L460,-(a7)
	move.l	#L453,-(a7)
	move.l	#L454,-(a7)
	jsr	MessageBox__sysBASELIB__PcPcPce
	add.w	#$C,a7
L648
;	worldGrid = NOTSET;
	clr.l	_worldGrid__WORLDMAP
;	cout << "WORLDMAP::Init() : Linking cells...";
	move.l	#L461,-(a7)
	move.l	_cout,a0
	cmp.w	#0,a0
	beq.b	L650
L649
	addq.w	#4,a0
L650
	move.l	a0,-(a7)
	jsr	op__leftshift__ostream__TPCc
	addq.w	#$8,a7
;	LinkCells();
	jsr	LinkCells__WORLDMAP_
;	cout << "done\n";
	move.l	#L455,-(a7)
	move.l	_cout,a0
	cmp.w	#0,a0
	beq.b	L652
L651
	addq.w	#4,a0
L652
	move.l	a0,-(a7)
	jsr	op__leftshift__ostream__TPCc
	addq.w	#$8,a7
	moveq	#0,d0
	fmovem.x (a7)+,fp2/fp3/fp4/fp5
	movem.l	(a7)+,d2-d6/a2/a6
	unlk	a5
	rts

L450
	dc.b	$A,0
L454
	dc.b	'Debug',0
L447
	dc.b	'Error reading texture',$A,0
L451
	dc.b	'Error reading texture ',0
L452
	dc.b	'MEM::AllocIndex()',$A,'Maximum allocation reached',0
L457
	dc.b	'MEM::Free()',$A,'Address not recognised',0
L460
	dc.b	'MEM::Free()',$A,'Attempt to free null address',0
L458
	dc.b	'MEM::FreeIndex()',$A,'Index overflow',0
L459
	dc.b	'MEM::FreeIndex()',$A,'Memory already free',0
L453
	dc.b	'Proceed',0
L456
	dc.b	'WORLDMAP::Init() : Generating surface...',0
L445
	dc.b	'WORLDMAP::Init() : Initialising resources...',0
L461
	dc.b	'WORLDMAP::Init() : Linking cells...',0
L446
	dc.b	'data/ground.ppm',0
L449
	dc.b	'data/rip%d.tex',0
L448
	dc.b	'data/rip0.tex',0
L455
	dc.b	'done',$A,0

	SECTION "Done__WORLDMAP_:0",CODE


;sint32 WORLDMAP::Done()
	XDEF	Done__WORLDMAP_
Done__WORLDMAP_
	movem.l	d2/a2/a3/a6,-(a7)
L661
;	
;		for (sint32 i = 0;
	moveq	#0,d2
	bra.b	L665
L662
;			if (ground[i]) 
	move.l	#_ground__WORLDMAP,a1
	tst.l	0(a1,d2.l*4)
	beq.b	L664
L663
;			if (ground[i]) ground[i]->Delete();
	move.l	#_ground__WORLDMAP,a1
	move.l	0(a1,d2.l*4),-(a7)
	jsr	Delete__xTEXTURE__T
	addq.w	#4,a7
L664
	addq.l	#1,d2
L665
	cmp.l	#$10,d2
	blt.b	L662
L666
;	
;		for (sint32 i = 0;
	moveq	#0,d2
	bra.b	L670
L667
;			if (water[i]) 
	move.l	#_water__WORLDMAP,a1
	tst.l	0(a1,d2.l*4)
	beq.b	L669
L668
;			if (water[i]) water[i]->Delete();
	move.l	#_water__WORLDMAP,a1
	move.l	0(a1,d2.l*4),-(a7)
	jsr	Delete__xTEXTURE__T
	addq.w	#4,a7
L669
	addq.l	#1,d2
L670
	cmp.l	#$8,d2
	blt.b	L667
L671
;	if (cell)
	tst.l	_cell__WORLDMAP
	beq	L696
L672
;		Delete(cell);
	move.l	_cell__WORLDMAP,a2
	cmp.w	#0,a2
	beq	L695
L673
	move.l	a2,d0
	subq.l	#$8,d0
	move.l	d0,a3
	moveq	#0,d2
	bra.b	L677
L674
	move.l	d2,d0
	asl.l	#$8,d0
	lea	0(a2,d0.l),a6
	cmp.w	#0,a6
	beq.b	L676
L675
	move.l	a6,-(a7)
	jsr	_0dt__MAPCELL__T
	addq.w	#4,a7
	pea	$100.w
	move.l	a6,-(a7)
	jsr	op__delete__PvUi
	addq.w	#$8,a7
L676
	addq.l	#1,d2
L677
	move.l	a3,a0
	cmp.l	(a0),d2
	blo.b	L674
L678
	move.l	a3,a1
	tst.l	_allocated__MEM
	beq	L695
L679
	cmp.w	#0,a1
	beq	L694
L680
	moveq	#0,d0
	moveq	#0,d1
	bra.b	L682
L681
	move.l	d0,d1
	muls.l	#$C,d1
	move.l	_allocated__MEM,a2
	move.l	a1,d2
	cmp.l	0(a2,d1.l),d2
	seq	d2
	and.l	#1,d2
	move.l	d2,d1
	addq.l	#1,d0
L682
	tst.l	d1
	bne.b	L684
L683
	cmp.l	#$200,d0
	blt.b	L681
L684
	tst.l	d1
	bne.b	L686
L685
	move.l	#L655,-(a7)
	move.l	#L656,-(a7)
	move.l	#L657,-(a7)
	jsr	MessageBox__sysBASELIB__PcPcPce
	add.w	#$C,a7
	bra	L695
L686
	move.l	d0,d2
	subq.l	#1,d2
	cmp.l	#$200,d2
	blo.b	L688
L687
	move.l	#L658,-(a7)
	move.l	#L656,-(a7)
	move.l	#L657,-(a7)
	jsr	MessageBox__sysBASELIB__PcPcPce
	add.w	#$C,a7
	bra	L693
L688
	move.l	d2,d0
	muls.l	#$C,d0
	move.l	_allocated__MEM,a1
	move.l	0(a1,d0.l),a0
	cmp.w	#0,a0
	bne.b	L690
L689
	move.l	#L659,-(a7)
	move.l	#L656,-(a7)
	move.l	#L657,-(a7)
	jsr	MessageBox__sysBASELIB__PcPcPce
	add.w	#$C,a7
	bra	L693
L690
	move.l	d2,d0
	muls.l	#$C,d0
	move.l	_allocated__MEM,a1
	move.l	_SysBase,a6
	move.l	0(a1,d0.l),a1
	jsr	-$2B2(a6)
	move.l	d2,d0
	muls.l	#$C,d0
	move.l	_allocated__MEM,a1
	move.l	_totSize__MEM,d1
	sub.l	$8(a1,d0.l),d1
	move.l	d1,_totSize__MEM
	move.l	d2,d0
	muls.l	#$C,d0
	move.l	_allocated__MEM,a1
	clr.l	0(a1,d0.l)
	move.l	d2,d0
	muls.l	#$C,d0
	move.l	_allocated__MEM,a1
	clr.l	4(a1,d0.l)
	move.l	d2,d0
	muls.l	#$C,d0
	move.l	_allocated__MEM,a1
	clr.l	$8(a1,d0.l)
	subq.l	#1,_cnt__MEM
	cmp.l	_nextFree__MEM,d2
	bhs.b	L692
L691
	move.l	d2,_nextFree__MEM
L692
L693
	bra.b	L695
L694
	move.l	#L660,-(a7)
	move.l	#L656,-(a7)
	move.l	#L657,-(a7)
	jsr	MessageBox__sysBASELIB__PcPcPce
	add.w	#$C,a7
L695
L696
;	if (visible)
	tst.l	_visible__WORLDMAP
	beq	L721
L697
;		Delete(visible);
	move.l	_visible__WORLDMAP,a6
	cmp.w	#0,a6
	beq	L720
L698
	move.l	a6,d0
	subq.l	#$8,d0
	move.l	d0,a2
	moveq	#0,d2
	bra.b	L702
L699
	lea	0(a6,d2.l*4),a0
	cmp.w	#0,a0
	beq.b	L701
L700
	pea	4.w
	move.l	a0,-(a7)
	jsr	op__delete__PvUi
	addq.w	#$8,a7
L701
	addq.l	#1,d2
L702
	move.l	a2,a0
	cmp.l	(a0),d2
	blo.b	L699
L703
	move.l	a2,a1
	tst.l	_allocated__MEM
	beq	L720
L704
	cmp.w	#0,a1
	beq	L719
L705
	moveq	#0,d0
	moveq	#0,d1
	bra.b	L707
L706
	move.l	d0,d1
	muls.l	#$C,d1
	move.l	_allocated__MEM,a2
	move.l	a1,d2
	cmp.l	0(a2,d1.l),d2
	seq	d2
	and.l	#1,d2
	move.l	d2,d1
	addq.l	#1,d0
L707
	tst.l	d1
	bne.b	L709
L708
	cmp.l	#$200,d0
	blt.b	L706
L709
	tst.l	d1
	bne.b	L711
L710
	move.l	#L655,-(a7)
	move.l	#L656,-(a7)
	move.l	#L657,-(a7)
	jsr	MessageBox__sysBASELIB__PcPcPce
	add.w	#$C,a7
	bra	L720
L711
	move.l	d0,d2
	subq.l	#1,d2
	cmp.l	#$200,d2
	blo.b	L713
L712
	move.l	#L658,-(a7)
	move.l	#L656,-(a7)
	move.l	#L657,-(a7)
	jsr	MessageBox__sysBASELIB__PcPcPce
	add.w	#$C,a7
	bra	L718
L713
	move.l	d2,d0
	muls.l	#$C,d0
	move.l	_allocated__MEM,a1
	move.l	0(a1,d0.l),a0
	cmp.w	#0,a0
	bne.b	L715
L714
	move.l	#L659,-(a7)
	move.l	#L656,-(a7)
	move.l	#L657,-(a7)
	jsr	MessageBox__sysBASELIB__PcPcPce
	add.w	#$C,a7
	bra	L718
L715
	move.l	d2,d0
	muls.l	#$C,d0
	move.l	_allocated__MEM,a1
	move.l	_SysBase,a6
	move.l	0(a1,d0.l),a1
	jsr	-$2B2(a6)
	move.l	d2,d0
	muls.l	#$C,d0
	move.l	_allocated__MEM,a1
	move.l	_totSize__MEM,d1
	sub.l	$8(a1,d0.l),d1
	move.l	d1,_totSize__MEM
	move.l	d2,d0
	muls.l	#$C,d0
	move.l	_allocated__MEM,a1
	clr.l	0(a1,d0.l)
	move.l	d2,d0
	muls.l	#$C,d0
	move.l	_allocated__MEM,a1
	clr.l	4(a1,d0.l)
	move.l	d2,d0
	muls.l	#$C,d0
	move.l	_allocated__MEM,a1
	clr.l	$8(a1,d0.l)
	subq.l	#1,_cnt__MEM
	cmp.l	_nextFree__MEM,d2
	bhs.b	L717
L716
	move.l	d2,_nextFree__MEM
L717
L718
	bra.b	L720
L719
	move.l	#L660,-(a7)
	move.l	#L656,-(a7)
	move.l	#L657,-(a7)
	jsr	MessageBox__sysBASELIB__PcPcPce
	add.w	#$C,a7
L720
L721
;	if (things)
	tst.l	_things__WORLDMAP
	beq	L746
L722
;		Delete(things);
	move.l	_things__WORLDMAP,a6
	cmp.w	#0,a6
	beq	L745
L723
	move.l	a6,d0
	subq.l	#$8,d0
	move.l	d0,a2
	moveq	#0,d2
	bra.b	L727
L724
	lea	0(a6,d2.l*4),a0
	cmp.w	#0,a0
	beq.b	L726
L725
	pea	4.w
	move.l	a0,-(a7)
	jsr	op__delete__PvUi
	addq.w	#$8,a7
L726
	addq.l	#1,d2
L727
	move.l	a2,a0
	cmp.l	(a0),d2
	blo.b	L724
L728
	move.l	a2,a1
	tst.l	_allocated__MEM
	beq	L745
L729
	cmp.w	#0,a1
	beq	L744
L730
	moveq	#0,d0
	moveq	#0,d1
	bra.b	L732
L731
	move.l	d0,d1
	muls.l	#$C,d1
	move.l	_allocated__MEM,a2
	move.l	a1,d2
	cmp.l	0(a2,d1.l),d2
	seq	d2
	and.l	#1,d2
	move.l	d2,d1
	addq.l	#1,d0
L732
	tst.l	d1
	bne.b	L734
L733
	cmp.l	#$200,d0
	blt.b	L731
L734
	tst.l	d1
	bne.b	L736
L735
	move.l	#L655,-(a7)
	move.l	#L656,-(a7)
	move.l	#L657,-(a7)
	jsr	MessageBox__sysBASELIB__PcPcPce
	add.w	#$C,a7
	bra	L745
L736
	move.l	d0,d2
	subq.l	#1,d2
	cmp.l	#$200,d2
	blo.b	L738
L737
	move.l	#L658,-(a7)
	move.l	#L656,-(a7)
	move.l	#L657,-(a7)
	jsr	MessageBox__sysBASELIB__PcPcPce
	add.w	#$C,a7
	bra	L743
L738
	move.l	d2,d0
	muls.l	#$C,d0
	move.l	_allocated__MEM,a1
	move.l	0(a1,d0.l),a0
	cmp.w	#0,a0
	bne.b	L740
L739
	move.l	#L659,-(a7)
	move.l	#L656,-(a7)
	move.l	#L657,-(a7)
	jsr	MessageBox__sysBASELIB__PcPcPce
	add.w	#$C,a7
	bra	L743
L740
	move.l	d2,d0
	muls.l	#$C,d0
	move.l	_allocated__MEM,a1
	move.l	_SysBase,a6
	move.l	0(a1,d0.l),a1
	jsr	-$2B2(a6)
	move.l	d2,d0
	muls.l	#$C,d0
	move.l	_allocated__MEM,a1
	move.l	_totSize__MEM,d1
	sub.l	$8(a1,d0.l),d1
	move.l	d1,_totSize__MEM
	move.l	d2,d0
	muls.l	#$C,d0
	move.l	_allocated__MEM,a1
	clr.l	0(a1,d0.l)
	move.l	d2,d0
	muls.l	#$C,d0
	move.l	_allocated__MEM,a1
	clr.l	4(a1,d0.l)
	move.l	d2,d0
	muls.l	#$C,d0
	move.l	_allocated__MEM,a1
	clr.l	$8(a1,d0.l)
	subq.l	#1,_cnt__MEM
	cmp.l	_nextFree__MEM,d2
	bhs.b	L742
L741
	move.l	d2,_nextFree__MEM
L742
L743
	bra.b	L745
L744
	move.l	#L660,-(a7)
	move.l	#L656,-(a7)
	move.l	#L657,-(a7)
	jsr	MessageBox__sysBASELIB__PcPcPce
	add.w	#$C,a7
L745
L746
;	if (worldGrid)
	tst.l	_worldGrid__WORLDMAP
	beq	L771
L747
;		Delete(worldGrid);
	move.l	_worldGrid__WORLDMAP,a6
	cmp.w	#0,a6
	beq	L770
L748
	move.l	a6,d0
	subq.l	#$8,d0
	move.l	d0,a2
	moveq	#0,d2
	bra.b	L752
L749
	move.l	d2,d0
	muls.l	#$18,d0
	lea	0(a6,d0.l),a0
	cmp.w	#0,a0
	beq.b	L751
L750
	pea	$18.w
	move.l	a0,-(a7)
	jsr	op__delete__PvUi
	addq.w	#$8,a7
L751
	addq.l	#1,d2
L752
	move.l	a2,a0
	cmp.l	(a0),d2
	blo.b	L749
L753
	move.l	a2,a1
	tst.l	_allocated__MEM
	beq	L770
L754
	cmp.w	#0,a1
	beq	L769
L755
	moveq	#0,d0
	moveq	#0,d1
	bra.b	L757
L756
	move.l	d0,d1
	muls.l	#$C,d1
	move.l	_allocated__MEM,a2
	move.l	a1,d2
	cmp.l	0(a2,d1.l),d2
	seq	d2
	and.l	#1,d2
	move.l	d2,d1
	addq.l	#1,d0
L757
	tst.l	d1
	bne.b	L759
L758
	cmp.l	#$200,d0
	blt.b	L756
L759
	tst.l	d1
	bne.b	L761
L760
	move.l	#L655,-(a7)
	move.l	#L656,-(a7)
	move.l	#L657,-(a7)
	jsr	MessageBox__sysBASELIB__PcPcPce
	add.w	#$C,a7
	bra	L770
L761
	move.l	d0,d2
	subq.l	#1,d2
	cmp.l	#$200,d2
	blo.b	L763
L762
	move.l	#L658,-(a7)
	move.l	#L656,-(a7)
	move.l	#L657,-(a7)
	jsr	MessageBox__sysBASELIB__PcPcPce
	add.w	#$C,a7
	bra	L768
L763
	move.l	d2,d0
	muls.l	#$C,d0
	move.l	_allocated__MEM,a1
	move.l	0(a1,d0.l),a0
	cmp.w	#0,a0
	bne.b	L765
L764
	move.l	#L659,-(a7)
	move.l	#L656,-(a7)
	move.l	#L657,-(a7)
	jsr	MessageBox__sysBASELIB__PcPcPce
	add.w	#$C,a7
	bra	L768
L765
	move.l	d2,d0
	muls.l	#$C,d0
	move.l	_allocated__MEM,a1
	move.l	_SysBase,a6
	move.l	0(a1,d0.l),a1
	jsr	-$2B2(a6)
	move.l	d2,d0
	muls.l	#$C,d0
	move.l	_allocated__MEM,a1
	move.l	_totSize__MEM,d1
	sub.l	$8(a1,d0.l),d1
	move.l	d1,_totSize__MEM
	move.l	d2,d0
	muls.l	#$C,d0
	move.l	_allocated__MEM,a1
	clr.l	0(a1,d0.l)
	move.l	d2,d0
	muls.l	#$C,d0
	move.l	_allocated__MEM,a1
	clr.l	4(a1,d0.l)
	move.l	d2,d0
	muls.l	#$C,d0
	move.l	_allocated__MEM,a1
	clr.l	$8(a1,d0.l)
	subq.l	#1,_cnt__MEM
	cmp.l	_nextFree__MEM,d2
	bhs.b	L767
L766
	move.l	d2,_nextFree__MEM
L767
L768
	bra.b	L770
L769
	move.l	#L660,-(a7)
	move.l	#L656,-(a7)
	move.l	#L657,-(a7)
	jsr	MessageBox__sysBASELIB__PcPcPce
	add.w	#$C,a7
L770
L771
;	cell			= 0;
	clr.l	_cell__WORLDMAP
;	visible		= 0;
	clr.l	_visible__WORLDMAP
;	wet				= 0;
	clr.l	_wet__WORLDMAP
;	things		= 0;
	clr.l	_things__WORLDMAP
;	worldGrid	= 0;
	clr.l	_worldGrid__WORLDMAP
;	dimension = 0;
	clr.l	_dimension__WORLDMAP
	moveq	#0,d0
	movem.l	(a7)+,d2/a2/a3/a6
	rts

L657
	dc.b	'Debug',0
L655
	dc.b	'MEM::Free()',$A,'Address not recognised',0
L660
	dc.b	'MEM::Free()',$A,'Attempt to free null address',0
L658
	dc.b	'MEM::FreeIndex()',$A,'Index overflow',0
L659
	dc.b	'MEM::FreeIndex()',$A,'Memory already free',0
L656
	dc.b	'Proceed',0

	SECTION "GeneratePoints__WORLDMAP_:0",CODE


;void WORLDMAP::GeneratePoints()
	XDEF	GeneratePoints__WORLDMAP_
GeneratePoints__WORLDMAP_
L830	EQU	-$30
	link	a5,#L830
	movem.l	d2-d7,-(a7)
	fmovem.x fp2/fp3/fp4/fp5/fp6/fp7,-(a7)
L772
;	Junction(0,0).z									= FRACTURE;
	jsr	_rand
	fmove.l	d0,fp0
	fdiv.s	#$.46FFFE00,fp0
	fsub.s	#$.3F000000,fp0
	fmul.s	_fracLimit__WORLDMAP,fp0
	moveq	#0,d0
	moveq	#0,d0
	move.l	_dimension__WORLDMAP,d1
	addq.l	#1,d1
	mulu.l	d1,d0
	moveq	#0,d1
	moveq	#0,d1
	add.l	d1,d0
	muls.l	#$18,d0
	move.l	_worldGrid__WORLDMAP,a1
	fmove.s	fp0,$8(a1,d0.l)
;	Junction(0,dimension).z					= FRACTURE;
	jsr	_rand
	fmove.l	d0,fp0
	fdiv.s	#$.46FFFE00,fp0
	fsub.s	#$.3F000000,fp0
	fmul.s	_fracLimit__WORLDMAP,fp0
	move.w	_dimension__WORLDMAP+2,d0
	and.l	#$FFFF,d0
	move.l	_dimension__WORLDMAP,d1
	addq.l	#1,d1
	mulu.l	d1,d0
	moveq	#0,d1
	moveq	#0,d1
	add.l	d1,d0
	muls.l	#$18,d0
	move.l	_worldGrid__WORLDMAP,a1
	fmove.s	fp0,$8(a1,d0.l)
;	Junction(dimension,0).z					= FRACTURE;
	jsr	_rand
	fmove.l	d0,fp0
	fdiv.s	#$.46FFFE00,fp0
	fsub.s	#$.3F000000,fp0
	fmul.s	_fracLimit__WORLDMAP,fp0
	move.w	_dimension__WORLDMAP+2,d2
	moveq	#0,d0
	moveq	#0,d0
	move.l	_dimension__WORLDMAP,d1
	addq.l	#1,d1
	mulu.l	d1,d0
	moveq	#0,d1
	move.w	d2,d1
	add.l	d1,d0
	muls.l	#$18,d0
	move.l	_worldGrid__WORLDMAP,a1
	fmove.s	fp0,$8(a1,d0.l)
;	Junction(dimension,dimension).z	= FRACTURE;
	jsr	_rand
	fmove.l	d0,fp0
	fdiv.s	#$.46FFFE00,fp0
	fsub.s	#$.3F000000,fp0
	fmul.s	_fracLimit__WORLDMAP,fp0
	move.w	_dimension__WORLDMAP+2,d0
	move.w	_dimension__WORLDMAP+2,d2
	and.l	#$FFFF,d0
	move.l	_dimension__WORLDMAP,d1
	addq.l	#1,d1
	mulu.l	d1,d0
	moveq	#0,d1
	move.w	d2,d1
	add.l	d1,d0
	muls.l	#$18,d0
	move.l	_worldGrid__WORLDMAP,a1
	fmove.s	fp0,$8(a1,d0.l)
;	float32 minF = 0;
	fmove.s	#$.00000000,fp3
;	float32 maxF = 0;
	fmove.s	#$.00000000,fp4
;  for (sint32 pass=logDim;
	move.l	_logDim__WORLDMAP,d5
	bra	L819
L773
;  
;    sint32 o = (1<<pass);
	moveq	#1,d3
	asl.l	d5,d3
;    for (j = 0;
	moveq	#0,d4
	bra	L817
L774
;    
;      for (i = 0;
	moveq	#0,d2
	bra	L815
L775
;      
;        sint32 di = i&((1<<(pass+1))-1);
	move.l	d5,d0
	addq.l	#1,d0
	moveq	#1,d1
	asl.l	d0,d1
	move.l	d1,d0
	subq.l	#1,d0
	move.l	d2,d1
	and.l	d0,d1
;        sint32 dj = j&((1<<(pass+1))-1);
	move.l	d5,d0
	addq.l	#1,d0
	moveq	#1,d6
	asl.l	d0,d6
	move.l	d6,d0
	subq.l	#1,d0
	and.l	d4,d0
;        if (!((di == 0) && (dj == 0)))
	tst.l	d1
	bne.b	L777
L776
	tst.l	d0
	beq	L814
L777
;        
;          if (di == 0)
	tst.l	d1
	bne	L789
L778
;          
;            rfloat32 average = (Junction(i, j+o).z + Jun
	move.l	d4,d0
	add.l	d3,d0
	and.l	#$FFFF,d0
	move.l	_dimension__WORLDMAP,d1
	addq.l	#1,d1
	mulu.l	d1,d0
	moveq	#0,d1
	move.w	d2,d1
	add.l	d1,d0
	muls.l	#$18,d0
	move.l	_worldGrid__WORLDMAP,a1
	fmove.s	$8(a1,d0.l),fp2
	move.l	d4,d0
	sub.l	d3,d0
	and.l	#$FFFF,d0
	move.l	_dimension__WORLDMAP,d1
	addq.l	#1,d1
	mulu.l	d1,d0
	moveq	#0,d1
	move.w	d2,d1
	add.l	d1,d0
	muls.l	#$18,d0
	move.l	_worldGrid__WORLDMAP,a1
	fadd.s	$8(a1,d0.l),fp2
	fdiv.s	#$.40000000,fp2
;            average += FRACTURE;
	jsr	_rand
	fmove.l	d0,fp0
	fdiv.s	#$.46FFFE00,fp0
	fsub.s	#$.3F000000,fp0
	fmul.s	_fracLimit__WORLDMAP,fp0
	fadd.x	fp0,fp2
;						if (average < minF)
	fcmp.x	fp3,fp2
	fboge.b	L780
L779
;							minF = average;
	fmove.x	fp2,fp3
	bra.b	L782
L780
;						else if (average > maxF)
	fcmp.x	fp4,fp2
	fbole.b	L782
L781
;							maxF = average;
	fmove.x	fp2,fp4
L782
;						Junction(i,j).z = ClipFloat(average, minZ, maxZ);
	fmove.s	_maxZ__WORLDMAP,fp5
	fmove.s	_minZ__WORLDMAP,fp1
	fmove.x	fp2,fp0
	fcmp.x	fp1,fp0
	fboge.b	L784
L783
	fmove.x	fp1,fp0
	bra.b	L788
L784
	fcmp.x	fp5,fp0
	fbole.b	L786
L785
	fmove.x	fp5,fp0
L786
L787
L788
	moveq	#0,d0
	move.w	d4,d0
	move.l	_dimension__WORLDMAP,d1
	addq.l	#1,d1
	mulu.l	d1,d0
	moveq	#0,d1
	move.w	d2,d1
	add.l	d1,d0
	muls.l	#$18,d0
	move.l	_worldGrid__WORLDMAP,a1
	fmove.s	fp0,$8(a1,d0.l)
	bra	L814
L789
;          else if (dj == 0)
	tst.l	d0
	bne	L801
L790
;          
;            rfloat32 average = (Junction(i+o, j).z + Jun
	move.l	d2,d0
	add.l	d3,d0
	move.w	d0,d7
	moveq	#0,d0
	move.w	d4,d0
	move.l	_dimension__WORLDMAP,d1
	addq.l	#1,d1
	mulu.l	d1,d0
	moveq	#0,d1
	move.w	d7,d1
	add.l	d1,d0
	muls.l	#$18,d0
	move.l	_worldGrid__WORLDMAP,a1
	fmove.s	$8(a1,d0.l),fp2
	move.l	d2,d0
	sub.l	d3,d0
	move.w	d0,d7
	moveq	#0,d0
	move.w	d4,d0
	move.l	_dimension__WORLDMAP,d1
	addq.l	#1,d1
	mulu.l	d1,d0
	moveq	#0,d1
	move.w	d7,d1
	add.l	d1,d0
	muls.l	#$18,d0
	move.l	_worldGrid__WORLDMAP,a1
	fadd.s	$8(a1,d0.l),fp2
	fdiv.s	#$.40000000,fp2
;            average += FRACTURE;
	jsr	_rand
	fmove.l	d0,fp0
	fdiv.s	#$.46FFFE00,fp0
	fsub.s	#$.3F000000,fp0
	fmul.s	_fracLimit__WORLDMAP,fp0
	fadd.x	fp0,fp2
;						if (average < minF)
	fcmp.x	fp3,fp2
	fboge.b	L792
L791
;							minF = average;
	fmove.x	fp2,fp3
	bra.b	L794
L792
;						else if (average > maxF)
	fcmp.x	fp4,fp2
	fbole.b	L794
L793
;							maxF = average;
	fmove.x	fp2,fp4
L794
;						Junction(i,j).z = ClipFloat(average, minZ, maxZ);
	fmove.s	_maxZ__WORLDMAP,fp5
	fmove.s	_minZ__WORLDMAP,fp1
	fmove.x	fp2,fp0
	fcmp.x	fp1,fp0
	fboge.b	L796
L795
	fmove.x	fp1,fp0
	bra.b	L800
L796
	fcmp.x	fp5,fp0
	fbole.b	L798
L797
	fmove.x	fp5,fp0
L798
L799
L800
	moveq	#0,d0
	move.w	d4,d0
	move.l	_dimension__WORLDMAP,d1
	addq.l	#1,d1
	mulu.l	d1,d0
	moveq	#0,d1
	move.w	d2,d1
	add.l	d1,d0
	muls.l	#$18,d0
	move.l	_worldGrid__WORLDMAP,a1
	fmove.s	fp0,$8(a1,d0.l)
	bra	L814
L801
;          else if (di && dj)
	tst.l	d1
	beq	L814
L802
	tst.l	d0
	beq	L814
L803
;          
;            rfloat32 average = Junction(i+o, j+o).z + Ju
	move.l	d4,d0
	add.l	d3,d0
	move.w	d0,d1
	move.l	d2,d0
	add.l	d3,d0
	move.w	d0,d7
	moveq	#0,d0
	move.w	d1,d0
	move.l	_dimension__WORLDMAP,d1
	addq.l	#1,d1
	mulu.l	d1,d0
	moveq	#0,d1
	move.w	d7,d1
	add.l	d1,d0
	muls.l	#$18,d0
	move.l	_worldGrid__WORLDMAP,a1
	fmove.s	$8(a1,d0.l),fp2
	move.l	d4,d0
	sub.l	d3,d0
	move.w	d0,d1
	move.l	d2,d0
	add.l	d3,d0
	move.w	d0,d7
	moveq	#0,d0
	move.w	d1,d0
	move.l	_dimension__WORLDMAP,d1
	addq.l	#1,d1
	mulu.l	d1,d0
	moveq	#0,d1
	move.w	d7,d1
	add.l	d1,d0
	muls.l	#$18,d0
	move.l	_worldGrid__WORLDMAP,a1
	fadd.s	$8(a1,d0.l),fp2
	move.l	d4,d0
	add.l	d3,d0
	move.w	d0,d1
	move.l	d2,d0
	sub.l	d3,d0
	move.w	d0,d7
	moveq	#0,d0
	move.w	d1,d0
	move.l	_dimension__WORLDMAP,d1
	addq.l	#1,d1
	mulu.l	d1,d0
	moveq	#0,d1
	move.w	d7,d1
	add.l	d1,d0
	muls.l	#$18,d0
	move.l	_worldGrid__WORLDMAP,a1
	fadd.s	$8(a1,d0.l),fp2
	move.l	d4,d0
	sub.l	d3,d0
	move.w	d0,d1
	move.l	d2,d0
	sub.l	d3,d0
	move.w	d0,d7
	moveq	#0,d0
	move.w	d1,d0
	move.l	_dimension__WORLDMAP,d1
	addq.l	#1,d1
	mulu.l	d1,d0
	moveq	#0,d1
	move.w	d7,d1
	add.l	d1,d0
	muls.l	#$18,d0
	move.l	_worldGrid__WORLDMAP,a1
	fadd.s	$8(a1,d0.l),fp2
;						average /= 4F;
	fdiv.s	#$.40800000,fp2
;						average += FRACTURE;
	jsr	_rand
	fmove.l	d0,fp0
	fdiv.s	#$.46FFFE00,fp0
	fsub.s	#$.3F000000,fp0
	fmul.s	_fracLimit__WORLDMAP,fp0
	fadd.x	fp0,fp2
;						if (average < minF)
	fcmp.x	fp3,fp2
	fboge.b	L805
L804
;							minF = average;
	fmove.x	fp2,fp3
	bra.b	L807
L805
;						else if (average > maxF)
	fcmp.x	fp4,fp2
	fbole.b	L807
L806
;							maxF = average;
	fmove.x	fp2,fp4
L807
;						Junction(i,j).z = ClipFloat(average, minZ, maxZ);
	fmove.s	_maxZ__WORLDMAP,fp5
	fmove.s	_minZ__WORLDMAP,fp1
	fmove.x	fp2,fp0
	fcmp.x	fp1,fp0
	fboge.b	L809
L808
	fmove.x	fp1,fp0
	bra.b	L813
L809
	fcmp.x	fp5,fp0
	fbole.b	L811
L810
	fmove.x	fp5,fp0
L811
L812
L813
	moveq	#0,d0
	move.w	d4,d0
	move.l	_dimension__WORLDMAP,d1
	addq.l	#1,d1
	mulu.l	d1,d0
	moveq	#0,d1
	move.w	d2,d1
	add.l	d1,d0
	muls.l	#$18,d0
	move.l	_worldGrid__WORLDMAP,a1
	fmove.s	fp0,$8(a1,d0.l)
L814
	add.l	d3,d2
L815
	cmp.l	_dimension__WORLDMAP,d2
	blo	L775
L816
	add.l	d3,d4
L817
	cmp.l	_dimension__WORLDMAP,d4
	blo	L774
L818
	subq.l	#1,d5
L819
	tst.l	d5
	bpl	L773
L820
;	
;		float32	d = scale/dimension;
	fmove.l	_dimension__WORLDMAP,fp0
	fmove.s	_scale__WORLDMAP,fp1
	fdiv.x	fp0,fp1
	fmove.s	fp1,-$18(a5)
;		float32 txScale = (ground[0]->Width() < ground[0]->Height()) ? g
	move.l	#_ground__WORLDMAP,a1
	move.l	(a1),a0
	move.l	$8(a0),a1
	move.l	a0,d0
	add.l	$2C(a1),d0
	move.l	d0,-(a7)
	move.l	$28(a1),a1
	jsr	(a1)
	move.l	d0,d2
	addq.w	#4,a7
	move.l	#_ground__WORLDMAP,a1
	move.l	(a1),a0
	move.l	$8(a0),a1
	move.l	a0,d0
	add.l	$24(a1),d0
	move.l	d0,-(a7)
	move.l	$20(a1),a1
	jsr	(a1)
	addq.w	#4,a7
	cmp.l	d0,d2
	bge.b	L822
L821
	move.l	#_ground__WORLDMAP,a1
	move.l	(a1),a0
	move.l	$8(a0),a1
	move.l	a0,d0
	add.l	$24(a1),d0
	move.l	d0,-(a7)
	move.l	$20(a1),a1
	jsr	(a1)
	addq.w	#4,a7
	bra.b	L823
L822
	move.l	#_ground__WORLDMAP,a1
	move.l	(a1),a0
	move.l	$8(a0),a1
	move.l	a0,d0
	add.l	$2C(a1),d0
	move.l	d0,-(a7)
	move.l	$28(a1),a1
	jsr	(a1)
	addq.w	#4,a7
L823
	fmove.l	d0,fp5
;		txScale /= scale;
	fdiv.s	_scale__WORLDMAP,fp5
;		for (j=0, y=0;
	moveq	#0,d4
	fmove.s	#$.00000000,fp2
	bra	L828
L824
;		
;			for (i=0, x=0.0;
	moveq	#0,d2
	fmove.s	#$.00000000,fp0
	bra	L826
L825
;			
;				sint32 m = i+(j*(dimension+1));
	move.l	_dimension__WORLDMAP,d0
	addq.l	#1,d0
	mulu.l	d4,d0
	add.l	d2,d0
;				worldGrid[m].x = x;
	move.l	d0,d1
	muls.l	#$18,d1
	move.l	_worldGrid__WORLDMAP,a1
	fmove.s	fp0,0(a1,d1.l)
;				worldGrid[m].y = y;
	move.l	d0,d1
	muls.l	#$18,d1
	move.l	_worldGrid__WORLDMAP,a1
	fmove.s	fp2,4(a1,d1.l)
;				uint32 c = (uint32)(200F*(worldGrid[m].z-minF)/(maxF-minF))+
	move.l	d0,d1
	muls.l	#$18,d1
	move.l	_worldGrid__WORLDMAP,a1
	fmove.s	$8(a1,d1.l),fp1
	fsub.x	fp3,fp1
	fmul.s	#$.43480000,fp1
	fmove.x	fp4,fp6
	fsub.x	fp3,fp6
	fdiv.x	fp6,fp1
	fmove.l	fp1,d3
	add.l	#$32,d3
;				worldGrid[m].c = 0xFF | c<<16 | c<<8 | c;
	move.l	d3,d1
	moveq	#$10,d5
	asl.l	d5,d1
	or.l	#$FF,d1
	move.l	d3,d5
	moveq	#$8,d6
	asl.l	d6,d5
	or.l	d5,d1
	or.l	d3,d1
	move.l	d0,d3
	muls.l	#$18,d3
	move.l	_worldGrid__WORLDMAP,a1
	move.l	d1,$14(a1,d3.l)
;				worldGrid[m].u = 8F*x*txScale;
	fmove.x	fp0,fp1
	fmul.s	#$.41000000,fp1
	fmul.x	fp5,fp1
	move.l	d0,d1
	muls.l	#$18,d1
	move.l	_worldGrid__WORLDMAP,a1
	fmove.s	fp1,$C(a1,d1.l)
;				worldGrid[m].v = 8F*y*txScale;
	fmove.x	fp2,fp1
	fmul.s	#$.41000000,fp1
	fmul.x	fp5,fp1
	muls.l	#$18,d0
	move.l	_worldGrid__WORLDMAP,a1
	fmove.s	fp1,$10(a1,d0.l)
	addq.l	#1,d2
	fadd.s	-$18(a5),fp0
L826
	cmp.l	_dimension__WORLDMAP,d2
	bls	L825
L827
	addq.l	#1,d4
	fadd.s	-$18(a5),fp2
L828
	cmp.l	_dimension__WORLDMAP,d4
	bls	L824
L829
;	minZ = minF*1.05F;
	fmove.x	fp3,fp0
	fmul.s	#$.3F866666,fp0
	fmove.s	fp0,_minZ__WORLDMAP
;	maxZ = maxF*1.10F;
	fmove.x	fp4,fp0
	fmul.s	#$.3F8CCCCD,fp0
	fmove.s	fp0,_maxZ__WORLDMAP
;	floodLevel = (maxZ + (3F*minZ))/3F;
	fmove.s	_minZ__WORLDMAP,fp0
	fmul.s	#$.40400000,fp0
	fadd.s	_maxZ__WORLDMAP,fp0
	fdiv.s	#$.40400000,fp0
	fmove.s	fp0,_floodLevel__WORLDMAP
	fmovem.x (a7)+,fp2/fp3/fp4/fp5/fp6/fp7
	movem.l	(a7)+,d2-d7
	unlk	a5
	rts

	SECTION "LinkCells__WORLDMAP_:0",CODE


;sint32 WORLDMAP::LinkCells()
	XDEF	LinkCells__WORLDMAP_
LinkCells__WORLDMAP_
	movem.l	d2-d7/a2,-(a7)
L831
;	rsint32 m = dimension;
	move.l	_dimension__WORLDMAP,d1
;	cell[0].LinkABLF(0);
	move.l	_cell__WORLDMAP,a0
	clr.l	$E0(a0)
;	cell[0].LinkAB(0);
	move.l	_cell__WORLDMAP,a0
	lea	$E0(a0),a0
	clr.l	4(a0)
;					cell[0].LinkABRT(0);
	move.l	_cell__WORLDMAP,a0
	lea	$E0(a0),a0
	clr.l	$8(a0)
;								cell[0].LinkBLLF(0);
	move.l	_cell__WORLDMAP,a0
	lea	$E0(a0),a0
	clr.l	$18(a0)
;	cell[0].LinkLF(0);
	move.l	_cell__WORLDMAP,a0
	lea	$E0(a0),a0
	clr.l	$1C(a0)
;		cell[0].LinkRT(&cell[1]);
	move.l	_cell__WORLDMAP,a0
	lea	$100(a0),a1
	move.l	_cell__WORLDMAP,a0
	lea	$E0(a0),a0
	move.l	a1,$C(a0)
;		cell[0].LinkBL(&cell[m]);
	move.l	d1,d0
	asl.l	#$8,d0
	move.l	_cell__WORLDMAP,a0
	lea	0(a0,d0.l),a1
	move.l	_cell__WORLDMAP,a0
	lea	$E0(a0),a0
	move.l	a1,$14(a0)
;						cell[0].LinkBLRT(&cell[m+1]);
	move.l	d1,d0
	addq.l	#1,d0
	asl.l	#$8,d0
	move.l	_cell__WORLDMAP,a0
	lea	0(a0,d0.l),a1
	move.l	_cell__WORLDMAP,a0
	lea	$E0(a0),a0
	move.l	a1,$10(a0)
;	rsint32 n=m-1;
	move.l	d1,d0
	subq.l	#1,d0
;	cell[n].LinkABLF(0);
	move.l	d0,d2
	asl.l	#$8,d2
	move.l	_cell__WORLDMAP,a2
	lea	0(a2,d2.l),a0
	clr.l	$E0(a0)
;	cell[n].LinkAB(0);
	move.l	d0,d2
	asl.l	#$8,d2
	move.l	_cell__WORLDMAP,a2
	lea	0(a2,d2.l),a0
	lea	$E0(a0),a0
	clr.l	4(a0)
;					cell[n].LinkABRT(0);
	move.l	d0,d2
	asl.l	#$8,d2
	move.l	_cell__WORLDMAP,a2
	lea	0(a2,d2.l),a0
	lea	$E0(a0),a0
	clr.l	$8(a0)
;								cell[n].LinkRT(0);
	move.l	d0,d2
	asl.l	#$8,d2
	move.l	_cell__WORLDMAP,a2
	lea	0(a2,d2.l),a0
	lea	$E0(a0),a0
	clr.l	$C(a0)
;	cell[n].LinkBLRT(0);
	move.l	d0,d2
	asl.l	#$8,d2
	move.l	_cell__WORLDMAP,a2
	lea	0(a2,d2.l),a0
	lea	$E0(a0),a0
	clr.l	$10(a0)
;	cell[n].LinkLF(&cell[n-1]);
	move.l	d0,d2
	subq.l	#1,d2
	asl.l	#$8,d2
	move.l	_cell__WORLDMAP,a0
	lea	0(a0,d2.l),a1
	move.l	d0,d2
	asl.l	#$8,d2
	move.l	_cell__WORLDMAP,a2
	lea	0(a2,d2.l),a0
	lea	$E0(a0),a0
	move.l	a1,$1C(a0)
;	cell[n].LinkBL(&cell[(2*m)-1]);
	move.l	d1,d2
	moveq	#1,d3
	asl.l	d3,d2
	subq.l	#1,d2
	asl.l	#$8,d2
	move.l	_cell__WORLDMAP,a0
	lea	0(a0,d2.l),a1
	move.l	d0,d2
	asl.l	#$8,d2
	move.l	_cell__WORLDMAP,a2
	lea	0(a2,d2.l),a0
	lea	$E0(a0),a0
	move.l	a1,$14(a0)
;			cell[n].LinkBLLF(&cell[(2*m)-2]);
	move.l	d1,d2
	moveq	#1,d3
	asl.l	d3,d2
	subq.l	#2,d2
	asl.l	#$8,d2
	move.l	_cell__WORLDMAP,a0
	lea	0(a0,d2.l),a1
	asl.l	#$8,d0
	move.l	_cell__WORLDMAP,a2
	lea	0(a2,d0.l),a0
	lea	$E0(a0),a0
	move.l	a1,$18(a0)
;	n = (m*m)-1;
	move.l	d1,d0
	muls.l	d1,d0
	subq.l	#1,d0
;	cell[n].LinkABRT(0);
	move.l	d0,d2
	asl.l	#$8,d2
	move.l	_cell__WORLDMAP,a2
	lea	0(a2,d2.l),a0
	lea	$E0(a0),a0
	clr.l	$8(a0)
;	cell[n].LinkRT(0);
	move.l	d0,d2
	asl.l	#$8,d2
	move.l	_cell__WORLDMAP,a2
	lea	0(a2,d2.l),a0
	lea	$E0(a0),a0
	clr.l	$C(a0)
;					cell[n].LinkBLRT(0);
	move.l	d0,d2
	asl.l	#$8,d2
	move.l	_cell__WORLDMAP,a2
	lea	0(a2,d2.l),a0
	lea	$E0(a0),a0
	clr.l	$10(a0)
;								cell[n].LinkBL(0);
	move.l	d0,d2
	asl.l	#$8,d2
	move.l	_cell__WORLDMAP,a2
	lea	0(a2,d2.l),a0
	lea	$E0(a0),a0
	clr.l	$14(a0)
;	cell[n].LinkBLLF(0);
	move.l	d0,d2
	asl.l	#$8,d2
	move.l	_cell__WORLDMAP,a2
	lea	0(a2,d2.l),a0
	lea	$E0(a0),a0
	clr.l	$18(a0)
;	cell[n].LinkLF(&cell[n-1]);
	move.l	d0,d2
	subq.l	#1,d2
	asl.l	#$8,d2
	move.l	_cell__WORLDMAP,a0
	lea	0(a0,d2.l),a1
	move.l	d0,d2
	asl.l	#$8,d2
	move.l	_cell__WORLDMAP,a2
	lea	0(a2,d2.l),a0
	lea	$E0(a0),a0
	move.l	a1,$1C(a0)
;	cell[n].LinkAB(&cell[(m*(m-1))-1]);
	move.l	d1,d2
	subq.l	#1,d2
	muls.l	d1,d2
	subq.l	#1,d2
	asl.l	#$8,d2
	move.l	_cell__WORLDMAP,a0
	lea	0(a0,d2.l),a1
	move.l	d0,d2
	asl.l	#$8,d2
	move.l	_cell__WORLDMAP,a2
	lea	0(a2,d2.l),a0
	lea	$E0(a0),a0
	move.l	a1,4(a0)
;	cell[n].LinkABLF(&cell[(m*(m-1))-2]);
	move.l	d1,d2
	subq.l	#1,d2
	muls.l	d1,d2
	subq.l	#2,d2
	asl.l	#$8,d2
	move.l	_cell__WORLDMAP,a0
	lea	0(a0,d2.l),a1
	asl.l	#$8,d0
	move.l	_cell__WORLDMAP,a2
	lea	0(a2,d0.l),a0
	move.l	a1,$E0(a0)
;	n = m*(m-1);
	move.l	d1,d0
	subq.l	#1,d0
	muls.l	d1,d0
;	cell[n].LinkABLF(0);
	move.l	d0,d2
	asl.l	#$8,d2
	move.l	_cell__WORLDMAP,a2
	lea	0(a2,d2.l),a0
	clr.l	$E0(a0)
;	cell[n].LinkBLRT(0);
	move.l	d0,d2
	asl.l	#$8,d2
	move.l	_cell__WORLDMAP,a2
	lea	0(a2,d2.l),a0
	lea	$E0(a0),a0
	clr.l	$10(a0)
;				cell[n].LinkBL(0);
	move.l	d0,d2
	asl.l	#$8,d2
	move.l	_cell__WORLDMAP,a2
	lea	0(a2,d2.l),a0
	lea	$E0(a0),a0
	clr.l	$14(a0)
;									cell[n].LinkBLLF(0);
	move.l	d0,d2
	asl.l	#$8,d2
	move.l	_cell__WORLDMAP,a2
	lea	0(a2,d2.l),a0
	lea	$E0(a0),a0
	clr.l	$18(a0)
;	cell[n].LinkLF(0);
	move.l	d0,d2
	asl.l	#$8,d2
	move.l	_cell__WORLDMAP,a2
	lea	0(a2,d2.l),a0
	lea	$E0(a0),a0
	clr.l	$1C(a0)
;		cell[n].LinkRT(&cell[n+1]);
	move.l	d0,d2
	addq.l	#1,d2
	asl.l	#$8,d2
	move.l	_cell__WORLDMAP,a0
	lea	0(a0,d2.l),a1
	move.l	d0,d2
	asl.l	#$8,d2
	move.l	_cell__WORLDMAP,a2
	lea	0(a2,d2.l),a0
	lea	$E0(a0),a0
	move.l	a1,$C(a0)
;	cell[n].LinkAB(&cell[n-m]);
	move.l	d0,d2
	sub.l	d1,d2
	asl.l	#$8,d2
	move.l	_cell__WORLDMAP,a0
	lea	0(a0,d2.l),a1
	move.l	d0,d2
	asl.l	#$8,d2
	move.l	_cell__WORLDMAP,a2
	lea	0(a2,d2.l),a0
	lea	$E0(a0),a0
	move.l	a1,4(a0)
;					cell[n].LinkABRT(&cell[n-m+1]);
	move.l	d0,d2
	sub.l	d1,d2
	addq.l	#1,d2
	asl.l	#$8,d2
	move.l	_cell__WORLDMAP,a0
	lea	0(a0,d2.l),a1
	asl.l	#$8,d0
	move.l	_cell__WORLDMAP,a2
	lea	0(a2,d0.l),a0
	lea	$E0(a0),a0
	move.l	a1,$8(a0)
;	n = m-1;
	move.l	d1,d0
	subq.l	#1,d0
;	for (i=1;
	moveq	#1,d2
	bra	L833
L832
;	
;		cell[i].LinkABLF(0);
	move.l	d2,d3
	asl.l	#$8,d3
	move.l	_cell__WORLDMAP,a2
	lea	0(a2,d3.l),a0
	clr.l	$E0(a0)
;						cell[i].LinkAB(0);
	move.l	d2,d3
	asl.l	#$8,d3
	move.l	_cell__WORLDMAP,a2
	lea	0(a2,d3.l),a0
	lea	$E0(a0),a0
	clr.l	4(a0)
;					cell[i].LinkABRT(0);
	move.l	d2,d3
	asl.l	#$8,d3
	move.l	_cell__WORLDMAP,a2
	lea	0(a2,d3.l),a0
	lea	$E0(a0),a0
	clr.l	$8(a0)
;						cell[i].LinkLF(&cell[i-1]);
	move.l	d2,d3
	subq.l	#1,d3
	asl.l	#$8,d3
	move.l	_cell__WORLDMAP,a0
	lea	0(a0,d3.l),a1
	move.l	d2,d3
	asl.l	#$8,d3
	move.l	_cell__WORLDMAP,a2
	lea	0(a2,d3.l),a0
	lea	$E0(a0),a0
	move.l	a1,$1C(a0)
;		cell[i].LinkBLLF(&cell[i+m-1]);
	move.l	d2,d3
	add.l	d1,d3
	subq.l	#1,d3
	asl.l	#$8,d3
	move.l	_cell__WORLDMAP,a0
	lea	0(a0,d3.l),a1
	move.l	d2,d3
	asl.l	#$8,d3
	move.l	_cell__WORLDMAP,a2
	lea	0(a2,d3.l),a0
	lea	$E0(a0),a0
	move.l	a1,$18(a0)
;	cell[i].LinkBL(&cell[i+m]);
	move.l	d2,d3
	add.l	d1,d3
	asl.l	#$8,d3
	move.l	_cell__WORLDMAP,a0
	lea	0(a0,d3.l),a1
	move.l	d2,d3
	asl.l	#$8,d3
	move.l	_cell__WORLDMAP,a2
	lea	0(a2,d3.l),a0
	lea	$E0(a0),a0
	move.l	a1,$14(a0)
;	cell[i].LinkBLRT(&cell[i+m+1]);
	move.l	d2,d3
	add.l	d1,d3
	addq.l	#1,d3
	asl.l	#$8,d3
	move.l	_cell__WORLDMAP,a0
	lea	0(a0,d3.l),a1
	move.l	d2,d3
	asl.l	#$8,d3
	move.l	_cell__WORLDMAP,a2
	lea	0(a2,d3.l),a0
	lea	$E0(a0),a0
	move.l	a1,$10(a0)
;	cell[i].LinkRT(&cell[i+1]);
	move.l	d2,d3
	addq.l	#1,d3
	asl.l	#$8,d3
	move.l	_cell__WORLDMAP,a0
	lea	0(a0,d3.l),a1
	move.l	d2,d3
	asl.l	#$8,d3
	move.l	_cell__WORLDMAP,a2
	lea	0(a2,d3.l),a0
	lea	$E0(a0),a0
	move.l	a1,$C(a0)
	addq.l	#1,d2
L833
	cmp.l	d0,d2
	blt	L832
L834
;	n = m*m-1;
	move.l	d1,d0
	muls.l	d1,d0
	subq.l	#1,d0
;	rsint32 o = 1+m*(m-1);
	move.l	d1,d2
	subq.l	#1,d2
	muls.l	d1,d2
	move.l	d2,d5
	addq.l	#1,d5
;	for (i=o;
	move.l	d5,d2
	bra	L836
L835
;	
;		cell[i].LinkBLLF(0);
	move.l	d2,d3
	asl.l	#$8,d3
	move.l	_cell__WORLDMAP,a2
	lea	0(a2,d3.l),a0
	lea	$E0(a0),a0
	clr.l	$18(a0)
;						cell[i].LinkBL(0);
	move.l	d2,d3
	asl.l	#$8,d3
	move.l	_cell__WORLDMAP,a2
	lea	0(a2,d3.l),a0
	lea	$E0(a0),a0
	clr.l	$14(a0)
;					cell[i].LinkBLRT(0);
	move.l	d2,d3
	asl.l	#$8,d3
	move.l	_cell__WORLDMAP,a2
	lea	0(a2,d3.l),a0
	lea	$E0(a0),a0
	clr.l	$10(a0)
;						cell[i].LinkLF(&cell[i-1]);
	move.l	d2,d3
	subq.l	#1,d3
	asl.l	#$8,d3
	move.l	_cell__WORLDMAP,a0
	lea	0(a0,d3.l),a1
	move.l	d2,d3
	asl.l	#$8,d3
	move.l	_cell__WORLDMAP,a2
	lea	0(a2,d3.l),a0
	lea	$E0(a0),a0
	move.l	a1,$1C(a0)
;		cell[i].LinkABLF(&cell[i-m-1]);
	move.l	d2,d3
	sub.l	d1,d3
	subq.l	#1,d3
	asl.l	#$8,d3
	move.l	_cell__WORLDMAP,a0
	lea	0(a0,d3.l),a1
	move.l	d2,d3
	asl.l	#$8,d3
	move.l	_cell__WORLDMAP,a2
	lea	0(a2,d3.l),a0
	move.l	a1,$E0(a0)
;	cell[i].LinkAB(&cell[i-m]);
	move.l	d2,d3
	sub.l	d1,d3
	asl.l	#$8,d3
	move.l	_cell__WORLDMAP,a0
	lea	0(a0,d3.l),a1
	move.l	d2,d3
	asl.l	#$8,d3
	move.l	_cell__WORLDMAP,a2
	lea	0(a2,d3.l),a0
	lea	$E0(a0),a0
	move.l	a1,4(a0)
;	cell[i].LinkABRT(&cell[i-m+1]);
	move.l	d2,d3
	sub.l	d1,d3
	addq.l	#1,d3
	asl.l	#$8,d3
	move.l	_cell__WORLDMAP,a0
	lea	0(a0,d3.l),a1
	move.l	d2,d3
	asl.l	#$8,d3
	move.l	_cell__WORLDMAP,a2
	lea	0(a2,d3.l),a0
	lea	$E0(a0),a0
	move.l	a1,$8(a0)
;	cell[i].LinkRT(&cell[i+1]);
	move.l	d2,d3
	addq.l	#1,d3
	asl.l	#$8,d3
	move.l	_cell__WORLDMAP,a0
	lea	0(a0,d3.l),a1
	move.l	d2,d3
	asl.l	#$8,d3
	move.l	_cell__WORLDMAP,a2
	lea	0(a2,d3.l),a0
	lea	$E0(a0),a0
	move.l	a1,$C(a0)
	addq.l	#1,d2
L836
	cmp.l	d0,d2
	blt	L835
L837
;	o = m-1;
	move.l	d1,d5
	subq.l	#1,d5
;	for (i=1, n=m;
	moveq	#1,d2
	move.l	d1,d0
	bra	L839
L838
;	
;		cell[n].LinkABLF(0);
	move.l	d0,d3
	asl.l	#$8,d3
	move.l	_cell__WORLDMAP,a2
	lea	0(a2,d3.l),a0
	clr.l	$E0(a0)
;						cell[n].LinkLF(0);
	move.l	d0,d3
	asl.l	#$8,d3
	move.l	_cell__WORLDMAP,a2
	lea	0(a2,d3.l),a0
	lea	$E0(a0),a0
	clr.l	$1C(a0)
;					cell[n].LinkBLLF(0);
	move.l	d0,d3
	asl.l	#$8,d3
	move.l	_cell__WORLDMAP,a2
	lea	0(a2,d3.l),a0
	lea	$E0(a0),a0
	clr.l	$18(a0)
;						cell[n].LinkAB(&cell[n-m]);
	move.l	d0,d3
	sub.l	d1,d3
	asl.l	#$8,d3
	move.l	_cell__WORLDMAP,a0
	lea	0(a0,d3.l),a1
	move.l	d0,d3
	asl.l	#$8,d3
	move.l	_cell__WORLDMAP,a2
	lea	0(a2,d3.l),a0
	lea	$E0(a0),a0
	move.l	a1,4(a0)
;		cell[n].LinkABRT(&cell[n-m+1]);
	move.l	d0,d3
	sub.l	d1,d3
	addq.l	#1,d3
	asl.l	#$8,d3
	move.l	_cell__WORLDMAP,a0
	lea	0(a0,d3.l),a1
	move.l	d0,d3
	asl.l	#$8,d3
	move.l	_cell__WORLDMAP,a2
	lea	0(a2,d3.l),a0
	lea	$E0(a0),a0
	move.l	a1,$8(a0)
;	cell[n].LinkRT(&cell[n+1]);
	move.l	d0,d3
	addq.l	#1,d3
	asl.l	#$8,d3
	move.l	_cell__WORLDMAP,a0
	lea	0(a0,d3.l),a1
	move.l	d0,d3
	asl.l	#$8,d3
	move.l	_cell__WORLDMAP,a2
	lea	0(a2,d3.l),a0
	lea	$E0(a0),a0
	move.l	a1,$C(a0)
;	cell[n].LinkBLRT(&cell[n+m+1]);
	move.l	d0,d3
	add.l	d1,d3
	addq.l	#1,d3
	asl.l	#$8,d3
	move.l	_cell__WORLDMAP,a0
	lea	0(a0,d3.l),a1
	move.l	d0,d3
	asl.l	#$8,d3
	move.l	_cell__WORLDMAP,a2
	lea	0(a2,d3.l),a0
	lea	$E0(a0),a0
	move.l	a1,$10(a0)
;	cell[n].LinkBL(&cell[n+m]);
	move.l	d0,d3
	add.l	d1,d3
	asl.l	#$8,d3
	move.l	_cell__WORLDMAP,a0
	lea	0(a0,d3.l),a1
	move.l	d0,d3
	asl.l	#$8,d3
	move.l	_cell__WORLDMAP,a2
	lea	0(a2,d3.l),a0
	lea	$E0(a0),a0
	move.l	a1,$14(a0)
	addq.l	#1,d2
	add.l	d1,d0
L839
	cmp.l	d5,d2
	blt	L838
L840
;	for (i=1, n=m+o;
	moveq	#1,d2
	move.l	d1,d0
	add.l	d5,d0
	bra	L842
L841
;	
;		cell[n].LinkABRT(0);
	move.l	d0,d3
	asl.l	#$8,d3
	move.l	_cell__WORLDMAP,a2
	lea	0(a2,d3.l),a0
	lea	$E0(a0),a0
	clr.l	$8(a0)
;						cell[n].LinkRT(0);
	move.l	d0,d3
	asl.l	#$8,d3
	move.l	_cell__WORLDMAP,a2
	lea	0(a2,d3.l),a0
	lea	$E0(a0),a0
	clr.l	$C(a0)
;					cell[n].LinkBLRT(0);
	move.l	d0,d3
	asl.l	#$8,d3
	move.l	_cell__WORLDMAP,a2
	lea	0(a2,d3.l),a0
	lea	$E0(a0),a0
	clr.l	$10(a0)
;						cell[n].LinkAB(&cell[n-m]);
	move.l	d0,d3
	sub.l	d1,d3
	asl.l	#$8,d3
	move.l	_cell__WORLDMAP,a0
	lea	0(a0,d3.l),a1
	move.l	d0,d3
	asl.l	#$8,d3
	move.l	_cell__WORLDMAP,a2
	lea	0(a2,d3.l),a0
	lea	$E0(a0),a0
	move.l	a1,4(a0)
;		cell[n].LinkABLF(&cell[n-m-1]);
	move.l	d0,d3
	sub.l	d1,d3
	subq.l	#1,d3
	asl.l	#$8,d3
	move.l	_cell__WORLDMAP,a0
	lea	0(a0,d3.l),a1
	move.l	d0,d3
	asl.l	#$8,d3
	move.l	_cell__WORLDMAP,a2
	lea	0(a2,d3.l),a0
	move.l	a1,$E0(a0)
;	cell[n].LinkLF(&cell[n-1]);
	move.l	d0,d3
	subq.l	#1,d3
	asl.l	#$8,d3
	move.l	_cell__WORLDMAP,a0
	lea	0(a0,d3.l),a1
	move.l	d0,d3
	asl.l	#$8,d3
	move.l	_cell__WORLDMAP,a2
	lea	0(a2,d3.l),a0
	lea	$E0(a0),a0
	move.l	a1,$1C(a0)
;	cell[n].LinkBLLF(&cell[n+m-1]);
	move.l	d0,d3
	add.l	d1,d3
	subq.l	#1,d3
	asl.l	#$8,d3
	move.l	_cell__WORLDMAP,a0
	lea	0(a0,d3.l),a1
	move.l	d0,d3
	asl.l	#$8,d3
	move.l	_cell__WORLDMAP,a2
	lea	0(a2,d3.l),a0
	lea	$E0(a0),a0
	move.l	a1,$18(a0)
;	cell[n].LinkBL(&cell[n+m]);
	move.l	d0,d3
	add.l	d1,d3
	asl.l	#$8,d3
	move.l	_cell__WORLDMAP,a0
	lea	0(a0,d3.l),a1
	move.l	d0,d3
	asl.l	#$8,d3
	move.l	_cell__WORLDMAP,a2
	lea	0(a2,d3.l),a0
	lea	$E0(a0),a0
	move.l	a1,$14(a0)
	addq.l	#1,d2
	add.l	d1,d0
L842
	cmp.l	d5,d2
	blt	L841
L843
;	i = m;
	move.l	d1,d2
;	for (rsint32 y=1;
	moveq	#1,d7
	bra	L848
L844
;	
;		for (rsint32 x=1;
	moveq	#1,d3
	bra	L846
L845
;		
;			n = i+x;
	move.l	d2,d0
	add.l	d3,d0
;			cell[n].LinkLF(&cell[n-1]);
	move.l	d0,d4
	subq.l	#1,d4
	asl.l	#$8,d4
	move.l	_cell__WORLDMAP,a0
	lea	0(a0,d4.l),a1
	move.l	d0,d4
	asl.l	#$8,d4
	move.l	_cell__WORLDMAP,a2
	lea	0(a2,d4.l),a0
	lea	$E0(a0),a0
	move.l	a1,$1C(a0)
;	cell[n].LinkABLF(&cell[n-m-1]);
	move.l	d0,d4
	sub.l	d1,d4
	subq.l	#1,d4
	asl.l	#$8,d4
	move.l	_cell__WORLDMAP,a0
	lea	0(a0,d4.l),a1
	move.l	d0,d4
	asl.l	#$8,d4
	move.l	_cell__WORLDMAP,a2
	lea	0(a2,d4.l),a0
	move.l	a1,$E0(a0)
;	cell[n].LinkAB(&cell[n-m]);
	move.l	d0,d4
	sub.l	d1,d4
	asl.l	#$8,d4
	move.l	_cell__WORLDMAP,a0
	lea	0(a0,d4.l),a1
	move.l	d0,d4
	asl.l	#$8,d4
	move.l	_cell__WORLDMAP,a2
	lea	0(a2,d4.l),a0
	lea	$E0(a0),a0
	move.l	a1,4(a0)
;	cell[n].LinkABRT(&cell[n-m+1]);
	move.l	d0,d4
	sub.l	d1,d4
	addq.l	#1,d4
	asl.l	#$8,d4
	move.l	_cell__WORLDMAP,a0
	lea	0(a0,d4.l),a1
	move.l	d0,d4
	asl.l	#$8,d4
	move.l	_cell__WORLDMAP,a2
	lea	0(a2,d4.l),a0
	lea	$E0(a0),a0
	move.l	a1,$8(a0)
;			cell[n].LinkRT(&cell[n+1]);
	move.l	d0,d4
	addq.l	#1,d4
	asl.l	#$8,d4
	move.l	_cell__WORLDMAP,a0
	lea	0(a0,d4.l),a1
	move.l	d0,d4
	asl.l	#$8,d4
	move.l	_cell__WORLDMAP,a2
	lea	0(a2,d4.l),a0
	lea	$E0(a0),a0
	move.l	a1,$C(a0)
;	cell[n].LinkBLRT(&cell[n+m+1]);
	move.l	d0,d4
	add.l	d1,d4
	addq.l	#1,d4
	asl.l	#$8,d4
	move.l	_cell__WORLDMAP,a0
	lea	0(a0,d4.l),a1
	move.l	d0,d4
	asl.l	#$8,d4
	move.l	_cell__WORLDMAP,a2
	lea	0(a2,d4.l),a0
	lea	$E0(a0),a0
	move.l	a1,$10(a0)
;	cell[n].LinkBL(&cell[n+m]);
	move.l	d0,d4
	add.l	d1,d4
	asl.l	#$8,d4
	move.l	_cell__WORLDMAP,a0
	lea	0(a0,d4.l),a1
	move.l	d0,d4
	asl.l	#$8,d4
	move.l	_cell__WORLDMAP,a2
	lea	0(a2,d4.l),a0
	lea	$E0(a0),a0
	move.l	a1,$14(a0)
;	cell[n].LinkBLLF(&cell[n+m-1]);
	move.l	d0,d4
	add.l	d1,d4
	subq.l	#1,d4
	asl.l	#$8,d4
	move.l	_cell__WORLDMAP,a0
	lea	0(a0,d4.l),a1
	asl.l	#$8,d0
	move.l	_cell__WORLDMAP,a2
	lea	0(a2,d0.l),a0
	lea	$E0(a0),a0
	move.l	a1,$18(a0)
	addq.l	#1,d3
L846
	cmp.l	d5,d3
	blt	L845
L847
	move.l	d7,d0
	addq.l	#1,d0
	move.l	d0,d7
	add.l	d1,d2
L848
	move.l	d7,d0
	cmp.l	d5,d0
	blt	L844
L849
	moveq	#0,d0
	movem.l	(a7)+,d2-d7/a2
	rts

	SECTION "Clip__WORLDMAP__R04VIEW:0",CODE


;sint32 WORLDMAP::Clip(VIEW& view)
	XDEF	Clip__WORLDMAP__R04VIEW
Clip__WORLDMAP__R04VIEW
L886	EQU	-$60
	link	a5,#L886
	movem.l	d2-d7/a2/a3,-(a7)
	fmovem.x fp2,-(a7)
	move.l	$8(a5),a3
L850
;	sint32 minX = (sint32)(((view.BTL().x/scale)*(float32)dimension)-0
	fmove.s	$160(a3),fp0
	fdiv.s	_scale__WORLDMAP,fp0
	fmove.l	_dimension__WORLDMAP,fp1
	fmul.x	fp1,fp0
	fsub.s	#$.3F000000,fp0
	fmove.l	fp0,d0
	move.l	d0,-4(a5)
	subq.l	#1,-4(a5)
;	sint32 maxY = (sint32)(((view.BTL().y/scale)*(float32)dimension)+0
	fmove.s	$164(a3),fp0
	fdiv.s	_scale__WORLDMAP,fp0
	fmove.l	_dimension__WORLDMAP,fp1
	fmul.x	fp1,fp0
	fadd.s	#$.3F000000,fp0
	fmove.l	fp0,d0
	move.l	d0,-$8(a5)
	addq.l	#1,-$8(a5)
;	sint32 maxX = (sint32)(((view.BBR().x/scale)*(float32)dimension)+0
	fmove.s	$16C(a3),fp0
	fdiv.s	_scale__WORLDMAP,fp0
	fmove.l	_dimension__WORLDMAP,fp1
	fmul.x	fp1,fp0
	fadd.s	#$.3F000000,fp0
	fmove.l	fp0,d0
	move.l	d0,-$C(a5)
	addq.l	#1,-$C(a5)
;	sint32 minY = (sint32)(((view.BBR().y/scale)*(float32)dimension)-0
	fmove.s	$170(a3),fp0
	fdiv.s	_scale__WORLDMAP,fp0
	fmove.l	_dimension__WORLDMAP,fp1
	fmul.x	fp1,fp0
	fsub.s	#$.3F000000,fp0
	fmove.l	fp0,d0
	subq.l	#1,d0
;	minX = ClipInt(minX, 0, dimension);
	move.l	_dimension__WORLDMAP,d3
	moveq	#0,d2
	move.l	-4(a5),d1
	cmp.l	d2,d1
	bge.b	L852
L851
	move.l	d2,-4(a5)
	bra.b	L856
L852
	cmp.l	d3,d1
	ble.b	L854
L853
	move.l	d3,-4(a5)
	bra.b	L855
L854
	move.l	d1,-4(a5)
L855
L856
;	minY = ClipInt(minY, 0, dimension);
	move.l	_dimension__WORLDMAP,d2
	moveq	#0,d1
	cmp.l	d1,d0
	bge.b	L858
L857
	move.l	d1,d0
	bra.b	L862
L858
	cmp.l	d2,d0
	ble.b	L860
L859
	move.l	d2,d0
L860
L861
L862
;	maxX = ClipInt(maxX, 0, dimension);
	move.l	_dimension__WORLDMAP,d3
	moveq	#0,d2
	move.l	-$C(a5),d1
	cmp.l	d2,d1
	bge.b	L864
L863
	move.l	d2,-$C(a5)
	bra.b	L868
L864
	cmp.l	d3,d1
	ble.b	L866
L865
	move.l	d3,-$C(a5)
	bra.b	L867
L866
	move.l	d1,-$C(a5)
L867
L868
;	maxY = ClipInt(maxY, 0, dimension);
	move.l	_dimension__WORLDMAP,d3
	moveq	#0,d2
	move.l	-$8(a5),d1
	cmp.l	d2,d1
	bge.b	L870
L869
	move.l	d2,-$8(a5)
	bra.b	L874
L870
	cmp.l	d3,d1
	ble.b	L872
L871
	move.l	d3,-$8(a5)
	bra.b	L873
L872
	move.l	d1,-$8(a5)
L873
L874
;	detailLevel = (view.Zoom()-MinZoom())/MaxZoom();
	fmove.l	_dimension__WORLDMAP,fp1
	fmul.d	#$.3FB00000.00000000,fp1
	fmove.s	$178(a3),fp0
	fsub.x	fp1,fp0
	fmove.l	_dimension__WORLDMAP,fp1
	fmul.d	#$.3FE80000.00000000,fp1
	fdiv.x	fp1,fp0
	fmove.s	fp0,_detailLevel__WORLDMAP
;	FreeVertices();
	clr.l	_vCachePtr__AXON
;	
;		sint32 i = 0
	moveq	#0,d5
;		sint32 i = 0, j = 0
	moveq	#0,d4
;		sint32 i = 0, j = 0, k = 0;
	moveq	#0,d3
;		for (rsint32 y = minY;
	move.l	d0,d7
	bra	L884
L875
;		
;			for (rsint32 x = minX;
	move.l	-4(a5),d2
	bra.b	L882
L876
;			
;				register MAPCELL* c = &Cell(x,y);
	moveq	#0,d0
	move.w	d7,d0
	mulu.l	_dimension__WORLDMAP,d0
	moveq	#0,d1
	move.w	d2,d1
	add.l	d1,d0
	asl.l	#$8,d0
	move.l	_cell__WORLDMAP,a0
	lea	0(a0,d0.l),a2
;				if (c->Visibility(view))
	move.l	a3,-(a7)
	move.l	a2,-(a7)
	jsr	Visibility__MAPCELL__TR04VIEW
	addq.w	#$8,a7
	tst.w	d0
	beq.b	L881
L877
;				
;					visible[i++] = c;
	move.l	d5,d0
	addq.l	#1,d5
	move.l	_visible__WORLDMAP,a1
	move.l	a2,0(a1,d0.l*4)
;					if (c->Wet())
	move.l	(a2),d0
	and.l	#$10,d0
	tst.w	d0
	beq.b	L879
L878
;						wet[j++] = c;
	move.l	d4,d0
	addq.l	#1,d4
	move.l	_wet__WORLDMAP,a1
	move.l	a2,0(a1,d0.l*4)
L879
;					if (c->Thing())
	tst.l	$C(a2)
	beq.b	L881
L880
;						things[k++] = c->Thing();
	move.l	$C(a2),a1
	move.l	d3,d0
	addq.l	#1,d3
	move.l	_things__WORLDMAP,a2
	move.l	a1,0(a2,d0.l*4)
L881
	addq.l	#1,d2
L882
	cmp.l	-$C(a5),d2
	blt.b	L876
L883
	move.l	d7,d0
	addq.l	#1,d0
	move.l	d0,d7
L884
	move.l	d7,d0
	cmp.l	-$8(a5),d0
	blt	L875
L885
;		visible[i]	= 0;
	move.l	_visible__WORLDMAP,a1
	clr.l	0(a1,d5.l*4)
;		wet[j]			= 0;
	move.l	_wet__WORLDMAP,a1
	clr.l	0(a1,d4.l*4)
;		things[k]		= 0;
	move.l	_things__WORLDMAP,a1
	clr.l	0(a1,d3.l*4)
	moveq	#0,d0
	fmovem.x (a7)+,fp2
	movem.l	(a7)+,d2-d7/a2/a3
	unlk	a5
	rts

	SECTION "Render__WORLDMAP__R04VIEW:0",CODE


;uint32 WORLDMAP::Render(VIEW& view)
	XDEF	Render__WORLDMAP__R04VIEW
Render__WORLDMAP__R04VIEW
L919	EQU	-$1C
	link	a5,#L919
	movem.l	d2/d3/a2/a3/a6,-(a7)
	move.l	$8(a5),a3
L887
;	if(view.State(VIEW::CHANGED))
	move.l	#$20000,d0
	and.l	$180(a3),d0
	beq.b	L889
L888
;	
;		view.Project();
	move.l	a3,-(a7)
	jsr	Project__VIEW__T
	addq.w	#4,a7
;		Clip(view);
	move.l	a3,-(a7)
	jsr	Clip__WORLDMAP__R04VIEW
	addq.w	#4,a7
L889
;	stopWatch.Set();
	move.l	_TimerBase,a6
	move.l	#_current__xTIMABLE,a0
	jsr	-$3C(a6)
	move.l	#_stopWatch__WORLDMAP,a0
	lea	$8(a0),a1
	lea	_current__xTIMABLE,a0
	move.l	(a0),(a1)
	move.l	4(a0),4(a1)
;	
;		Disable(ALPHA_BLEND);
	move.l	_context__x3D,a0
	move.l	_Warp3DBase,a6
	move.l	#$2000,d0
	moveq	#2,d1
	jsr	-$30(a6)
;		Enable(GOURAUD);
	move.l	_context__x3D,a0
	move.l	_Warp3DBase,a6
	move.l	#$400,d0
	moveq	#1,d1
	jsr	-$30(a6)
;		Enable(TEXTURE);
	move.l	_context__x3D,a0
	move.l	_Warp3DBase,a6
	move.l	#$100,d0
	moveq	#1,d1
	jsr	-$30(a6)
;		Enable(DEPTH_BUFFER);
	move.l	_context__x3D,a0
	move.l	_Warp3DBase,a6
	move.l	#$800,d0
	moveq	#1,d1
	jsr	-$30(a6)
;		Enable(DEPTH_UPDATE);
	move.l	_context__x3D,a0
	move.l	_Warp3DBase,a6
	move.l	#$1000,d0
	moveq	#1,d1
	jsr	-$30(a6)
;		ClearDepthBuffer();
	move.l	#$3FF00000,-$C(a5)
	clr.l	-$8(a5)
	move.l	_context__x3D,a0
	move.l	_Warp3DBase,a6
	lea	-$C(a5),a1
	jsr	-$E4(a6)
;		rsint32 i = 0;
	moveq	#0,d2
;		while(visible[i])
	bra.b	L891
L890
;			visible[i++]->Render(view);
	move.l	a3,-(a7)
	move.l	d2,d0
	addq.l	#1,d2
	move.l	_visible__WORLDMAP,a1
	move.l	0(a1,d0.l*4),-(a7)
	jsr	Render__MAPCELL__TR04VIEW
	addq.w	#$8,a7
L891
	move.l	_visible__WORLDMAP,a1
	tst.l	0(a1,d2.l*4)
	bne.b	L890
L892
;		if (view.State(VIEW::DETAIL) && detailLevel > 0.4F)
	moveq	#$10,d0
	and.l	$180(a3),d0
	beq	L898
L893
	fmove.s	_detailLevel__WORLDMAP,fp0
	fcmp.s	#$.3ECCCCCD,fp0
	fbole.b	L898
L894
;		
;			Disable(DEPTH_UPDATE);
	move.l	_context__x3D,a0
	move.l	_Warp3DBase,a6
	move.l	#$1000,d0
	moveq	#2,d1
	jsr	-$30(a6)
;			Enable(ALPHA_BLEND);
	move.l	_context__x3D,a0
	move.l	_Warp3DBase,a6
	move.l	#$2000,d0
	moveq	#1,d1
	jsr	-$30(a6)
;			i = 0;
	moveq	#0,d2
;			while(visible[i])
	bra.b	L896
L895
;				visible[i++]->Detail();
	move.l	d2,d0
	addq.l	#1,d2
	move.l	_visible__WORLDMAP,a1
	move.l	0(a1,d0.l*4),-(a7)
	jsr	Detail__MAPCELL__T
	addq.w	#4,a7
L896
	move.l	_visible__WORLDMAP,a1
	tst.l	0(a1,d2.l*4)
	bne.b	L895
L897
;			Disable(ALPHA_BLEND);
	move.l	_context__x3D,a0
	move.l	_Warp3DBase,a6
	move.l	#$2000,d0
	moveq	#2,d1
	jsr	-$30(a6)
;			Enable(DEPTH_UPDATE);
	move.l	_context__x3D,a0
	move.l	_Warp3DBase,a6
	move.l	#$1000,d0
	moveq	#1,d1
	jsr	-$30(a6)
L898
;		if (view.State(VIEW::WATER))
	moveq	#$40,d0
	and.l	$180(a3),d0
	beq	L903
L899
;		
;			Enable(ALPHA_BLEND);
	move.l	_context__x3D,a0
	move.l	_Warp3DBase,a6
	move.l	#$2000,d0
	moveq	#1,d1
	jsr	-$30(a6)
;			Disable(GOURAUD);
	move.l	_context__x3D,a0
	move.l	_Warp3DBase,a6
	move.l	#$400,d0
	moveq	#2,d1
	jsr	-$30(a6)
;			SetColour(0xFFB0C0FF);
	lea	-$1C(a5),a0
	move.l	#-$4F3F01,d1
	move.l	#$FF0000,d0
	move.l	d1,d2
	and.l	d0,d2
	moveq	#$10,d3
	lsr.l	d3,d2
	move.l	#_cTab__xDRAW,a2
	move.l	0(a2,d2.l*4),(a0)+
	moveq	#$8,d2
	lsr.l	d2,d0
	move.l	d1,d2
	and.l	d0,d2
	moveq	#$8,d3
	lsr.l	d3,d2
	move.l	#_cTab__xDRAW,a2
	move.l	0(a2,d2.l*4),(a0)+
	moveq	#$8,d2
	lsr.l	d2,d0
	move.l	d1,d2
	and.l	d0,d2
	move.l	#_cTab__xDRAW,a2
	move.l	0(a2,d2.l*4),(a0)+
	moveq	#$18,d2
	asl.l	d2,d0
	and.l	d0,d1
	moveq	#$18,d0
	lsr.l	d0,d1
	move.l	#_cTab__xDRAW,a2
	move.l	0(a2,d1.l*4),(a0)
	move.l	_context__x3D,a0
	move.l	_Warp3DBase,a6
	lea	-$1C(a5),a1
	jsr	-$168(a6)
;			i = 0;
	moveq	#0,d2
;			while(wet[i])
	bra.b	L901
L900
;				wet[i++]->WaterSurf();
	move.l	d2,d0
	addq.l	#1,d2
	move.l	_wet__WORLDMAP,a1
	move.l	0(a1,d0.l*4),-(a7)
	jsr	WaterSurf__MAPCELL__T
	addq.w	#4,a7
L901
	move.l	_wet__WORLDMAP,a1
	tst.l	0(a1,d2.l*4)
	bne.b	L900
L902
;			Enable(GOURAUD);
	move.l	_context__x3D,a0
	move.l	_Warp3DBase,a6
	move.l	#$400,d0
	moveq	#1,d1
	jsr	-$30(a6)
L903
;		if (view.State(VIEW::MODELS))
	moveq	#$20,d0
	and.l	$180(a3),d0
	beq.b	L907
L904
;		
;			i = 0;
	moveq	#0,d2
;			while(things[i])
	bra.b	L906
L905
;				things[i++]->Render(view);
	move.l	a3,-(a7)
	move.l	d2,d0
	addq.l	#1,d2
	move.l	_things__WORLDMAP,a1
	move.l	0(a1,d0.l*4),a0
	move.l	$8C(a0),a1
	move.l	a0,d0
	add.l	$14(a1),d0
	move.l	d0,-(a7)
	move.l	$10(a1),a1
	jsr	(a1)
	addq.w	#$8,a7
L906
	move.l	_things__WORLDMAP,a1
	tst.l	0(a1,d2.l*4)
	bne.b	L905
L907
;		Disable(GOURAUD);
	move.l	_context__x3D,a0
	move.l	_Warp3DBase,a6
	move.l	#$400,d0
	moveq	#2,d1
	jsr	-$30(a6)
;	frameTime = stopWatch.ElapsedSet();
	move.l	#_stopWatch__WORLDMAP,a2
	move.l	_TimerBase,a6
	move.l	#_current__xTIMABLE,a0
	jsr	-$3C(a6)
	move.l	_current__xTIMABLE,d1
	cmp.l	$8(a2),d1
	bne.b	L909
L908
	move.l	_current__xTIMABLE+4,d0
	sub.l	$C(a2),d0
	bra.b	L910
L909
	moveq	#-1,d0
	sub.l	$C(a2),d0
	move.l	_current__xTIMABLE+4,d1
	add.l	d1,d0
L910
	mulu.l	#$3E8,d0
	divul.l	_clockFreq__xTIMABLE,d0
	move.l	d0,_frameTime__WORLDMAP
;	totalTime += frameTime;
	move.l	_totalTime__WORLDMAP,d0
	add.l	_frameTime__WORLDMAP,d0
	move.l	d0,_totalTime__WORLDMAP
;	if (view.State(VIEW::SHOWMAP))
	moveq	#4,d0
	and.l	$180(a3),d0
	beq	L916
L911
;	
;		Disable(DEPTH_UPDATE);
	move.l	_context__x3D,a0
	move.l	_Warp3DBase,a6
	move.l	#$1000,d0
	moveq	#2,d1
	jsr	-$30(a6)
;		Disable(TEXTURE);
	move.l	_context__x3D,a0
	move.l	_Warp3DBase,a6
	move.l	#$100,d0
	moveq	#2,d1
	jsr	-$30(a6)
;		Enable(ALPHA_BLEND);
	move.l	_context__x3D,a0
	move.l	_Warp3DBase,a6
	move.l	#$2000,d0
	moveq	#1,d1
	jsr	-$30(a6)
;		if (view.State(VIEW::SHOWMAPC))
	moveq	#$8,d0
	and.l	$180(a3),d0
	beq.b	L915
L912
;		
;			rsint32 i = 0;
	moveq	#0,d2
;			while(visible[i])
	bra.b	L914
L913
;				visible[i++]->Display(view);
	move.l	a3,-(a7)
	move.l	d2,d0
	addq.l	#1,d2
	move.l	_visible__WORLDMAP,a1
	move.l	0(a1,d0.l*4),-(a7)
	jsr	Display__MAPCELL__TR04VIEW
	addq.w	#$8,a7
L914
	move.l	_visible__WORLDMAP,a1
	tst.l	0(a1,d2.l*4)
	bne.b	L913
L915
;		view.Display();
	move.l	a3,-(a7)
	jsr	Display__VIEW__T
	addq.w	#4,a7
;		Disable(ALPHA_BLEND);
	move.l	_context__x3D,a0
	move.l	_Warp3DBase,a6
	move.l	#$2000,d0
	moveq	#2,d1
	jsr	-$30(a6)
L916
;	frames++;
	addq.l	#1,_frames__WORLDMAP
;	if (view.State(VIEW::STATS))
	move.l	#$80,d0
	and.l	$180(a3),d0
	beq.b	L918
L917
;		DisplayStats(view);
	move.l	a3,-(a7)
	jsr	DisplayStats__WORLDMAP__R04VIEW
	addq.w	#4,a7
L918
;	view.FrameDone();
	move.l	a3,a0
	or.l	#$40000,$180(a0)
	and.l	#-$20001,$180(a0)
	move.l	_frameTime__WORLDMAP,d0
	movem.l	(a7)+,d2/d3/a2/a3/a6
	unlk	a5
	rts

	SECTION "DisplayStats__WORLDMAP__R04VIEW:0",CODE


;void WORLDMAP::DisplayStats(VIEW& view)
	XDEF	DisplayStats__WORLDMAP__R04VIEW
DisplayStats__WORLDMAP__R04VIEW
	movem.l	d2-d5/a2/a6,-(a7)
	fmovem.x fp2,-(a7)
	move.l	$28(a7),a2
L920
;	sint16					viewW = view.Width();
	move.l	a2,a0
	cmp.w	#0,a0
	beq.b	L922
L921
	move.l	4(a0),a0
L922
	move.l	$8(a0),a1
	move.l	a0,d0
	add.l	$2C(a1),d0
	move.l	d0,-(a7)
	move.l	$28(a1),a1
	jsr	(a1)
	addq.w	#4,a7
;	sint16					viewH = view.Height();
	move.l	a2,a0
	cmp.w	#0,a0
	beq.b	L924
L923
	move.l	4(a0),a0
L924
	move.l	$8(a0),a1
	move.l	a0,d0
	add.l	$24(a1),d0
	move.l	d0,-(a7)
	move.l	$20(a1),a1
	jsr	(a1)
	addq.w	#4,a7
	move.w	d0,d2
;	float32					vCacheUse = (float32)vCachePtr/VCACHESIZE;
	fmove.l	_vCachePtr__AXON,fp2
	fdiv.s	#$.46800000,fp2
;	peakVCache	= frames&63UL ? (vCacheUse>peakVCache ? vCacheUse:peakV
	move.l	_frames__WORLDMAP,d0
	and.l	#$3F,d0
	beq.b	L929
L925
	fcmp.s	_peakVCache__DisplayStats__WORLDMAP__R04VIEW,fp2
	fbole.b	L927
L926
	fmove.x	fp2,fp0
	bra.b	L928
L927
	fmove.s	_peakVCache__DisplayStats__WORLDMAP__R04VIEW,fp0
L928
	bra.b	L930
L929
	fmove.x	fp2,fp0
L930
	fmove.s	fp0,_peakVCache__DisplayStats__WORLDMAP__R04VIEW
;	peakTime		= frames&63UL ? (frameTime>peakTime ? frameTime:peakTime)
	move.l	_frames__WORLDMAP,d0
	and.l	#$3F,d0
	beq.b	L935
L931
	move.l	_frameTime__WORLDMAP,d0
	cmp.l	_peakTime__DisplayStats__WORLDMAP__R04VIEW,d0
	bls.b	L933
L932
	move.l	_frameTime__WORLDMAP,d0
	bra.b	L934
L933
	move.l	_peakTime__DisplayStats__WORLDMAP__R04VIEW,d0
L934
	bra.b	L936
L935
	move.l	_frameTime__WORLDMAP,d0
L936
	move.l	d0,_peakTime__DisplayStats__WORLDMAP__R04VIEW
;	Disable(DEPTH_BUFFER);
	move.l	_context__x3D,a0
	move.l	_Warp3DBase,a6
	move.l	#$800,d0
	moveq	#2,d1
	jsr	-$30(a6)
;	Enable(ALPHA_BLEND);
	move.l	_context__x3D,a0
	move.l	_Warp3DBase,a6
	move.l	#$2000,d0
	moveq	#1,d1
	jsr	-$30(a6)
;	RectShV(gradient, Coord(16, 16), Coord(32, viewH-16));
	move.w	d2,d0
	ext.l	d0
	sub.l	#$10,d0
	move.w	d0,d1
	moveq	#$20,d0
	ext.l	d0
	moveq	#$10,d3
	asl.l	d3,d0
	ext.l	d1
	and.l	#$FFFF,d1
	or.l	d1,d0
	move.l	d0,-(a7)
	moveq	#$10,d0
	ext.l	d0
	moveq	#$10,d3
	asl.l	d3,d0
	moveq	#$10,d1
	ext.l	d1
	and.l	#$FFFF,d1
	or.l	d1,d0
	move.l	d0,-(a7)
	move.l	#_gradient__DisplayStats__WORLDMAP__R04VIEW,a6
	jsr	RectShV__xDRAW__r14PUjUjUj
	addq.w	#$8,a7
;	RectShV(gradient, Coord(40, 16), Coord(56, viewH-16));
	move.w	d2,d0
	ext.l	d0
	sub.l	#$10,d0
	move.w	d0,d1
	moveq	#$38,d0
	ext.l	d0
	moveq	#$10,d3
	asl.l	d3,d0
	ext.l	d1
	and.l	#$FFFF,d1
	or.l	d1,d0
	move.l	d0,-(a7)
	moveq	#$28,d0
	ext.l	d0
	moveq	#$10,d3
	asl.l	d3,d0
	moveq	#$10,d1
	ext.l	d1
	and.l	#$FFFF,d1
	or.l	d1,d0
	move.l	d0,-(a7)
	move.l	#_gradient__DisplayStats__WORLDMAP__R04VIEW,a6
	jsr	RectShV__xDRAW__r14PUjUjUj
	addq.w	#$8,a7
;	RectShV(gradient, Coord(64, 16), Coord(80, viewH-16));
	move.w	d2,d0
	ext.l	d0
	sub.l	#$10,d0
	move.w	d0,d1
	moveq	#$50,d0
	ext.l	d0
	moveq	#$10,d3
	asl.l	d3,d0
	ext.l	d1
	and.l	#$FFFF,d1
	or.l	d1,d0
	move.l	d0,-(a7)
	moveq	#$40,d0
	ext.l	d0
	moveq	#$10,d3
	asl.l	d3,d0
	moveq	#$10,d1
	ext.l	d1
	and.l	#$FFFF,d1
	or.l	d1,d0
	move.l	d0,-(a7)
	move.l	#_gradient__DisplayStats__WORLDMAP__R04VIEW,a6
	jsr	RectShV__xDRAW__r14PUjUjUj
	addq.w	#$8,a7
;	RectShV(gradient, Coord(88, 16), Coord(104, viewH-16));
	move.w	d2,d0
	ext.l	d0
	sub.l	#$10,d0
	move.w	d0,d1
	moveq	#$68,d0
	ext.l	d0
	moveq	#$10,d3
	asl.l	d3,d0
	ext.l	d1
	and.l	#$FFFF,d1
	or.l	d1,d0
	move.l	d0,-(a7)
	moveq	#$58,d0
	ext.l	d0
	moveq	#$10,d3
	asl.l	d3,d0
	moveq	#$10,d1
	ext.l	d1
	and.l	#$FFFF,d1
	or.l	d1,d0
	move.l	d0,-(a7)
	move.l	#_gradient__DisplayStats__WORLDMAP__R04VIEW,a6
	jsr	RectShV__xDRAW__r14PUjUjUj
	addq.w	#$8,a7
;	Rect(0x80FFFFFF, Coord(18, viewH-peakTime-16), Coord(30, viewH-16))
	move.w	d2,d0
	ext.l	d0
	sub.l	#$10,d0
	move.w	d0,d1
	moveq	#$1E,d0
	ext.l	d0
	moveq	#$10,d3
	asl.l	d3,d0
	ext.l	d1
	and.l	#$FFFF,d1
	or.l	d1,d0
	move.l	d0,-(a7)
	move.w	d2,d0
	ext.l	d0
	sub.l	_peakTime__DisplayStats__WORLDMAP__R04VIEW,d0
	sub.l	#$10,d0
	move.w	d0,d1
	moveq	#$12,d0
	ext.l	d0
	moveq	#$10,d3
	asl.l	d3,d0
	ext.l	d1
	and.l	#$FFFF,d1
	or.l	d1,d0
	move.l	d0,-(a7)
	move.l	#$80FFFFFF,-(a7)
	jsr	Rect__xDRAW__UjUjUj
	add.w	#$C,a7
;	Rect(0x80FFFFFF, Coord(42, viewH-frameTime-16), Coord(54, viewH-16)
	move.w	d2,d0
	ext.l	d0
	sub.l	#$10,d0
	move.w	d0,d1
	moveq	#$36,d0
	ext.l	d0
	moveq	#$10,d3
	asl.l	d3,d0
	ext.l	d1
	and.l	#$FFFF,d1
	or.l	d1,d0
	move.l	d0,-(a7)
	move.w	d2,d0
	ext.l	d0
	sub.l	_frameTime__WORLDMAP,d0
	sub.l	#$10,d0
	move.w	d0,d1
	moveq	#$2A,d0
	ext.l	d0
	moveq	#$10,d3
	asl.l	d3,d0
	ext.l	d1
	and.l	#$FFFF,d1
	or.l	d1,d0
	move.l	d0,-(a7)
	move.l	#$80FFFFFF,-(a7)
	jsr	Rect__xDRAW__UjUjUj
	add.w	#$C,a7
;	sint16 v = (sint16)(peakVCache*((float32)viewH-32));
	move.w	d2,d0
	ext.l	d0
	fmove.l	d0,fp0
	fsub.s	#$.42000000,fp0
	fmul.s	_peakVCache__DisplayStats__WORLDMAP__R04VIEW,fp0
	fmove.l	fp0,d0
	move.w	d0,d3
;	Rect(0x80FFFFFF, Coord(66, viewH-v-16), Coord(78, viewH-16));
	move.w	d2,d0
	ext.l	d0
	sub.l	#$10,d0
	move.w	d0,d1
	moveq	#$4E,d0
	ext.l	d0
	moveq	#$10,d4
	asl.l	d4,d0
	ext.l	d1
	and.l	#$FFFF,d1
	or.l	d1,d0
	move.l	d0,-(a7)
	move.w	d2,d0
	ext.l	d0
	move.w	d3,d1
	ext.l	d1
	sub.l	d1,d0
	sub.l	#$10,d0
	move.w	d0,d1
	moveq	#$42,d0
	ext.l	d0
	moveq	#$10,d3
	asl.l	d3,d0
	ext.l	d1
	and.l	#$FFFF,d1
	or.l	d1,d0
	move.l	d0,-(a7)
	move.l	#$80FFFFFF,-(a7)
	jsr	Rect__xDRAW__UjUjUj
	add.w	#$C,a7
;	v = (sint16)(vCacheUse*((float32)viewH-32));
	move.w	d2,d0
	ext.l	d0
	fmove.l	d0,fp0
	fsub.s	#$.42000000,fp0
	fmul.x	fp0,fp2
	fmove.l	fp2,d0
	move.w	d0,d3
;	Rect(0x80FFFFFF, Coord(90, viewH-v-16), Coord(102, viewH-16));
	move.w	d2,d0
	ext.l	d0
	sub.l	#$10,d0
	move.w	d0,d1
	moveq	#$66,d0
	ext.l	d0
	moveq	#$10,d4
	asl.l	d4,d0
	ext.l	d1
	and.l	#$FFFF,d1
	or.l	d1,d0
	move.l	d0,-(a7)
	move.w	d2,d0
	ext.l	d0
	move.w	d3,d1
	ext.l	d1
	sub.l	d1,d0
	sub.l	#$10,d0
	move.w	d0,d1
	moveq	#$5A,d0
	ext.l	d0
	moveq	#$10,d2
	asl.l	d2,d0
	ext.l	d1
	and.l	#$FFFF,d1
	or.l	d1,d0
	move.l	d0,-(a7)
	move.l	#$80FFFFFF,-(a7)
	jsr	Rect__xDRAW__UjUjUj
	add.w	#$C,a7
;	
;		Enable(DEPTH_BUFFER);
	move.l	_context__x3D,a0
	move.l	_Warp3DBase,a6
	move.l	#$800,d0
	moveq	#1,d1
	jsr	-$30(a6)
;		Disable(DEPTH_UPDATE);
	move.l	_context__x3D,a0
	move.l	_Warp3DBase,a6
	move.l	#$1000,d0
	moveq	#2,d1
	jsr	-$30(a6)
;		Enable(ALPHA_BLEND);
	move.l	_context__x3D,a0
	move.l	_Warp3DBase,a6
	move.l	#$2000,d0
	moveq	#1,d1
	jsr	-$30(a6)
;		uint16 w = view.Width();
	move.l	a2,a0
	cmp.w	#0,a0
	beq.b	L938
L937
	move.l	4(a0),a0
L938
	move.l	$8(a0),a1
	move.l	a0,d0
	add.l	$2C(a1),d0
	move.l	d0,-(a7)
	move.l	$28(a1),a1
	jsr	(a1)
	addq.w	#4,a7
	move.w	d0,d3
;		uint16 h = view.Height();
	move.l	a2,a0
	cmp.w	#0,a0
	beq.b	L940
L939
	move.l	a2,a0
	move.l	4(a0),a2
L940
	move.l	a2,a1
	move.l	$8(a1),a0
	move.l	a2,d0
	add.l	$24(a0),d0
	move.l	d0,-(a7)
	move.l	$20(a0),a0
	jsr	(a0)
	addq.w	#4,a7
	move.w	d0,d4
;		for (uint16 n = 0;
	moveq	#0,d2
	bra.b	L942
L941
;		
;			float64 z = (float64)(w-n)/(float64)w;
	moveq	#0,d0
	move.w	d3,d0
	moveq	#0,d1
	move.w	d2,d1
	sub.l	d1,d0
	fmove.l	d0,fp0
	moveq	#0,d0
	move.w	d3,d0
	fmove.l	d0,fp1
	fdiv.x	fp1,fp0
;			DepthD(z);
	fmove.d	fp0,_zDepth__xDRAW
;			Line(0x7FFFFFFF, Coord(n,0), Coord(n,h));
	move.w	d2,d0
	ext.l	d0
	moveq	#$10,d5
	asl.l	d5,d0
	move.w	d4,d1
	ext.l	d1
	and.l	#$FFFF,d1
	or.l	d1,d0
	move.l	d0,-(a7)
	move.w	d2,d0
	ext.l	d0
	moveq	#$10,d5
	asl.l	d5,d0
	moveq	#0,d1
	ext.l	d1
	and.l	#$FFFF,d1
	or.l	d1,d0
	move.l	d0,-(a7)
	move.l	#$7FFFFFFF,-(a7)
	jsr	Line__xDRAW__UjUjUj
	add.w	#$C,a7
	addq.w	#$8,d2
L942
	cmp.w	d3,d2
	blo.b	L941
L943
;	Disable(ALPHA_BLEND);
	move.l	_context__x3D,a0
	move.l	_Warp3DBase,a6
	move.l	#$2000,d0
	moveq	#2,d1
	jsr	-$30(a6)
	fmovem.x (a7)+,fp2
	movem.l	(a7)+,d2-d5/a2/a6
	rts

	SECTION "DisplayStats__WORLDMAP__R04VIEW:1",DATA

_gradient__DisplayStats__WORLDMAP__R04VIEW
	dc.l	$A0FF2000,-$FF8000
_peakTime__DisplayStats__WORLDMAP__R04VIEW
	dc.l	0
_peakVCache__DisplayStats__WORLDMAP__R04VIEW
	dc.l	0

	SECTION "_0dt__xTIMABLE__T:0",CODE

	CNOP	0,2

	XDEF	_0dt__xTIMABLE__T
_0dt__xTIMABLE__T
L944
	rts

	END
