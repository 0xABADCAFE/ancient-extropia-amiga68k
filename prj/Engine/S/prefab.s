
; Storm C Compiler
; Mendoza:Extropia/eXtropia/prj/Engine/prefab.cpp
	mc68030
	mc68881
	XREF	Delete__PREFAB_EDIT__T
	XREF	Rotate__TRANSFORM__Tfff
	XREF	_fabs__r
	XREF	_sqrt__r
	XREF	_acos__r
	XREF	_0dt__DRAWLIST__T
	XREF	Delete__xTEXFONT__T
	XREF	_0ct__xTEXSURF__T
	XREF	Delete__xTEXSURF__T
	XREF	ReadBody__xTEXSURF__TR05XSFIO
	XREF	WriteBody__xTEXSURF__TR05XSFIO
	XREF	ReadyForRead__xTEXSURF__T
	XREF	ReadyForWrite__xTEXSURF__T
	XREF	_0ct__XSFOBJ__T
	XREF	Set__XSFHEAD__TPCcUcUcUcUc
	XREF	op__equal__XSFHEAD__TR05XSFIO
	XREF	op__equal__XSFHEAD__TR07XSFHEAD
	XREF	op__notEqual__XSFHEAD__TR07XSFHEAD
	XREF	Value__XDATAID__TPCc
	XREF	Refresh__xDBSCREEN__T
	XREF	Close__xDBSCREEN__T
	XREF	Open__xDBSCREEN__T
	XREF	Close__xSCREEN__T
	XREF	Open__xSCREEN__T
	XREF	Set__xSCREEN__TP06xDMODEPCc
	XREF	Close__xDBWIN__T
	XREF	Open__xDBWIN__T
	XREF	Set__xDBWIN__TsssssPCc
	XREF	MoveEvent__xDISPLAYIO__T
	XREF	ResizeEvent__xDISPLAYIO__T
	XREF	Idle__xDISPLAYIO__T
	XREF	HandleEvent__xDISPLAYIO__T
	XREF	ApplyInputModification__xDISPLAYIO__T
	XREF	ViewSurface__xDISPLAY__T
	XREF	DrawSurface__xDISPLAY__T
	XREF	Refresh__xDISPLAY__T
	XREF	Close__xDISPLAY__T
	XREF	Open__xDISPLAY__T
	XREF	_0dt__LOCK__T
	XREF	_0dt__THREAD__T
	XREF	Run__THREAD__T
	XREF	_0dt__DELAY__T
	XREF	_0ct__DELAY__T
	XREF	Pause__DELAY__TUj
	XREF	Pause__DELAY__TUjUj
	XREF	Abort__DELAY__T
	XREF	UnLink__xCHAINABLE__T
	XREF	Close__xFILEIO__T
	XREF	Flush__xFILEIO__T
	XREF	Write64Swap__xFILEIO__TPvUi
	XREF	Write32Swap__xFILEIO__TPvUi
	XREF	Write16Swap__xFILEIO__TPvUi
	XREF	Write__xFILEIO__TPvUiUi
	XREF	Read64Swap__xFILEIO__TPvUi
	XREF	Read32Swap__xFILEIO__TPvUi
	XREF	Read16Swap__xFILEIO__TPvUi
	XREF	Read__xFILEIO__TPvUiUi
	XREF	Tell__xFILEIO__T
	XREF	Seek__xFILEIO__Tjj
	XREF	Open__xFILEIO__TPCcjj
	XREF	SendPacket__xFILEIO__TPv
	XREF	WaitPacket__xFILEIO__T
	XREF	InputQueued__xINPUT__T
	XREF	Idle__xINPUT__T
	XREF	ExitEvent__xINPUT__T
	XREF	MouseEvent__xINPUT__Tjjj
	XREF	ApplyInputModification__xINPUT__T
	XREF	_0dt__xKEY__T
	XREF	_0ct__xKEY__T
	XREF	KeyEvent__xKEY__Tjsj
	XREF	_0dt__xSURFACE__T
	XREF	_0dt__POOL_ST__T
	XREF	_0ct__POOL_ST__TUsUj
	XREF	FreeT__POOL_ST__TPv
	XREF	NewT__POOL_ST__TPvUs
	XREF	NewT__POOL_ST__TPv
	XREF	Create__POOL_ST__TUsUj
	XREF	_0dt__POOL_LT__T
	XREF	DrawSurface__x3D__P08xSURFACE
	XREF	Free__MEM__Pv
	XREF	Alloc__MEM__UisE
	XREF	_system
	XREF	_printf
	XREF	_puts
	XREF	_std__in
	XREF	_std__out
	XREF	_std__err
	XREF	_st
	XREF	_gxSt
	XREF	_numStartArgs__xBASELIB
	XREF	_startArgs__xBASELIB
	XREF	_SysBase
	XREF	_IntuitionBase
	XREF	_TimerBase
	XREF	_DOSBase
	XREF	_PowerPCBase
	XREF	_sysData__sysBASELIB
	XREF	_msgbuff__sysBASELIB
	XREF	_main__sysBASELIB
	XREF	_allocated__MEM
	XREF	_totSize__MEM
	XREF	_nextFree__MEM
	XREF	_cnt__MEM
	XREF	_maxAllocs__MEM
	XREF	_fpuPrecision__CPU
	XREF	_cpuNames__CPU
	XREF	_GfxBase
	XREF	_CyberGfxBase
	XREF	_surfaceTypes__x2D
	XREF	_Warp3DBase
	XREF	_hw3D__sys3DDEVICE
	XREF	_context__sys3DDEVICE
	XREF	_drawRegion__x3D
	XREF	_fogData__x3D
	XREF	_flags__x3D
	XREF	_vertices__x3D
	XREF	_currTex__x3D
	XREF	_drawSurface__x3D
	XREF	_currCol__x3D
	XREF	_flags__xGFX
	XREF	_mode__xGFX
	XREF	_numModes__xGFX
	XREF	_rPool__xSURFACE
	XREF	_KeymapBase
	XREF	_useCount__xKEY
	XREF	_TimerBase__MILLICLOCK
	XREF	_current__MILLICLOCK
	XREF	_clockFreq__MILLICLOCK
	XREF	_threadCnt__THREAD
	XREF	_threadsIdle__THREAD
	XREF	_rootThread__THREAD
	XREF	_sigXSF__XSFHEAD
	XREF	_fileMarker__XSFOBJ
	XREF	_DiskfontBase
	XREF	_flags__DRAW
	XREF	_stack__VGPU
	XREF	_stackPos__VGPU
	XREF	_vertexBase__VGPU
	XREF	_vertexTop__VGPU
	XREF	_dataPos__VGPU
	XREF	_instPos__VGPU
	XREF	_exe_flags__VGPU
	XREF	_exe_stateReg__VGPU
	XREF	_exe_colourReg__VGPU
	XREF	_exe_texReg__VGPU
	XREF	_exe_fogReg__VGPU
	XREF	_exe_errReg__VGPU
	XREF	_funcTab__VGPU
	XREF	_qTrigTab__DRAWLIST
	XREF	_buf__PREFAB_EDIT

	SECTION "Round16__r23d:0",CODE

	rts

	SECTION "_maxTris__PREFAB_BASE:1",DATA

_maxTris__PREFAB_BASE
	dc.l	$55

	SECTION "_0ct__PREFAB_BASE__T:0",CODE


;PREFAB_BASE::PREFAB_BASE() 
	XDEF	_0ct__PREFAB_BASE__T
_0ct__PREFAB_BASE__T
	move.l	4(a7),a0
L103
	clr.l	(a0)
	clr.l	4(a0)
	clr.l	$8(a0)
	clr.l	$C(a0)
	clr.l	$10(a0)
	rts

	SECTION "Zero__PREFAB_BASE__T:0",CODE


;void PREFAB_BASE::Zero()
	XDEF	Zero__PREFAB_BASE__T
Zero__PREFAB_BASE__T
	move.l	4(a7),a0
L104
;	numTris = 0;
	clr.l	(a0)
;	numVerts = 0;
	clr.l	4(a0)
;	numVertNorms = 0;
	clr.l	$8(a0)
;	numFaceNorms = 0;
	clr.l	$C(a0)
;	numPlaneConsts = 0;
	clr.l	$10(a0)
	rts

	SECTION "Set__PREFAB_BASE__TUiUiUiUiUi:0",CODE


;sint32 PREFAB_BASE::Set(size_t nTris, size_t nVerts, size_t nVNorms,
	XDEF	Set__PREFAB_BASE__TUiUiUiUiUi
Set__PREFAB_BASE__TUiUiUiUiUi
	movem.l	d2-d6/a2,-(a7)
	movem.l	$20(a7),d2/d3/d6
	move.l	$30(a7),d4
	move.l	$2C(a7),d5
	move.l	$1C(a7),a2
L111
;	if (nTris<0 || nTris > maxTris)
L112
	cmp.l	#$55,d2
	bls.b	L114
L113
;		puts("[error] invalid triangle count");
	move.l	#L105,-(a7)
	jsr	_puts
	addq.w	#4,a7
;		return ERR_VALUE;
	move.l	#-$3010000,d0
	movem.l	(a7)+,d2-d6/a2
	rts
L114
;	else if (nTris==0)
	tst.l	d2
	bne.b	L121
L115
;		if (nVerts || nVNorms || nFNorms || nPConsts)
	tst.l	d3
	bne.b	L119
L116
	tst.l	d6
	bne.b	L119
L117
	tst.l	d5
	bne.b	L119
L118
	tst.l	d4
	beq.b	L120
L119
;			puts("[warning] malformed null prefab");
	move.l	#L106,-(a7)
	jsr	_puts
	addq.w	#4,a7
;			Zero();
	move.l	a2,-(a7)
	jsr	Zero__PREFAB_BASE__T
	addq.w	#4,a7
;			return OK;
	moveq	#0,d0
	movem.l	(a7)+,d2-d6/a2
	rts
L120
	bra.b	L133
L121
;		if (nVerts<3 || nVerts>nTris*3)
	cmp.l	#3,d3
	blo.b	L123
L122
	move.l	d2,d0
	mulu.l	#3,d0
	cmp.l	d0,d3
	bls.b	L124
L123
;			puts("[warning] invalid vertex count");
	move.l	#L107,-(a7)
	jsr	_puts
	addq.w	#4,a7
;			nVerts = nTris*3;
	move.l	d2,d3
	mulu.l	#3,d3
L124
;		if (nVNorms<1 || nVNorms>nVerts)
	tst.l	d6
	beq.b	L126
L125
	move.l	d6,d0
	cmp.l	d3,d0
	bls.b	L127
L126
;			puts("[warning] invalid vertex normal count");
	move.l	#L108,-(a7)
	jsr	_puts
	addq.w	#4,a7
;			nVNorms = nVerts;
	move.l	d3,d6
L127
;		if (nFNorms<1 || nFNorms>nTris)
	tst.l	d5
	beq.b	L129
L128
	cmp.l	d2,d5
	bls.b	L130
L129
;			puts("[warning] invalid face normal count");
	move.l	#L109,-(a7)
	jsr	_puts
	addq.w	#4,a7
;			nFNorms = nTris;
	move.l	d2,d5
L130
;		if (nPConsts<1 || nPConsts>nTris)
	tst.l	d4
	beq.b	L132
L131
	cmp.l	d2,d4
	bls.b	L133
L132
;			puts("[warning] invalid plane constant count");
	move.l	#L110,-(a7)
	jsr	_puts
	addq.w	#4,a7
;			nPConsts = nTris;
	move.l	d2,d4
L133
;	numTris					= nTris;
	move.l	d2,(a2)
;	numVerts				= nVerts;
	move.l	d3,4(a2)
;	numVertNorms		= nVNorms;
	move.l	d6,$8(a2)
;	numFaceNorms		= nFNorms;
	move.l	d5,$C(a2)
;	numPlaneConsts	= nPConsts;
	move.l	d4,$10(a2)
;	return OK;
	moveq	#0,d0
	movem.l	(a7)+,d2-d6/a2
	rts

L105
	dc.b	'[error] invalid triangle count',0
L109
	dc.b	'[warning] invalid face normal count',0
L110
	dc.b	'[warning] invalid plane constant count',0
L107
	dc.b	'[warning] invalid vertex count',0
L108
	dc.b	'[warning] invalid vertex normal count',0
L106
	dc.b	'[warning] malformed null prefab',0

	SECTION "Create__PREFAB__TUiUiUiUiUi:0",CODE


;sint32 PREFAB::Create(size_t nTris, size_t nVerts, size_t nVNorms, s
	XDEF	Create__PREFAB__TUiUiUiUiUi
Create__PREFAB__TUiUiUiUiUi
	movem.l	d2-d5/a2,-(a7)
	movem.l	$1C(a7),d0-d4
	move.l	$18(a7),a2
L135
;	if (vertices)
	tst.l	$18(a2)
	beq.b	L137
L136
;		return ERR_RSC_LOCKED;
	move.l	#-$3050004,d0
	movem.l	(a7)+,d2-d5/a2
	rts
L137
;	if (Set(nTris, nVerts, nVNorms, nFNorms, nPConsts)!=OK)
	move.l	d4,-(a7)
	move.l	d3,-(a7)
	move.l	d2,-(a7)
	move.l	d1,-(a7)
	move.l	d0,-(a7)
	move.l	a2,-(a7)
	jsr	Set__PREFAB_BASE__TUiUiUiUiUi
	add.w	#$18,a7
	tst.l	d0
	beq.b	L139
L138
;		Zero();
	move.l	a2,-(a7)
	jsr	Zero__PREFAB_BASE__T
	addq.w	#4,a7
;		return ERR_VALUE;
	move.l	#-$3010000,d0
	movem.l	(a7)+,d2-d5/a2
	rts
L139
;	size_t reqSize = (numTris*sizeof(TRIDEF))
	move.l	(a2),d2
	mulu.l	#$C,d2
	move.l	4(a2),d0
	moveq	#5,d1
	asl.l	d1,d0
	add.l	d0,d2
	move.l	$8(a2),d0
	add.l	$C(a2),d0
	mulu.l	#$C,d0
	add.l	d0,d2
	move.l	$10(a2),d0
	moveq	#2,d1
	asl.l	d1,d0
	add.l	d0,d2
;	void* mem = MEM::Alloc(reqSize, true, MEM::ALIGN_CACHE);
	pea	$10.w
	move.w	#1,-(a7)
	move.l	d2,-(a7)
	jsr	Alloc__MEM__UisE
	add.w	#$A,a7
	move.l	d0,a0
;	if (!mem)
	cmp.w	#0,a0
	bne.b	L141
L140
;		printf("PREFAB::Create() - [error] failed to allocate %d bytes\n
	move.l	d2,-(a7)
	move.l	#L134,-(a7)
	jsr	_printf
	addq.w	#$8,a7
;		Zero();
	move.l	a2,-(a7)
	jsr	Zero__PREFAB_BASE__T
	addq.w	#4,a7
;		return ERR_NO_FREE_STORE;
	move.l	#-$3030001,d0
	movem.l	(a7)+,d2-d5/a2
	rts
L141
;	vertices	 			= (VERTEX*)mem;
	move.l	a0,$18(a2)
;	vertNorms				= (VEC3D*)(vertices + numVerts);
	move.l	4(a2),d0
	asl.l	#5,d0
	move.l	$18(a2),a0
	lea	0(a0,d0.l),a0
	move.l	a0,$1C(a2)
;	faceNorms				= vertNorms + numVertNorms;
	move.l	$8(a2),d0
	muls.l	#$C,d0
	move.l	$1C(a2),a0
	lea	0(a0,d0.l),a0
	move.l	a0,$20(a2)
;	planeConsts			= (float32*)(faceNorms + numFaceNorms);
	move.l	$C(a2),d0
	muls.l	#$C,d0
	move.l	$20(a2),a0
	lea	0(a0,d0.l),a0
	move.l	a0,$24(a2)
;	tris						= (TRIDEF*)(planeConsts + numPlaneConsts);
	move.l	$10(a2),d0
	move.l	$24(a2),a0
	lea	0(a0,d0.l*4),a0
	move.l	a0,$28(a2)
;	return OK;
	moveq	#0,d0
	movem.l	(a7)+,d2-d5/a2
	rts

L134
	dc.b	'PREFAB::Create() - [error] failed to allocate %d bytes',$A,0

	SECTION "Delete__PREFAB__T:0",CODE


;void PREFAB::Delete()
	XDEF	Delete__PREFAB__T
Delete__PREFAB__T
	move.l	a2,-(a7)
	move.l	$8(a7),a2
L142
;	if (vertices)
	tst.l	$18(a2)
	beq.b	L144
L143
;		MEM::Free(vertices);
	move.l	$18(a2),-(a7)
	jsr	Free__MEM__Pv
	addq.w	#4,a7
L144
;	vertices = 0;
	clr.l	$18(a2)
;	Zero();
	move.l	a2,-(a7)
	jsr	Zero__PREFAB_BASE__T
	addq.w	#4,a7
	move.l	(a7)+,a2
	rts

	END
