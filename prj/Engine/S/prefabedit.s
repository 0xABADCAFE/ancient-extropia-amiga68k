
; Storm C Compiler
; Mendoza:Extropia/eXtropia/prj/Engine/prefabedit.cpp
	mc68030
	mc68881
	XREF	Delete__PREFAB__T
	XREF	_0ct__PREFAB_BASE__T
	XREF	Set__PREFAB_BASE__TUiUiUiUiUi
	XREF	Zero__PREFAB_BASE__T
	XREF	Rotate__TRANSFORM__Tfff
	XREF	_fabs__r
	XREF	_sqrt__r
	XREF	_acos__r
	XREF	_0dt__DRAWLIST__T
	XREF	Delete__xTEXFONT__T
	XREF	_0ct__xTEXSURF__T
	XREF	Delete__xTEXSURF__T
	XREF	ReadBody__xTEXSURF__TR05XSFIO
	XREF	WriteBody__xTEXSURF__TR05XSFIO
	XREF	ReadyForRead__xTEXSURF__T
	XREF	ReadyForWrite__xTEXSURF__T
	XREF	_0ct__XSFOBJ__T
	XREF	Set__XSFHEAD__TPCcUcUcUcUc
	XREF	op__equal__XSFHEAD__TR05XSFIO
	XREF	op__equal__XSFHEAD__TR07XSFHEAD
	XREF	op__notEqual__XSFHEAD__TR07XSFHEAD
	XREF	Value__XDATAID__TPCc
	XREF	Refresh__xDBSCREEN__T
	XREF	Close__xDBSCREEN__T
	XREF	Open__xDBSCREEN__T
	XREF	Close__xSCREEN__T
	XREF	Open__xSCREEN__T
	XREF	Set__xSCREEN__TP06xDMODEPCc
	XREF	Close__xDBWIN__T
	XREF	Open__xDBWIN__T
	XREF	Set__xDBWIN__TsssssPCc
	XREF	MoveEvent__xDISPLAYIO__T
	XREF	ResizeEvent__xDISPLAYIO__T
	XREF	Idle__xDISPLAYIO__T
	XREF	HandleEvent__xDISPLAYIO__T
	XREF	ApplyInputModification__xDISPLAYIO__T
	XREF	ViewSurface__xDISPLAY__T
	XREF	DrawSurface__xDISPLAY__T
	XREF	Refresh__xDISPLAY__T
	XREF	Close__xDISPLAY__T
	XREF	Open__xDISPLAY__T
	XREF	_0dt__LOCK__T
	XREF	_0dt__THREAD__T
	XREF	Run__THREAD__T
	XREF	_0dt__DELAY__T
	XREF	_0ct__DELAY__T
	XREF	Pause__DELAY__TUj
	XREF	Pause__DELAY__TUjUj
	XREF	Abort__DELAY__T
	XREF	UnLink__xCHAINABLE__T
	XREF	Close__xFILEIO__T
	XREF	Flush__xFILEIO__T
	XREF	WriteText__xFILEIO__TPce
	XREF	Write64Swap__xFILEIO__TPvUi
	XREF	Write32Swap__xFILEIO__TPvUi
	XREF	Write16Swap__xFILEIO__TPvUi
	XREF	Write__xFILEIO__TPvUiUi
	XREF	ReadText__xFILEIO__TPcjcj
	XREF	Read64Swap__xFILEIO__TPvUi
	XREF	Read32Swap__xFILEIO__TPvUi
	XREF	Read16Swap__xFILEIO__TPvUi
	XREF	Read__xFILEIO__TPvUiUi
	XREF	Tell__xFILEIO__T
	XREF	Seek__xFILEIO__Tjj
	XREF	Open__xFILEIO__TPCcjj
	XREF	SendPacket__xFILEIO__TPv
	XREF	WaitPacket__xFILEIO__T
	XREF	InputQueued__xINPUT__T
	XREF	Idle__xINPUT__T
	XREF	ExitEvent__xINPUT__T
	XREF	MouseEvent__xINPUT__Tjjj
	XREF	ApplyInputModification__xINPUT__T
	XREF	_0dt__xKEY__T
	XREF	_0ct__xKEY__T
	XREF	KeyEvent__xKEY__Tjsj
	XREF	_0dt__xSURFACE__T
	XREF	_0dt__POOL_ST__T
	XREF	_0ct__POOL_ST__TUsUj
	XREF	FreeT__POOL_ST__TPv
	XREF	NewT__POOL_ST__TPvUs
	XREF	NewT__POOL_ST__TPv
	XREF	Create__POOL_ST__TUsUj
	XREF	_0dt__POOL_LT__T
	XREF	DrawSurface__x3D__P08xSURFACE
	XREF	Free__MEM__Pv
	XREF	Alloc__MEM__UisE
	XREF	_qsort
	XREF	_system
	XREF	_sscanf
	XREF	_printf
	XREF	_puts
	XREF	_std__in
	XREF	_std__out
	XREF	_std__err
	XREF	_st
	XREF	_gxSt
	XREF	_numStartArgs__xBASELIB
	XREF	_startArgs__xBASELIB
	XREF	_SysBase
	XREF	_IntuitionBase
	XREF	_TimerBase
	XREF	_DOSBase
	XREF	_PowerPCBase
	XREF	_sysData__sysBASELIB
	XREF	_msgbuff__sysBASELIB
	XREF	_main__sysBASELIB
	XREF	_allocated__MEM
	XREF	_totSize__MEM
	XREF	_nextFree__MEM
	XREF	_cnt__MEM
	XREF	_maxAllocs__MEM
	XREF	_fpuPrecision__CPU
	XREF	_cpuNames__CPU
	XREF	_GfxBase
	XREF	_CyberGfxBase
	XREF	_surfaceTypes__x2D
	XREF	_Warp3DBase
	XREF	_hw3D__sys3DDEVICE
	XREF	_context__sys3DDEVICE
	XREF	_drawRegion__x3D
	XREF	_fogData__x3D
	XREF	_flags__x3D
	XREF	_vertices__x3D
	XREF	_currTex__x3D
	XREF	_drawSurface__x3D
	XREF	_currCol__x3D
	XREF	_flags__xGFX
	XREF	_mode__xGFX
	XREF	_numModes__xGFX
	XREF	_rPool__xSURFACE
	XREF	_KeymapBase
	XREF	_useCount__xKEY
	XREF	_TimerBase__MILLICLOCK
	XREF	_current__MILLICLOCK
	XREF	_clockFreq__MILLICLOCK
	XREF	_threadCnt__THREAD
	XREF	_threadsIdle__THREAD
	XREF	_rootThread__THREAD
	XREF	_sigXSF__XSFHEAD
	XREF	_fileMarker__XSFOBJ
	XREF	_DiskfontBase
	XREF	_flags__DRAW
	XREF	_stack__VGPU
	XREF	_stackPos__VGPU
	XREF	_vertexBase__VGPU
	XREF	_vertexTop__VGPU
	XREF	_dataPos__VGPU
	XREF	_instPos__VGPU
	XREF	_exe_flags__VGPU
	XREF	_exe_stateReg__VGPU
	XREF	_exe_colourReg__VGPU
	XREF	_exe_texReg__VGPU
	XREF	_exe_fogReg__VGPU
	XREF	_exe_errReg__VGPU
	XREF	_funcTab__VGPU
	XREF	_qTrigTab__DRAWLIST

	SECTION "Round16__r23d:0",CODE

	rts

	SECTION "_maxTris__PREFAB_BASE:1",DATA

_maxTris__PREFAB_BASE
	dc.l	$55

	SECTION "_buf__PREFAB_EDIT:0",CODE


	XDEF	_INIT_8_prefabedit_cpp__buf__PREFAB_EDIT
_INIT_8_prefabedit_cpp__buf__PREFAB_EDIT
L179
;char PREFAB_EDIT::buf[256] = {0};
	move.l	#_buf__PREFAB_EDIT,a0
	lea	1(a0),a0
	move.w	#$FE,d0
L180
	clr.b	(a0)+
	dbra	d0,L180
	rts

	SECTION "_buf__PREFAB_EDIT:1",DATA

	XDEF	_buf__PREFAB_EDIT
_buf__PREFAB_EDIT
	dc.b	0
	ds.b	255

	SECTION "Create__PREFAB_EDIT__TUiUiUiUiUi:0",CODE


;sint32 PREFAB_EDIT::Create(size_t nTris, size_t nVerts, size_t nVNor
	XDEF	Create__PREFAB_EDIT__TUiUiUiUiUi
Create__PREFAB_EDIT__TUiUiUiUiUi
	movem.l	d2-d5/a2,-(a7)
	movem.l	$1C(a7),d0-d4
	move.l	$18(a7),a2
L181
;	if (vertices)
	tst.l	$18(a2)
	beq.b	L183
L182
;		return ERR_RSC_LOCKED;
	move.l	#-$3050004,d0
	movem.l	(a7)+,d2-d5/a2
	rts
L183
;	if (Set(nTris, nVerts, nVNorms, nFNorms, nPConsts)==OK)
	move.l	d4,-(a7)
	move.l	d3,-(a7)
	move.l	d2,-(a7)
	move.l	d1,-(a7)
	move.l	d0,-(a7)
	move.l	a2,-(a7)
	jsr	Set__PREFAB_BASE__TUiUiUiUiUi
	add.w	#$18,a7
	tst.l	d0
	bne.b	L187
L184
;		const size_t allocSize = maxTris*(4*sizeof(VEC3D) + 3*sizeof(VER
;		void *mem = MEM::Alloc(allocSize, true, MEM::ALIGN_CACHE);
	pea	$10.w
	move.w	#1,-(a7)
	pea	$3520.w
	jsr	Alloc__MEM__UisE
	add.w	#$A,a7
	move.l	d0,a0
;		if (!mem)
	cmp.w	#0,a0
	bne.b	L186
L185
;			return ERR_NO_FREE_STORE;
	move.l	#-$3030001,d0
	movem.l	(a7)+,d2-d5/a2
	rts
L186
;		vertices	 			= (VERTEX*)mem;
	move.l	a0,$18(a2)
;		vertNorms				= (VEC3D*)(vertices + 3*maxTris);
	move.l	$18(a2),a0
	lea	$1FE0(a0),a0
	move.l	a0,$1C(a2)
;		faceNorms				= vertNorms + maxTris;
	move.l	$1C(a2),a0
	lea	$3FC(a0),a0
	move.l	a0,$20(a2)
;		planeConsts			= (float32*)(faceNorms + maxTris);
	move.l	$20(a2),a0
	lea	$3FC(a0),a0
	move.l	a0,$24(a2)
;		tris						= (TRIDEF*)(planeConsts + maxTris);
	move.l	$24(a2),a0
	lea	$154(a0),a0
	move.l	a0,$28(a2)
;		return OK;
	moveq	#0,d0
	movem.l	(a7)+,d2-d5/a2
	rts
L187
;	return ERR_VALUE;
	move.l	#-$3010000,d0
	movem.l	(a7)+,d2-d5/a2
	rts

	SECTION "Delete__PREFAB_EDIT__T:0",CODE


;void PREFAB_EDIT::Delete()
	XDEF	Delete__PREFAB_EDIT__T
Delete__PREFAB_EDIT__T
	move.l	a2,-(a7)
	move.l	$8(a7),a2
L188
;	if (vertices)
	tst.l	$18(a2)
	beq.b	L190
L189
;		MEM::Free(vertices);
	move.l	$18(a2),-(a7)
	jsr	Free__MEM__Pv
	addq.w	#4,a7
L190
;	vertices = 0;
	clr.l	$18(a2)
;	Zero();
	move.l	a2,-(a7)
	jsr	Zero__PREFAB_BASE__T
	addq.w	#4,a7
	move.l	(a7)+,a2
	rts

	SECTION "ReadTextTri__PREFAB_EDIT__TUi:0",CODE


;bool PREFAB_EDIT::ReadTextTri(size_t i)
	XDEF	ReadTextTri__PREFAB_EDIT__TUi
ReadTextTri__PREFAB_EDIT__TUi
L242	EQU	-$2C
	link	a5,#L242
	movem.l	d2/a2,-(a7)
	move.l	$C(a5),d2
	move.l	$8(a5),a2
L200
;	if (i<0 || i>numTris)
L201
	cmp.l	(a2),d2
	bls.b	L203
L202
;		return false;
	moveq	#0,d0
	movem.l	(a7)+,d2/a2
	unlk	a5
	rts
L203
;	if (sscanf(buf+1, " { %d, %d, %d, %d, %d, %d, %d, %d, %d, %d, %d }
	pea	-$2C(a5)
	pea	-$28(a5)
	pea	-$24(a5)
	pea	-$20(a5)
	pea	-$1C(a5)
	pea	-$18(a5)
	pea	-$14(a5)
	pea	-$10(a5)
	pea	-$C(a5)
	pea	-$8(a5)
	pea	-4(a5)
	move.l	#L191,-(a7)
	move.l	#_buf__PREFAB_EDIT,a1
	pea	1(a1)
	jsr	_sscanf
	add.w	#$34,a7
	cmp.l	#$B,d0
	beq.b	L205
L204
;		puts("Malformed triangle definition");
	move.l	#L192,-(a7)
	jsr	_puts
	addq.w	#4,a7
;		return false;
	moveq	#0,d0
	movem.l	(a7)+,d2/a2
	unlk	a5
	rts
L205
;	if (tex<0 || tex>255) 
	tst.l	-4(a5)
	bmi.b	L207
L206
	move.l	-4(a5),d0
	cmp.l	#$FF,d0
	ble.b	L208
L207
;		printf("Illegal texture index %ld\n", tex);
	move.l	-4(a5),-(a7)
	move.l	#L193,-(a7)
	jsr	_printf
	addq.w	#$8,a7
;		return false;
	moveq	#0,d0
	movem.l	(a7)+,d2/a2
	unlk	a5
	rts
L208
;	else if (v1<0 || v1>=numVerts) 
	tst.l	-$8(a5)
	bmi.b	L210
L209
	move.l	-$8(a5),d1
	cmp.l	4(a2),d1
	blt.b	L211
L210
;		printf("Illegal vertex index %ld\n", v1);
	move.l	-$8(a5),-(a7)
	move.l	#L194,-(a7)
	jsr	_printf
	addq.w	#$8,a7
;		return false;
	moveq	#0,d0
	movem.l	(a7)+,d2/a2
	unlk	a5
	rts
L211
;	else if (v2<0 || v2>=numVerts	|| v2 == v1) 
	tst.l	-$C(a5)
	bmi.b	L214
L212
	move.l	-$C(a5),d1
	cmp.l	4(a2),d1
	bge.b	L214
L213
	move.l	-$C(a5),d0
	cmp.l	-$8(a5),d0
	bne.b	L215
L214
;		printf("Illegal vertex index %ld\n", v2);
	move.l	-$C(a5),-(a7)
	move.l	#L194,-(a7)
	jsr	_printf
	addq.w	#$8,a7
;		return false;
	moveq	#0,d0
	movem.l	(a7)+,d2/a2
	unlk	a5
	rts
L215
;	else if (v3<0 || v3>=numVerts || v3 == v2 || v3 == v1) 
	tst.l	-$10(a5)
	bmi.b	L219
L216
	move.l	-$10(a5),d1
	cmp.l	4(a2),d1
	bge.b	L219
L217
	move.l	-$10(a5),d0
	cmp.l	-$C(a5),d0
	beq.b	L219
L218
	move.l	-$10(a5),d0
	cmp.l	-$8(a5),d0
	bne.b	L220
L219
;		printf("Illegal vertex index %ld\n", v3);
	move.l	-$10(a5),-(a7)
	move.l	#L194,-(a7)
	jsr	_printf
	addq.w	#$8,a7
;		return false;
	moveq	#0,d0
	movem.l	(a7)+,d2/a2
	unlk	a5
	rts
L220
;	else if (n1<0 || n1>=numVertNorms) 
	tst.l	-$14(a5)
	bmi.b	L222
L221
	move.l	-$14(a5),d1
	cmp.l	$8(a2),d1
	blt.b	L223
L222
;		printf("Illegal vertex normal index %ld\n", n1);
	move.l	-$14(a5),-(a7)
	move.l	#L195,-(a7)
	jsr	_printf
	addq.w	#$8,a7
;		return false;
	moveq	#0,d0
	movem.l	(a7)+,d2/a2
	unlk	a5
	rts
L223
;	else if (n2<0 || n2>=numVertNorms) 
	tst.l	-$18(a5)
	bmi.b	L225
L224
	move.l	-$18(a5),d1
	cmp.l	$8(a2),d1
	blt.b	L226
L225
;		printf("Illegal vertex normal index %ld\n", n2);
	move.l	-$18(a5),-(a7)
	move.l	#L195,-(a7)
	jsr	_printf
	addq.w	#$8,a7
;		return false;
	moveq	#0,d0
	movem.l	(a7)+,d2/a2
	unlk	a5
	rts
L226
;	else if (n3<0 || n3>=numVertNorms) 
	tst.l	-$1C(a5)
	bmi.b	L228
L227
	move.l	-$1C(a5),d1
	cmp.l	$8(a2),d1
	blt.b	L229
L228
;		printf("Illegal vertex normal index %ld\n", n3);
	move.l	-$1C(a5),-(a7)
	move.l	#L195,-(a7)
	jsr	_printf
	addq.w	#$8,a7
;		return false;
	moveq	#0,d0
	movem.l	(a7)+,d2/a2
	unlk	a5
	rts
L229
;	else if (fn<0 || fn>=numFaceNorms) 
	tst.l	-$20(a5)
	bmi.b	L231
L230
	move.l	-$20(a5),d1
	cmp.l	$C(a2),d1
	blt.b	L232
L231
;		printf("Illegal face normal index %ld\n", fn);
	move.l	-$20(a5),-(a7)
	move.l	#L196,-(a7)
	jsr	_printf
	addq.w	#$8,a7
;		return false;
	moveq	#0,d0
	movem.l	(a7)+,d2/a2
	unlk	a5
	rts
L232
;	else if (pc<0 || pc>=numPlaneConsts) 
	tst.l	-$24(a5)
	bmi.b	L234
L233
	move.l	-$24(a5),d1
	cmp.l	$10(a2),d1
	blt.b	L235
L234
;		printf("Illegal plane constant index %ld\n", pc);
	move.l	-$24(a5),-(a7)
	move.l	#L197,-(a7)
	jsr	_printf
	addq.w	#$8,a7
;		return false;
	moveq	#0,d0
	movem.l	(a7)+,d2/a2
	unlk	a5
	rts
L235
;	else if (solid<0 || solid>255) 
	tst.l	-$28(a5)
	bmi.b	L237
L236
	move.l	-$28(a5),d0
	cmp.l	#$FF,d0
	ble.b	L238
L237
;		printf("Illegal solid value %ld\n", solid);
	move.l	-$28(a5),-(a7)
	move.l	#L198,-(a7)
	jsr	_printf
	addq.w	#$8,a7
;		return false;
	moveq	#0,d0
	movem.l	(a7)+,d2/a2
	unlk	a5
	rts
L238
;	else if (trans<0 || trans>255) 
	tst.l	-$2C(a5)
	bmi.b	L240
L239
	move.l	-$2C(a5),d0
	cmp.l	#$FF,d0
	ble.b	L241
L240
;		printf("Illegal transparity %ld\n", trans);
	move.l	-$2C(a5),-(a7)
	move.l	#L199,-(a7)
	jsr	_printf
	addq.w	#$8,a7
;		return false;
	moveq	#0,d0
	movem.l	(a7)+,d2/a2
	unlk	a5
	rts
L241
;	tris[i].iTexture = tex;
	move.l	d2,d1
	muls.l	#$C,d1
	move.l	$28(a2),a0
	move.b	-1(a5),0(a0,d1.l)
;	tris[i].iVertex1 = v1;
	move.l	d2,d1
	muls.l	#$C,d1
	move.l	$28(a2),a0
	move.b	-5(a5),1(a0,d1.l)
;	tris[i].iVertex2 = v2;
	move.l	d2,d1
	muls.l	#$C,d1
	move.l	$28(a2),a0
	move.b	-$9(a5),2(a0,d1.l)
;	tris[i].iVertex3 = v3;
	move.l	d2,d1
	muls.l	#$C,d1
	move.l	$28(a2),a0
	move.b	-$D(a5),3(a0,d1.l)
;	tris[i].iVertexNorm1 = n1;
	move.l	d2,d1
	muls.l	#$C,d1
	move.l	$28(a2),a0
	move.b	-$11(a5),4(a0,d1.l)
;	tris[i].iVertexNorm2 = n2;
	move.l	d2,d1
	muls.l	#$C,d1
	move.l	$28(a2),a0
	move.b	-$15(a5),5(a0,d1.l)
;	tris[i].iVertexNorm3 = n3;
	move.l	d2,d1
	muls.l	#$C,d1
	move.l	$28(a2),a0
	move.b	-$19(a5),6(a0,d1.l)
;	tris[i].iFaceNorm = fn;
	move.l	d2,d1
	muls.l	#$C,d1
	move.l	$28(a2),a0
	move.b	-$1D(a5),7(a0,d1.l)
;	tris[i].iPlaneConst = pc;
	move.l	d2,d1
	muls.l	#$C,d1
	move.l	$28(a2),a0
	move.b	-$21(a5),$8(a0,d1.l)
;	tris[i].solid = solid;
	move.l	d2,d1
	muls.l	#$C,d1
	move.l	$28(a2),a0
	move.b	-$25(a5),$9(a0,d1.l)
;	tris[i].trans = trans;
	move.l	d2,d1
	muls.l	#$C,d1
	move.l	$28(a2),a0
	move.b	-$29(a5),$A(a0,d1.l)
;	tris[i].vis = 0;
	muls.l	#$C,d2
	move.l	$28(a2),a0
	clr.b	$B(a0,d2.l)
;	return true;
	moveq	#1,d0
	movem.l	(a7)+,d2/a2
	unlk	a5
	rts

L191
	dc.b	' { %d, %d, %d, %d, %d, %d, %d, %d, %d, %d, %d }',0
L196
	dc.b	'Illegal face normal index %ld',$A,0
L197
	dc.b	'Illegal plane constant index %ld',$A,0
L198
	dc.b	'Illegal solid value %ld',$A,0
L193
	dc.b	'Illegal texture index %ld',$A,0
L199
	dc.b	'Illegal transparity %ld',$A,0
L194
	dc.b	'Illegal vertex index %ld',$A,0
L195
	dc.b	'Illegal vertex normal index %ld',$A,0
L192
	dc.b	'Malformed triangle definition',0

	SECTION "ReadTextVert__PREFAB_EDIT__TUi:0",CODE


;bool PREFAB_EDIT::ReadTextVert(size_t i)
	XDEF	ReadTextVert__PREFAB_EDIT__TUi
ReadTextVert__PREFAB_EDIT__TUi
	move.l	$8(a7),d0
	move.l	4(a7),a0
L245
;	if (i<0 || i>numVerts)
L246
	cmp.l	4(a0),d0
	bls.b	L248
L247
;		return false;
	moveq	#0,d0
	rts
L248
;	VERTEX *v = &(vertices[i]);
	asl.l	#5,d0
	move.l	$18(a0),a0
	add.l	d0,a0
;	while(file.EndOfFile()==false && endDef==false)
	pea	$18(a0)
	pea	$14(a0)
	pea	$10(a0)
	pea	$8(a0)
	pea	4(a0)
	move.l	a0,-(a7)
	move.l	#L243,-(a7)
	move.l	#_buf__PREFAB_EDIT,a1
	pea	1(a1)
	jsr	_sscanf
	add.w	#$20,a7
	cmp.l	#6,d0
	beq.b	L250
L249
;		puts("Malformed vertex definition");
	move.l	#L244,-(a7)
	jsr	_puts
	addq.w	#4,a7
;		return false;
	moveq	#0,d0
	rts
L250
;	return true;
	moveq	#1,d0
	rts

L243
	dc.b	' { %f, %f, %f, %f, %f, %x }',0
L244
	dc.b	'Malformed vertex definition',0

	SECTION "ReadTextVNorm__PREFAB_EDIT__TUi:0",CODE


;bool PREFAB_EDIT::ReadTextVNorm(size_t i)
	XDEF	ReadTextVNorm__PREFAB_EDIT__TUi
ReadTextVNorm__PREFAB_EDIT__TUi
	move.l	a2,-(a7)
	fmovem.x fp2,-(a7)
	move.l	$18(a7),d0
	move.l	$14(a7),a0
L254
;	if (i<0 || i>numVertNorms)
L255
	cmp.l	$8(a0),d0
	bls.b	L257
L256
;		return false;
	moveq	#0,d0
	fmovem.x (a7)+,fp2
	move.l	(a7)+,a2
	rts
L257
;	VEC3D *v = &(vertNorms[i]);
	muls.l	#$C,d0
	move.l	$1C(a0),a0
	lea	0(a0,d0.l),a2
;	if (sscanf(buf+1, " { %f, %f, %f }", &(v->x), &(v->y), &(v->z))!=3)
	pea	$8(a2)
	pea	4(a2)
	move.l	a2,-(a7)
	move.l	#L251,-(a7)
	move.l	#_buf__PREFAB_EDIT,a1
	pea	1(a1)
	jsr	_sscanf
	add.w	#$14,a7
	cmp.l	#3,d0
	beq.b	L259
L258
;		puts("Malformed normal definition");
	move.l	#L252,-(a7)
	jsr	_puts
	addq.w	#4,a7
;		return false;
	moveq	#0,d0
	fmovem.x (a7)+,fp2
	move.l	(a7)+,a2
	rts
L259
;	float32 len = v->Magnitude();
	move.l	a2,a0
	fmove.s	(a0),fp0
	fmul.s	(a0),fp0
	fmove.s	4(a0),fp1
	fmul.s	4(a0),fp1
	fadd.x	fp1,fp0
	fmove.s	$8(a0),fp1
	fmul.s	$8(a0),fp1
	fadd.x	fp1,fp0
	fmove.d	fp0,-(a7)
	jsr	_sqrt__r
	addq.w	#$8,a7
	fmove.x	fp0,fp2
;	if (FloatCompare(len, 1.0)==false)
	fmove.x	fp2,fp0
	fsub.d	#$.3FF00000.00000000,fp0
	fmove.d	fp0,-(a7)
	jsr	_fabs__r
	addq.w	#$8,a7
	fcmp.d	#$.3F1A36E2.C0000000,fp0
	fbole.b	L261
L260
	moveq	#0,d0
	bra.b	L262
L261
	moveq	#1,d0
L262
	tst.w	d0
	bne.b	L264
L263
;		printf("Normal has erronious magnitude %8.5f, renormalizing\n", 
	fmove.x	fp2,fp0
	fmove.d	fp0,-(a7)
	move.l	#L253,-(a7)
	jsr	_printf
	add.w	#$C,a7
;		(*v) /= len;
	move.l	a2,a0
	fmove.s	#$.3F800000,fp0
	fdiv.x	fp2,fp0
	fmove.s	(a0),fp1
	fmul.x	fp0,fp1
	fmove.s	fp1,(a0)
	fmove.s	4(a0),fp1
	fmul.x	fp0,fp1
	fmove.s	fp1,4(a0)
	fmove.s	$8(a0),fp1
	fmul.x	fp0,fp1
	fmove.s	fp1,$8(a0)
L264
;	return true;
	moveq	#1,d0
	fmovem.x (a7)+,fp2
	move.l	(a7)+,a2
	rts

L251
	dc.b	' { %f, %f, %f }',0
L252
	dc.b	'Malformed normal definition',0
L253
	dc.b	'Normal has erronious magnitude %8.5f, renormalizing',$A,0

	SECTION "ReadTextFNorm__PREFAB_EDIT__TUi:0",CODE


;bool PREFAB_EDIT::ReadTextFNorm(size_t i)
	XDEF	ReadTextFNorm__PREFAB_EDIT__TUi
ReadTextFNorm__PREFAB_EDIT__TUi
	move.l	$8(a7),d0
	move.l	4(a7),a0
L267
;	if (i<0 || i>numFaceNorms)
L268
	cmp.l	$C(a0),d0
	bls.b	L270
L269
;		return false;
	moveq	#0,d0
	rts
L270
;	VEC3D *v = &(vertNorms[i]);
	muls.l	#$C,d0
	move.l	$1C(a0),a0
	add.l	d0,a0
;	if (sscanf(buf+1, " { %f, %f, %f }", &(v->x), &(v->y), &(v->z))!=3)
	pea	$8(a0)
	pea	4(a0)
	move.l	a0,-(a7)
	move.l	#L265,-(a7)
	move.l	#_buf__PREFAB_EDIT,a1
	pea	1(a1)
	jsr	_sscanf
	add.w	#$14,a7
	cmp.l	#3,d0
	beq.b	L272
L271
;		puts("Malformed normal definition");
	move.l	#L266,-(a7)
	jsr	_puts
	addq.w	#4,a7
;		return false;
	moveq	#0,d0
	rts
L272
;	return true;
	moveq	#1,d0
	rts

L265
	dc.b	' { %f, %f, %f }',0
L266
	dc.b	'Malformed normal definition',0

	SECTION "ReadTextPConst__PREFAB_EDIT__TUi:0",CODE


;bool PREFAB_EDIT::ReadTextPConst(size_t i)
	XDEF	ReadTextPConst__PREFAB_EDIT__TUi
ReadTextPConst__PREFAB_EDIT__TUi
	move.l	$8(a7),d0
	move.l	4(a7),a0
L275
;	if (i<0 || i>numPlaneConsts)
L276
	cmp.l	$10(a0),d0
	bls.b	L278
L277
;		return false;
	moveq	#0,d0
	rts
L278
;	float32 *f = &(planeConsts[i]);
	move.l	$24(a0),a0
;	if (sscanf(buf+1, " %f", f)!=1)
	pea	0(a0,d0.l*4)
	move.l	#L273,-(a7)
	move.l	#_buf__PREFAB_EDIT,a1
	pea	1(a1)
	jsr	_sscanf
	add.w	#$C,a7
	cmp.l	#1,d0
	beq.b	L280
L279
;		puts("Malformed plane constant");
	move.l	#L274,-(a7)
	jsr	_puts
	addq.w	#4,a7
;		return false;
	moveq	#0,d0
	rts
L280
;	return true;
	moveq	#1,d0
	rts

L273
	dc.b	' %f',0
L274
	dc.b	'Malformed plane constant',0

	SECTION "ReadText__PREFAB_EDIT__TPCc:0",CODE


;sint32 PREFAB_EDIT::ReadText(const char* fileName)
	XDEF	ReadText__PREFAB_EDIT__TPCc
ReadText__PREFAB_EDIT__TPCc
L340	EQU	-$D0
	link	a5,#L340
	movem.l	d2-d7/a2/a3,-(a7)
	move.l	$C(a5),a1
	move.l	$8(a5),a2
L289
;	if (!fileName)
	cmp.w	#0,a1
	bne.b	L291
L290
;		return ERR_PTR_ZERO;
	move.l	#-$3020002,d0
	movem.l	(a7)+,d2-d7/a2/a3
	unlk	a5
	rts
L291
;	xFILEIO file(fileName, xIOS::READTEXT);
	lea	-$9A(a5),a0
	clr.l	(a0)
	clr.l	$96(a0)
	pea	$400.w
	pea	1.w
	move.l	a1,-(a7)
	move.l	a0,-(a7)
	jsr	Open__xFILEIO__TPCcjj
	add.w	#$10,a7
;	if (file.Valid()==false)
	move.l	-4(a5),d0
	and.l	#$40,d0
	tst.w	d0
	bne.b	L293
L292
	pea	-$9A(a5)
	jsr	Close__xFILEIO__T
	addq.w	#4,a7
	move.l	#-$304000B,d0
	movem.l	(a7)+,d2-d7/a2/a3
	unlk	a5
	rts
L293
;	sint32 nTris = -1;
	move.l	#-1,-$9E(a5)
;	sint32 nVerts = -1;
	move.l	#-1,-$A2(a5)
;	sint32 nVNorms = -1;
	move.l	#-1,-$A6(a5)
;	sint32 nFNorms = -1;
	move.l	#-1,-$AA(a5)
;	sint32 nPConsts = -1;
	move.l	#-1,-$AE(a5)
;	file.ReadText(buf, 255, '\n', 1);
	pea	1.w
	move.b	#$A,-(a7)
	pea	$FF.w
	move.l	#_buf__PREFAB_EDIT,-(a7)
	pea	-$9A(a5)
	jsr	ReadText__xFILEIO__TPcjcj
	add.w	#$12,a7
;	if (sscanf(buf, "PrefabDef %ld, %ld, %ld, %ld, %ld", \
	pea	-$AE(a5)
	pea	-$AA(a5)
	pea	-$A6(a5)
	pea	-$A2(a5)
	pea	-$9E(a5)
	move.l	#L281,-(a7)
	move.l	#_buf__PREFAB_EDIT,-(a7)
	jsr	_sscanf
	add.w	#$1C,a7
	cmp.l	#5,d0
	beq.b	L295
L294
;		puts("PREFAB_EDIT::ReadText() - [error] invalid prefab definitio
	move.l	#L282,-(a7)
	jsr	_puts
	addq.w	#4,a7
	pea	-$9A(a5)
	jsr	Close__xFILEIO__T
	addq.w	#4,a7
	moveq	#-1,d0
	movem.l	(a7)+,d2-d7/a2/a3
	unlk	a5
	rts
L295
;	if (Create(nTris, nVerts, nVNorms, nFNorms, nPConsts)!=OK)
	move.l	-$AE(a5),-(a7)
	move.l	-$AA(a5),-(a7)
	move.l	-$A6(a5),-(a7)
	move.l	-$A2(a5),-(a7)
	move.l	-$9E(a5),-(a7)
	move.l	a2,-(a7)
	jsr	Create__PREFAB_EDIT__TUiUiUiUiUi
	add.w	#$18,a7
	tst.l	d0
	beq.b	L297
L296
	pea	-$9A(a5)
	jsr	Close__xFILEIO__T
	addq.w	#4,a7
	moveq	#-1,d0
	movem.l	(a7)+,d2-d7/a2/a3
	unlk	a5
	rts
L297
;	if (numTris==0) // null prefab
	tst.l	(a2)
	bne.b	L299
L298
	pea	-$9A(a5)
	jsr	Close__xFILEIO__T
	addq.w	#4,a7
	moveq	#0,d0
	movem.l	(a7)+,d2-d7/a2/a3
	unlk	a5
	rts
L299
;	sint32 line					= 1;
	move.l	#1,-$B2(a5)
;	sint32 trisRead			= 0;
	moveq	#0,d6
;	sint32 vertsRead		= 0;
	moveq	#0,d5
;	sint32 vNormsRead		= 0;
	moveq	#0,d4
;	sint32 fNormsRead		= 0;
	moveq	#0,d3
;	sint32 pConstsRead	= 0;
	moveq	#0,d2
;	bool endDef					= false;
	moveq	#0,d7
;	while(file.EndOfFile()==false && endDef==false)
	bra	L337
L300
;		if (file.ReadText(buf, 255, '\n', 1)>0)
	pea	1.w
	move.b	#$A,-(a7)
	pea	$FF.w
	move.l	#_buf__PREFAB_EDIT,-(a7)
	pea	-$9A(a5)
	jsr	ReadText__xFILEIO__TPcjcj
	add.w	#$12,a7
	cmp.l	#0,d0
	ble	L336
L301
;			line++;
	addq.l	#1,-$B2(a5)
;			switch(buf[0])
	move.l	#_buf__PREFAB_EDIT,a0
	move.b	(a0),d0
	cmp.b	#$54,d0
	beq	L302
	bgt.b	L341
	cmp.b	#$3B,d0
	beq	L322
	bgt.b	L342
	cmp.b	#$D,d0
	beq	L322
	bgt.b	L343
	cmp.b	#$A,d0
	beq	L322
	bra	L334
L343
	cmp.b	#$23,d0
	beq	L323
	bra	L334
L342
	cmp.b	#$4E,d0
	beq	L310
	bgt.b	L344
	cmp.b	#$46,d0
	beq	L314
	bra	L334
L344
	cmp.b	#$50,d0
	beq	L318
	bra	L334
L341
	cmp.b	#$70,d0
	beq	L318
	bgt.b	L345
	cmp.b	#$66,d0
	beq	L314
	bgt.b	L346
	cmp.b	#$56,d0
	beq.b	L306
	bra	L334
L346
	cmp.b	#$6E,d0
	beq.b	L310
	bra	L334
L345
	cmp.b	#$74,d0
	beq.b	L302
	cmp.b	#$76,d0
	beq.b	L306
	bra	L334
;				
L302
;					if (trisRead < numTris) 
	move.l	d6,d1
	cmp.l	(a2),d1
	bge.b	L305
L303
;						if (ReadTextTri(trisRead)==true)
	move.l	d6,-(a7)
	move.l	a2,-(a7)
	jsr	ReadTextTri__PREFAB_EDIT__TUi
	addq.w	#$8,a7
	cmp.w	#1,d0
	bne.b	L305
L304
;							trisRead++;
	move.l	d6,d0
	addq.l	#1,d0
	move.l	d0,d6
L305
;					
	bra	L335
L306
;					if (vertsRead < numVerts) 
	cmp.l	4(a2),d5
	bge.b	L309
L307
;						if (ReadTextVert(vertsRead)==true)
	move.l	d5,-(a7)
	move.l	a2,-(a7)
	jsr	ReadTextVert__PREFAB_EDIT__TUi
	addq.w	#$8,a7
	cmp.w	#1,d0
	bne.b	L309
L308
;							vertsRead++;
	addq.l	#1,d5
L309
;					
	bra	L335
L310
;					if (vNormsRead < numVertNorms) 
	cmp.l	$8(a2),d4
	bge.b	L313
L311
;						if (ReadTextVNorm(vNormsRead)==true)
	move.l	d4,-(a7)
	move.l	a2,-(a7)
	jsr	ReadTextVNorm__PREFAB_EDIT__TUi
	addq.w	#$8,a7
	cmp.w	#1,d0
	bne.b	L313
L312
;							vNormsRead++;
	addq.l	#1,d4
L313
;					
	bra	L335
L314
;					if (fNormsRead < numFaceNorms) 
	cmp.l	$C(a2),d3
	bge.b	L317
L315
;						if (ReadTextFNorm(fNormsRead)==true)
	move.l	d3,-(a7)
	move.l	a2,-(a7)
	jsr	ReadTextFNorm__PREFAB_EDIT__TUi
	addq.w	#$8,a7
	cmp.w	#1,d0
	bne.b	L317
L316
;							fNormsRead++;
	addq.l	#1,d3
L317
;					
	bra	L335
L318
;					if (pConstsRead < numPlaneConsts) 
	cmp.l	$10(a2),d2
	bge.b	L321
L319
;						if (ReadTextPConst(pConstsRead)==true)
	move.l	d2,-(a7)
	move.l	a2,-(a7)
	jsr	ReadTextPConst__PREFAB_EDIT__TUi
	addq.w	#$8,a7
	cmp.w	#1,d0
	bne.b	L321
L320
;							pConstsRead++;
	addq.l	#1,d2
L321
;					
	bra	L335
L322
;					
	bra	L335
L323
;					if (trisRead<numTris)
	move.l	d6,d1
	cmp.l	(a2),d1
	bge.b	L325
L324
;						printf("[warning] Read only %d / %d triangles\n", trisRe
	move.l	(a2),-(a7)
	move.l	d6,-(a7)
	move.l	#L283,-(a7)
	jsr	_printf
	add.w	#$C,a7
L325
;					if (vertsRead<numVerts)
	cmp.l	4(a2),d5
	bge.b	L327
L326
;						printf("[warning] Read only %d / %d vertices\n", vertsRe
	move.l	4(a2),-(a7)
	move.l	d5,-(a7)
	move.l	#L284,-(a7)
	jsr	_printf
	add.w	#$C,a7
L327
;					if (vNormsRead<numVertNorms)
	cmp.l	$8(a2),d4
	bge.b	L329
L328
;						printf("[warning] Read only %d / %d vertex normals\n", v
	move.l	$8(a2),-(a7)
	move.l	d4,-(a7)
	move.l	#L285,-(a7)
	jsr	_printf
	add.w	#$C,a7
L329
;					if (fNormsRead<numFaceNorms)
	cmp.l	$C(a2),d3
	bge.b	L331
L330
;						printf("[warning] Read only %d / %d face normals\n", fNo
	move.l	$C(a2),-(a7)
	move.l	d3,-(a7)
	move.l	#L286,-(a7)
	jsr	_printf
	add.w	#$C,a7
L331
;					if (pConstsRead<numPlaneConsts)
	cmp.l	$10(a2),d2
	bge.b	L333
L332
;						printf("[warning] Read only %d / %d plane consts\n", pCo
	move.l	$10(a2),-(a7)
	move.l	d2,-(a7)
	move.l	#L287,-(a7)
	jsr	_printf
	add.w	#$C,a7
L333
;					endDef = true;
	moveq	#1,d7
;					
	bra.b	L335
L334
;					printf("Warning : unknown token '%c' on line %ld\n", buf[0
	move.l	-$B2(a5),-(a7)
	move.l	#_buf__PREFAB_EDIT,a0
	move.b	(a0),d0
	extb.l	d0
	move.l	d0,-(a7)
	move.l	#L288,-(a7)
	jsr	_printf
	add.w	#$C,a7
;					
L335
	bra.b	L337
L336
;			endDef = true;
	moveq	#1,d7
L337
	move.l	-4(a5),d0
	and.l	#$10,d0
	tst.w	d0
	bne.b	L339
L338
	tst.w	d7
	beq	L300
L339
;	file.Close();
	pea	-$9A(a5)
	jsr	Close__xFILEIO__T
	addq.w	#4,a7
	pea	-$9A(a5)
	jsr	Close__xFILEIO__T
	addq.w	#4,a7
	moveq	#0,d0
	movem.l	(a7)+,d2-d7/a2/a3
	unlk	a5
	rts

L282
	dc.b	'PREFAB_EDIT::ReadText() - [error] invalid prefab definition',0
L281
	dc.b	'PrefabDef %ld, %ld, %ld, %ld, %ld',0
L288
	dc.b	'Warning : unknown token '%c' on line %ld',$A,0
L286
	dc.b	'[warning] Read only %d / %d face normals',$A,0
L287
	dc.b	'[warning] Read only %d / %d plane consts',$A,0
L283
	dc.b	'[warning] Read only %d / %d triangles',$A,0
L285
	dc.b	'[warning] Read only %d / %d vertex normals',$A,0
L284
	dc.b	'[warning] Read only %d / %d vertices',$A,0

	SECTION "WriteText__PREFAB_EDIT__TPCc:0",CODE


;sint32 PREFAB_EDIT::WriteText(const char* fileName)
	XDEF	WriteText__PREFAB_EDIT__TPCc
WriteText__PREFAB_EDIT__TPCc
L379	EQU	-$A4
	link	a5,#L379
	movem.l	d2/a2/a3,-(a7)
	move.l	$C(a5),a1
	move.l	$8(a5),a2
L359
;	if (!fileName)
	cmp.w	#0,a1
	bne.b	L361
L360
;		return ERR_PTR_ZERO;
	move.l	#-$3020002,d0
	movem.l	(a7)+,d2/a2/a3
	unlk	a5
	rts
L361
;	xFILEIO file(fileName, xIOS::WRITETEXT);
	lea	-$9A(a5),a0
	clr.l	(a0)
	clr.l	$96(a0)
	pea	$400.w
	pea	2.w
	move.l	a1,-(a7)
	move.l	a0,-(a7)
	jsr	Open__xFILEIO__TPCcjj
	add.w	#$10,a7
;	if (file.Valid()==false)
	move.l	-4(a5),d0
	and.l	#$40,d0
	tst.w	d0
	bne.b	L363
L362
	pea	-$9A(a5)
	jsr	Close__xFILEIO__T
	addq.w	#4,a7
	move.l	#-$304000B,d0
	movem.l	(a7)+,d2/a2/a3
	unlk	a5
	rts
L363
;	file.WriteText("PrefabDef %ld, %ld, %ld, %ld, %ld\n",
	move.l	$10(a2),-(a7)
	move.l	$C(a2),-(a7)
	move.l	$8(a2),-(a7)
	move.l	4(a2),-(a7)
	move.l	(a2),-(a7)
	move.l	#L347,-(a7)
	pea	-$9A(a5)
	jsr	WriteText__xFILEIO__TPce
	add.w	#$1C,a7
;	file.WriteText("\n; Triangles [%d]\n", numTris);
	move.l	(a2),-(a7)
	move.l	#L348,-(a7)
	pea	-$9A(a5)
	jsr	WriteText__xFILEIO__TPce
	add.w	#$C,a7
;	for (i=0;
	moveq	#0,d2
	bra	L365
L364
;		file.WriteText("t { %d, %d, %d, %d, %d, %d, %d, %d, %d, %d, %d }
	move.l	d2,d0
	muls.l	#$C,d0
	move.l	$28(a2),a0
	move.b	$A(a0,d0.l),d0
	and.l	#$FF,d0
	move.l	d0,-(a7)
	move.l	d2,d0
	muls.l	#$C,d0
	move.l	$28(a2),a0
	move.b	$9(a0,d0.l),d0
	and.l	#$FF,d0
	move.l	d0,-(a7)
	move.l	d2,d0
	muls.l	#$C,d0
	move.l	$28(a2),a0
	move.b	$8(a0,d0.l),d0
	and.l	#$FF,d0
	move.l	d0,-(a7)
	move.l	d2,d0
	muls.l	#$C,d0
	move.l	$28(a2),a0
	move.b	7(a0,d0.l),d0
	and.l	#$FF,d0
	move.l	d0,-(a7)
	move.l	d2,d0
	muls.l	#$C,d0
	move.l	$28(a2),a0
	move.b	6(a0,d0.l),d0
	and.l	#$FF,d0
	move.l	d0,-(a7)
	move.l	d2,d0
	muls.l	#$C,d0
	move.l	$28(a2),a0
	move.b	5(a0,d0.l),d0
	and.l	#$FF,d0
	move.l	d0,-(a7)
	move.l	d2,d0
	muls.l	#$C,d0
	move.l	$28(a2),a0
	move.b	4(a0,d0.l),d0
	and.l	#$FF,d0
	move.l	d0,-(a7)
	move.l	d2,d0
	muls.l	#$C,d0
	move.l	$28(a2),a0
	move.b	3(a0,d0.l),d0
	and.l	#$FF,d0
	move.l	d0,-(a7)
	move.l	d2,d0
	muls.l	#$C,d0
	move.l	$28(a2),a0
	move.b	2(a0,d0.l),d0
	and.l	#$FF,d0
	move.l	d0,-(a7)
	move.l	d2,d0
	muls.l	#$C,d0
	move.l	$28(a2),a0
	move.b	1(a0,d0.l),d0
	and.l	#$FF,d0
	move.l	d0,-(a7)
	move.l	d2,d0
	muls.l	#$C,d0
	move.l	$28(a2),a0
	move.b	0(a0,d0.l),d0
	and.l	#$FF,d0
	move.l	d0,-(a7)
	move.l	#L349,-(a7)
	pea	-$9A(a5)
	jsr	WriteText__xFILEIO__TPce
	add.w	#$34,a7
	addq.l	#1,d2
L365
	cmp.l	(a2),d2
	blt	L364
L366
;	file.WriteText("\n; Vertices [%d]\n", numVerts);
	move.l	4(a2),-(a7)
	move.l	#L350,-(a7)
	pea	-$9A(a5)
	jsr	WriteText__xFILEIO__TPce
	add.w	#$C,a7
;	for (i=0;
	moveq	#0,d2
	bra	L368
L367
;		file.WriteText("v { %10.6f, %10.6f, %10.6f, %10.6f, %10.6f, 0x%0
	move.l	d2,d0
	asl.l	#5,d0
	move.l	$18(a2),a0
	lea	0(a0,d0.l),a0
	move.l	$18(a0),-(a7)
	move.l	d2,d0
	asl.l	#5,d0
	move.l	$18(a2),a0
	fmove.s	$14(a0,d0.l),fp0
	fmove.d	fp0,-(a7)
	move.l	d2,d0
	asl.l	#5,d0
	move.l	$18(a2),a0
	fmove.s	$10(a0,d0.l),fp0
	fmove.d	fp0,-(a7)
	move.l	d2,d0
	asl.l	#5,d0
	move.l	$18(a2),a0
	fmove.s	$8(a0,d0.l),fp0
	fmove.d	fp0,-(a7)
	move.l	d2,d0
	asl.l	#5,d0
	move.l	$18(a2),a0
	fmove.s	4(a0,d0.l),fp0
	fmove.d	fp0,-(a7)
	move.l	d2,d0
	asl.l	#5,d0
	move.l	$18(a2),a0
	fmove.s	0(a0,d0.l),fp0
	fmove.d	fp0,-(a7)
	move.l	#L351,-(a7)
	pea	-$9A(a5)
	jsr	WriteText__xFILEIO__TPce
	add.w	#$34,a7
	addq.l	#1,d2
L368
	cmp.l	4(a2),d2
	blt	L367
L369
;	file.WriteText("\n; Vertex Normals [%d]\n", numVertNorms);
	move.l	$8(a2),-(a7)
	move.l	#L352,-(a7)
	pea	-$9A(a5)
	jsr	WriteText__xFILEIO__TPce
	add.w	#$C,a7
;	for (i=0;
	moveq	#0,d2
	bra.b	L371
L370
;		file.WriteText("n { %8.6f, %8.6f, %8.6f }\n",
	move.l	d2,d0
	muls.l	#$C,d0
	move.l	$1C(a2),a0
	fmove.s	$8(a0,d0.l),fp0
	fmove.d	fp0,-(a7)
	move.l	d2,d0
	muls.l	#$C,d0
	move.l	$1C(a2),a0
	fmove.s	4(a0,d0.l),fp0
	fmove.d	fp0,-(a7)
	move.l	d2,d0
	muls.l	#$C,d0
	move.l	$1C(a2),a0
	fmove.s	0(a0,d0.l),fp0
	fmove.d	fp0,-(a7)
	move.l	#L353,-(a7)
	pea	-$9A(a5)
	jsr	WriteText__xFILEIO__TPce
	add.w	#$20,a7
	addq.l	#1,d2
L371
	cmp.l	$8(a2),d2
	blt.b	L370
L372
;	file.WriteText("\n; Face Normals [%d]\n", numFaceNorms);
	move.l	$C(a2),-(a7)
	move.l	#L354,-(a7)
	pea	-$9A(a5)
	jsr	WriteText__xFILEIO__TPce
	add.w	#$C,a7
;	for (i=0;
	moveq	#0,d2
	bra.b	L374
L373
;		file.WriteText("f { %8.6f, %8.6f, %8.6f }\n",
	move.l	d2,d0
	muls.l	#$C,d0
	move.l	$20(a2),a0
	fmove.s	$8(a0,d0.l),fp0
	fmove.d	fp0,-(a7)
	move.l	d2,d0
	muls.l	#$C,d0
	move.l	$20(a2),a0
	fmove.s	4(a0,d0.l),fp0
	fmove.d	fp0,-(a7)
	move.l	d2,d0
	muls.l	#$C,d0
	move.l	$20(a2),a0
	fmove.s	0(a0,d0.l),fp0
	fmove.d	fp0,-(a7)
	move.l	#L355,-(a7)
	pea	-$9A(a5)
	jsr	WriteText__xFILEIO__TPce
	add.w	#$20,a7
	addq.l	#1,d2
L374
	cmp.l	$C(a2),d2
	blt.b	L373
L375
;	file.WriteText("\n; Plane Constants [%d]\n", numPlaneConsts);
	move.l	$10(a2),-(a7)
	move.l	#L356,-(a7)
	pea	-$9A(a5)
	jsr	WriteText__xFILEIO__TPce
	add.w	#$C,a7
;	for (i=0;
	moveq	#0,d2
	bra.b	L377
L376
;		file.WriteText("p %10.6f\n", planeConsts[i]);
	move.l	$24(a2),a0
	fmove.s	0(a0,d2.l*4),fp0
	fmove.d	fp0,-(a7)
	move.l	#L357,-(a7)
	pea	-$9A(a5)
	jsr	WriteText__xFILEIO__TPce
	add.w	#$10,a7
	addq.l	#1,d2
L377
	cmp.l	$10(a2),d2
	blt.b	L376
L378
;	file.WriteText("\n#\n; end of prefab definition\n");
	move.l	#L358,-(a7)
	pea	-$9A(a5)
	jsr	WriteText__xFILEIO__TPce
	addq.w	#$8,a7
;	file.Close();
	pea	-$9A(a5)
	jsr	Close__xFILEIO__T
	addq.w	#4,a7
	pea	-$9A(a5)
	jsr	Close__xFILEIO__T
	addq.w	#4,a7
	moveq	#0,d0
	movem.l	(a7)+,d2/a2/a3
	unlk	a5
	rts

L358
	dc.b	$A,'#',$A,'; end of prefab definition',$A,0
L354
	dc.b	$A,'; Face Normals [%d]',$A,0
L356
	dc.b	$A,'; Plane Constants [%d]',$A,0
L348
	dc.b	$A,'; Triangles [%d]',$A,0
L352
	dc.b	$A,'; Vertex Normals [%d]',$A,0
L350
	dc.b	$A,'; Vertices [%d]',$A,0
L347
	dc.b	'PrefabDef %ld, %ld, %ld, %ld, %ld',$A,0
L355
	dc.b	'f { %8.6f, %8.6f, %8.6f }',$A,0
L353
	dc.b	'n { %8.6f, %8.6f, %8.6f }',$A,0
L357
	dc.b	'p %10.6f',$A,0
L349
	dc.b	't { %d, %d, %d, %d, %d, %d, %d, %d, %d, %d, %d }',$A,0
L351
	dc.b	'v { %10.6f, %10.6f, %10.6f, %10.6f, %10.6f, 0x%08x }',$A,0

	SECTION "CompareTris__PCvPCv:0",CODE


;int CompareTris(const void* a, const void* b)
	XDEF	CompareTris__PCvPCv
CompareTris__PCvPCv
	move.l	$8(a7),a0
	move.l	4(a7),a1
L380
;	PREFAB_BASE::TRIDEF* t1 = (PREFAB_BASE::TRIDEF*)
;	PREFAB_BASE::TRIDEF* t2 = (PREFAB_BASE::TRIDEF*)
;	if (t1->trans == t2->trans)
	move.b	$A(a1),d1
	cmp.b	$A(a0),d1
	bne.b	L382
L381
;		return ((int)(t1->iTexture)) - ((int)(t2->iTexture));
	moveq	#0,d0
	move.b	(a1),d0
	moveq	#0,d1
	move.b	(a0),d1
	sub.l	d1,d0
	rts
L382
;		return ((int)(t1->trans)) - ((int)(t2->trans));
	moveq	#0,d0
	move.b	$A(a1),d0
	moveq	#0,d1
	move.b	$A(a0),d1
	sub.l	d1,d0
	rts

	SECTION "SortTriangles__PREFAB_EDIT__T:0",CODE


;sint32 PREFAB_EDIT::SortTriangles()
	XDEF	SortTriangles__PREFAB_EDIT__T
SortTriangles__PREFAB_EDIT__T
	move.l	4(a7),a0
L383
;	if (!tris || numTris<2)
	tst.l	$28(a0)
	beq.b	L385
L384
	move.l	(a0),d0
	cmp.l	#2,d0
	bhs.b	L386
L385
;		return ERR_PTR_ZERO;
	move.l	#-$3020002,d0
	rts
L386
;	qsort(tris, numTris, sizeof(PREFAB_BASE::TRIDEF), CompareTris);
	move.l	#CompareTris__PCvPCv,-(a7)
	pea	$C.w
	move.l	(a0),-(a7)
	move.l	$28(a0),-(a7)
	jsr	_qsort
	add.w	#$10,a7
;	return OK;
	moveq	#0,d0
	rts

	END
